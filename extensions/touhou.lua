module("extensions.touhou", package.seeall)
extension=sgs.Package("touhou")

--kaze001=sgs.General(extension, "kaze001$", "shu", 3) --东风谷早苗
kaze002=sgs.General(extension, "kaze002", "shu") --射命丸文
kaze003=sgs.General(extension, "kaze003", "shu", 3) --姬海棠羽立
kaze004=sgs.General(extension, "kaze004", "shu") --犬走椛
kaze005=sgs.General(extension, "kaze005", "shu", 3, false) --键山雏
--kaze006--河城荷取
kaze007=sgs.General(extension, "kaze007", "shu") --星熊勇仪
kaze008=sgs.General(extension, "kaze008", "shu") --八坂神奈子
kaze009=sgs.General(extension, "kaze009", "shu", 3, false)--洩矢诹访子
kaze010=sgs.General(extension, "kaze010", "shu", 3) --琪斯美
kaze011=sgs.General(extension, "kaze011", "shu") --黑谷山女
kaze012=sgs.General(extension, "kaze012", "shu") --水桥帕露西
--kaze013=sgs.General(extension, "kaze013", "shu", 3) --秋穰子
--kaze014--秋静叶
kaze015=sgs.General(extension, "kaze015", "shu") --火焰猫燐
--kaze016=sgs.General(extension, "kaze016", "shu", 5) --灵乌路空
kaze017=sgs.General(extension, "kaze017", "shu", 3, false) --古明地恋
--kaze018=sgs.General(extension, "kaze018$", "shu", 3) --古明地觉
--hana001=sgs.General(extension, "hana001$", "wei") --风见幽香
--hana002
hana003=sgs.General(extension, "hana003", "wei", 3, false) --小野塚小町
--hana004=sgs.General(extension, "hana004", "wei", 3) --梅蒂欣•梅兰可莉
--hana005=sgs.General(extension, "hana005", "wei") --永江衣玖
hana006=sgs.General(extension, "hana006", "wei") --二岩猯藏
hana007=sgs.General(extension, "hana007", "wei", 3, false) --封兽鵺
hana008=sgs.General(extension, "hana008", "wei", 3) --茨木华扇
--hana009
--hana010=sgs.General(extension, "hana010", "wei") --莉格露•奈特巴格
hana011=sgs.General(extension, "hana011", "wei", 3) --莉莉•白
--hana012=sgs.General(extension, "hana012", "wei") --多多良小伞
hana013=sgs.General(extension, "hana013", "wei") --宫古芳香
--hana014=sgs.General(extension, "hana014", "wei", 4, false) --霍青娥
--hana015=sgs.General(extension, "hana015", "wei") --苏我屠自古
hana016=sgs.General(extension, "hana016", "wei", 3) --物部布都
hana017=sgs.General(extension, "hana017", "wei", 7) --丰聪耳神子
hana018=sgs.General(extension, "hana018$", "wei") --比那名居天子
yuki001=sgs.General(extension, "yuki001$", "wu") --博丽灵梦
yuki002=sgs.General(extension, "yuki002", "wu") --伊吹萃香
yuki003=sgs.General(extension, "yuki003", "wu") --魂魄妖梦
yuki004=sgs.General(extension, "yuki004", "wu") --爱丽丝•玛嘉特罗伊德
yuki005=sgs.General(extension, "yuki005", "wu", 3, false) --稗田阿求
--yuki006=sgs.General(extension, "yuki006", "wu") --橙
--yuki007=sgs.General(extension, "yuki007", "wu", 3) --八云蓝
yuki008=sgs.General(extension, "yuki008", "wu", 3) --圣白莲
--yuki009
--yuki010=sgs.General(extension, "yuki010", "wu") --琪露诺
--yuki011=sgs.General(extension, "yuki011", "wu", 3) --蕾蒂•怀特萝克
--yuki012=sgs.General(extension, "yuki012", "wu", 3) --幽谷响子
--yuki013=sgs.General(extension, "yuki013", "wu", 3) --普莉兹姆利巴三姐妹
--yuki014=sgs.General(extension, "yuki014", "wu") --娜兹玲
--yuki015=sgs.General(extension, "yuki015", "wu") --寅丸星
--yuki016
yuki017=sgs.General(extension, "yuki017", "wu") --村纱水蜜
yuki018=sgs.General(extension, "yuki018$", "wu", 3, false) --西行寺幽幽子
tsuki001=sgs.General(extension, "tsuki001$", "qun") --蕾米莉亚•斯卡雷特
--tsuki002=sgs.General(extension, "tsuki002", "qun") --芙兰朵露•斯卡雷特
tsuki003=sgs.General(extension, "tsuki003", "qun") --铃仙•优昙华院•稻叶
tsuki004=sgs.General(extension, "tsuki004", "qun", 3, false) --因幡帝
--tsuki005=sgs.General(extension, "tsuki005", "qun", 3) --上白泽慧音
--tsuki006=sgs.General(extension, "tsuki006", "qun", 3) --藤原妹红
tsuki007=sgs.General(extension, "tsuki007", "qun") --红美铃
tsuki008=sgs.General(extension, "tsuki008", "qun", 3) --十六夜咲夜
tsuki011=sgs.General(extension, "tsuki011", "qun", 3) --米斯蒂亚•萝蕾莱
tsuki012=sgs.General(extension, "tsuki012", "qun") --桑妮•米尔克
--tsuki013=sgs.General(extension, "tsuki013", "qun", 3) --露娜•琪尔德
tsuki014=sgs.General(extension, "tsuki014", "qun", 3) --斯塔•莎菲雅
--tsuki015=sgs.General(extension, "tsuki015", "qun", 3, false) --帕秋莉•诺蕾姬
tsuki016=sgs.General(extension, "tsuki016", "qun") --绵月依姬
tsuki017=sgs.General(extension, "tsuki017", "qun") --绵月丰姬
--tsuki018=sgs.General(extension, "tsuki018$", "qun", 3) --蓬莱山辉夜
kami002=sgs.General(extension, "kami002", "god") --比那名居天子
kami004=sgs.General(extension, "kami004", "god", 3) --蕾米莉亚•斯卡雷特
kami009=sgs.General(extension, "kami009", "god") --古明地觉
kami013=sgs.General(extension, "kami013", "god", 1, false) --洩矢诹访子
sp002=sgs.General(extension, "sp002", "wei", 4, false) --霍青娥
bangai001=sgs.General(extension, "bangai001", "qun", 3, false) --小恶魔
bangai002=sgs.General(extension, "bangai002", "wu") --大妖精
bangai004=sgs.General(extension, "bangai004", "shu") --宇佐见莲子
--bangai011=sgs.General(extension, "bangai011", "wei") --濑织津姬

dofile "lua/sgs_ex.lua"

----kaze001
--[奇迹] 弃牌阶段结束时，若你在此阶段弃置了两张或更多的手牌，你可以回复1点体力。
thqiji=sgs.CreateTriggerSkill{
	name="thqiji",
	frequency=sgs.Skill_Frequent,
	events={sgs.CardDiscarded},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:getPhase() ~= sgs.Player_Discard then return false end  
        local card=data:toCard()
        if (card:subcardsLength() < 2) then return false end
        if not room:askForSkillInvoke(player,self:objectName()) then return false end
		local recover=sgs.RecoverStruct()
			recover.recover=1
			recover.card=nil 
			recover.who=player
		room:recover(player, recover)
	end,
}	

--[祭仪] 出牌阶段，你可以指定一名有手牌的其他角色，该角色需展示一张手牌，若该牌为锦囊牌，你须选择一项：交给其一张锦囊牌或让其摸一张牌；若不为锦囊牌，你获得此牌，每阶段限一次。 
thjiyicard=sgs.CreateSkillCard{
	name="thjiyicard",
	target_fixed=false,
	filter=function(self, targets, to_select, player)
		return not to_select:isKongcheng() and to_select:getSeat()~=player:getSeat() and #targets==0
	end,
	
	on_use=function(self, room, source, targets)
		local card=room:askForCardShow(targets[1],source,"@thjiyi")
		room:showCard(targets[1],card:getId())
	end,
}

thjiyi=sgs.CreateViewAsSkill{
	name="thjiyi",
	n=0,

	view_as=function(self, cards)
		local JYcard=thjiyicard:clone()
			JYcard:setSkillName(self:objectName())
		return JYcard
	end,

	enabled_at_play=function(self, player)
		return not player:hasUsed("#thjiyicard")
	end,
}

----kaze002
--[疾岚] 摸牌阶段，你可以放弃摸牌，改为进行一次判定，你获得此判定牌以及场上的一张与此判定牌花色不同的牌。 
thjilanwen=sgs.CreateTriggerSkill{
	name="thjilanwen",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseStart},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:getPhase()~=sgs.Player_Draw then return end
		local invoke=false
		for _,p in sgs.qlist(room:getAllPlayers()) do
			if not p:getCards("ej"):isEmpty() then
				invoke=true
				break
			end
		end
		if not invoke then return end
		if not player:askForSkillInvoke(self:objectName()) then return end
		room:broadcastSkillInvoke(self:objectName())
		local judge=sgs.JudgeStruct()
			judge.pattern=sgs.QRegExp("(.*):(.*):(.*)")
			judge.good=true
			judge.reason=self:objectName()
			judge.who=player
		room:judge(judge)
		player:obtainCard(judge.card)
		local suit=judge.card:getSuit()
		local targets=sgs.SPlayerList()
		for _,p in sgs.qlist(room:getAllPlayers()) do
			for _,card in sgs.qlist(p:getCards("ej")) do
				if card:getSuit()~=suit then
					targets:append(p)
					break
				end
			end
		end
		local target=room:askForPlayerChosen(player,targets,self:objectName())
		local card_ids=sgs.IntList()
		for _,card in sgs.qlist(target:getCards("ej")) do
			if card:getSuit()~=suit then 
				card_ids:append(card:getEffectiveId())
			end
		end
		room:fillAG(card_ids,player)
		card_id=room:askForAG(player, card_ids, false, self:objectName())
		player:invoke("clearAG")
		room:obtainCard(player,card_id)
		return true
	end,
}

----kaze003
--[念写] 出牌阶段，你可以交给一名其他角色一张【闪】，然后展示其一张手牌，若为【闪】，则你与该角色各摸一张牌。每阶段限一次。
thnianxiecard=sgs.CreateSkillCard{
	name="thnianxiecard",
	will_throw=false,
	filter=function(self, targets, to_select, player)
		return #targets==0 and to_select:objectName() ~= player:objectName()
	end,
	on_use=function(self, room, source, targets)
		targets[1]:obtainCard(self)
    	local card_id=room:askForCardChosen(source, targets[1], "h", "thnianxie")
    	room:showCard(targets[1],card_id)
    	if(sgs.Sanguosha:getCard(card_id):isKindOf("Jink"))then
        	source:drawCards(1)
        	targets[1]:drawCards(1)
		end
	end,
}

thnianxie=sgs.CreateViewAsSkill{
	name="thnianxie",
	n=1,
	view_filter=function(self, selected, to_select)
		return to_select:isKindOf("Jink")
	end,

	view_as=function(self, cards)
		if #cards~=1 then return nil end		
		local NXcard=thnianxiecard:clone()			
			NXcard:addSubcard(cards[1])
			NXcard:setSkillName(self:objectName())
		return NXcard	
	end,

	enabled_at_play=function(self, player)
		return not player:hasUsed("#thnianxiecard")
	end,
}

--[极岚] 每当你受到1点伤害后，可令一名角色弃置X张牌（X为该角色已损失的体力值，且至少为1）。
thjilan=sgs.CreateTriggerSkill{
	name="thjilan",
	frequency =sgs.Skill_NotFrequent,
	events={sgs.Damaged},
	
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local damage=data:toDamage()
		local targets,target,x
		for i=1,damage.damage,1 do
			if not room:askForSkillInvoke(player,self:objectName(),data) then break end
			targets=sgs.SPlayerList()
			for _,p in sgs.qlist(room:getAlivePlayers())do
            	if(not p:isNude()) then
            	targets:append(p)
				end
			end
			if targets:isEmpty() then break end
			target=room:askForPlayerChosen(player, targets, "thjilan")
			if not target:isWounded() then
				x=1
			else
				x=target:getLostHp()
			end
			if x>target:getCardCount(true) then
				x=target:getCardCount(true)
			end
			room:askForDiscard(target,"thjilan",x,x,false,true)
        end
	end,
}

----kaze004
--[王手] 每当你对其他角色造成一次伤害后，你可令其进行一次判定，若结果为黑色，你可以弃置其一张牌。
thwangshou=sgs.CreateTriggerSkill{
	name="thwangshou",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.Damage},
	on_trigger=function(self,event,player,data)
		if not player:askForSkillInvoke(self:objectName()) then return end
		local damage=data:toDamage()
		local room=player:getRoom()
		room:broadcastSkillInvoke(self:objectName())
		local judge=sgs.JudgeStruct()
			judge.pattern=sgs.QRegExp("(.*):(spade|club):(.*)")
			judge.good=false
			judge.reason=self:objectName()
			judge.who=damage.to
		room:judge(judge)
		if judge:isBad() then
			local card_id=room:askForCardChosen(player,damage.to,"he",self:objectName())
			local reason=sgs.CardMoveReason()
			reason.m_reason   = sgs.CardMoveReason_S_REASON_DISMANTLE
			reason.m_playerId = player:objectName()
    		reason.m_targetId = damage.to:objectName()
			room:moveCardTo(sgs.Sanguosha:getCard(card_id), nil, nil, sgs.Player_DiscardPile, reason)
		end
	end,
}

--[红叶] 在你的回合外，当其他角色的判定牌若为红色且生效后，你可对其使用一张【杀】。
thhongye=sgs.CreateTriggerSkill{
	name="thhongye",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.FinishJudge},	
	on_trigger=function(self,event,player,data)
		local judge=data:toJudge()
		if not judge.card:isRed() then return end
		if player:isDead() then return end
		local room=player:getRoom()
		local splayer=room:findPlayerBySkillName(self:objectName())
		if not splayer then return end
		if splayer:isKongcheng() then return end
		if splayer:getPhase()~=sgs.Player_NotActive then return end
		if not splayer:askForSkillInvoke(self:objectName()) then return end
		room:broadcastSkillInvoke(self:objectName())
		room:askForUseSlashTo(splayer,player,"@thhongye")
	end,
	can_trigger=function(self,target)
		return true
	end,
}

----kaze005
--[厄难] 出牌阶段，你可以减少1点体力上限，然后令你攻击范围内的一名角色失去1点体力，每阶段限一次。
thenancard=sgs.CreateSkillCard{
	name="thenancard",
	target_fixed=false,
	will_throw=true,
	filter = function(self, targets, to_select, player)
		return player:canSlash(to_select)
	end,
	on_use = function(self, room, source, targets)
		room:loseMaxHp(source)
		room:loseHp(targets[1])
	end,
}

thenan=sgs.CreateViewAsSkill{
	name="thenan",
	n=0,
	view_as = function(self, cards)
		local card=thenancard:clone()
		card:setSkillName(self:objectName())
		return card
	end,
	enabled_at_play=function(self, player)
		return not player:hasUsed("#thenancard")
	end,
}

--[悲运] 当你处于濒死状态时，你可以亮出牌堆顶的X张牌（X为你的体力上限且最多为4），并选择一至两项：1.其中若有方片花色的牌，将所有红色牌置入弃牌堆，并回复1点体力。2.将所有黑色牌置入弃牌堆并增加1点体力上限。然后你可以获得其余的牌。
thbeiyun=sgs.CreateTriggerSkill{
	name="thbeiyun",
	frequency=sgs.Skill_Frequent,
	events={sgs.AskForPeaches},	
	on_trigger=function(self,event,player,data)
		local dying=data:toDying()
		if dying.who:objectName()~=player:objectName() then return end
		if not player:askForSkillInvoke(self:objectName()) then return end
		local room=player:getRoom()
		local card_ids=room:getNCards(math.min(4,player:getMaxHp()))
		local choices,card,maxtimes
		local reason=sgs.CardMoveReason()
		reason.m_reason=sgs.CardMoveReason_S_REASON_NATURAL_ENTER
		while not card_ids:isEmpty() do
			choices={"cancel"}
			for _,id in sgs.qlist(card_ids) do
				card=sgs.Sanguosha:getCard(id)
				if card:getSuit()==sgs.Card_Diamond then
					table.insert(choices, "thbeiyun1")
					break
				end
			end
			for _,id in sgs.qlist(card_ids) do
				card=sgs.Sanguosha:getCard(id)
				if card:isBlack() then
					table.insert(choices, "thbeiyun2")
					break
				end
			end
			room:fillAG(card_ids,nil)
			local choice=room:askForChoice(player, self:objectName(), table.concat(choices, "+"))
			if choice=="thbeiyun1" then
				maxtimes=card_ids:length()
				for x=1,maxtimes,1 do
					for _,id in sgs.qlist(card_ids) do
						card=sgs.Sanguosha:getCard(id)
						if card:isRed() then
							room:moveCardTo(card,nil,sgs.Player_DiscardPile,reason,true)
							card_ids:removeOne(id)
							break
						end
					end
				end
				local recover = sgs.RecoverStruct()
					recover.who = player
				room:recover(player, recover)
				for _,p in sgs.qlist(room:getPlayers()) do
					p:invoke("clearAG")
				end
			elseif choice=="thbeiyun2" then
				maxtimes=card_ids:length()
				for x=1,maxtimes,1 do
					for _,id in sgs.qlist(card_ids) do
						card=sgs.Sanguosha:getCard(id)
						if card:isBlack() then
							room:moveCardTo(card,nil,sgs.Player_DiscardPile,reason,true)
							card_ids:removeOne(id)
							break
						end
					end
				end
				room:setPlayerProperty(player, "maxhp", sgs.QVariant(player:getMaxHp()+1))
				for _,p in sgs.qlist(room:getPlayers()) do
					p:invoke("clearAG")
				end
			else
				if room:askForChoice(player, self:objectName(), "beiyunget+beiyundis")=="beiyunget" then
					maxtimes=card_ids:length()
					for x=1,maxtimes,1 do
						id=card_ids:first()
						card=sgs.Sanguosha:getCard(id)
						player:obtainCard(card)
						card_ids:removeOne(id)
					end
				else
					maxtimes=card_ids:length()
					for x=1,maxtimes,1 do
						id=card_ids:first()
						card=sgs.Sanguosha:getCard(id)
						room:moveCardTo(card,nil,sgs.Player_DiscardPile,reason,true)
						card_ids:removeOne(id)
					end
				end
			end
		end
		for _,p in sgs.qlist(room:getPlayers()) do
			p:invoke("clearAG")
		end
	end,
}

----kaze007
--[必杀] 出牌阶段，你可将一张黑色非锦囊牌当【兵粮寸断】或方片牌当【乐不思蜀】置于你的判定区内，然后摸一张牌并选择一名其他角色。若如此做，视为你对其使用一张【杀】（此【杀】无视其防具且不计入每阶段的使用限制），并且无视与该角色的距离直到回合结束。每阶段限一次。
thbishacard=sgs.CreateSkillCard{
	name="thbishacard",
	target_fixed=true,
	will_throw=false,
	on_use = function(self, room, source, targets)
		local card=sgs.Sanguosha:getCard(self:getEffectiveId())
		local cardname
		if card:isRed() then
			cardname="indulgence"
		else
			cardname="supply_shortage"
		end
		local newcard=sgs.Sanguosha:cloneCard(cardname,card:getSuit(),card:getNumber())
		newcard:addSubcard(card)
		newcard:setSkillName("thbishacard")
		local use=sgs.CardUseStruct()
        	use.card=newcard
        	use.from=source
        	use.to:append(source)
		room:useCard(use, true)
		source:drawCards(1)
		local targets=sgs.SPlayerList()
		for _,p in sgs.qlist(room:getOtherPlayers(source)) do
			if source:canSlash(p,false) and not (p:isKongcheng() and p:hasSkill("kongcheng")) then
				targets:append(p)
			end
		end
		local target=room:askForPlayerChosen(source,targets,"thbisha")
		source:setFixedDistance(target,1)
		room:setPlayerFlag(target,"bishatarget")
		local slash=sgs.Sanguosha:cloneCard("slash",sgs.Card_NoSuit,0)
		slash:setSkillName("thbisha")
		local use2=sgs.CardUseStruct()
        	use2.card=slash
        	use2.from=source
        	use2.to:append(target)
		target:addMark("qinggang")
		room:useCard(use2, false)
		target:removeMark("qinggang")
	end,
}

thbishavs=sgs.CreateViewAsSkill{
	name="thbishavs",
	n=1,
	view_filter = function(self, selected, to_select)
		if sgs.Self:containsTrick("indulgence") then
			return to_select:isBlack() and not to_select:isKindOf("TrickCard")
		elseif sgs.Self:containsTrick("supply_shortage") then
			return to_select:getSuit()==sgs.Card_Diamond
		else
			return (to_select:isBlack() and not to_select:isKindOf("TrickCard"))or(to_select:getSuit()==sgs.Card_Diamond)
		end
	end,
	view_as = function(self, cards)
		if #cards~=1 then return end
		local card=thbishacard:clone()
		card:addSubcard(cards[1])
		return card
	end,
	enabled_at_play=function(self, player)
		return not(player:containsTrick("indulgence") and player:containsTrick("supply_shortage")) and not player:hasUsed("#thbishacard")
	end,
}

thbisha=sgs.CreateTriggerSkill{
	name="thbisha",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseChanging},
	priority = 1,
	view_as_skill=thbishavs,
	on_trigger=function(self,event,player,data)
		local change=data:toPhaseChange()
		if change.to~=sgs.Player_NotActive then return end
		local room=player:getRoom()
		for _,p in sgs.qlist(room:getOtherPlayers(player)) do
			if p:hasFlag("bishatarget") then
				player:setFixedDistance(p,-1)
				room:setPlayerFlag(p,"-bishatarget")
			end
		end
	end,
}

----kaze008
--[神粥] 每当你受到一次伤害后，可从牌堆顶亮出X张牌（X为存活角色的数量，且最多为5），将一种类别的牌交给一名角色，然后将其余的牌置入弃牌堆。
thshenzhou=sgs.CreateTriggerSkill{
	name="thshenzhou",
	frequency=sgs.Skill_Frequent,
	events={sgs.Damaged},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if not player:askForSkillInvoke(self:objectName()) then return end
		local x=room:alivePlayerCount()
		if x>5 then 
			x=5
		end
		local card_ids=room:getNCards(x)
		room:fillAG(card_ids,nil)
		local card_id=room:askForAG(player, card_ids, false, self:objectName())
		local acard_ids=sgs.IntList()
		local reason=sgs.CardMoveReason()
		reason.m_reason=sgs.CardMoveReason_S_REASON_NATURAL_ENTER
		local ctype=sgs.Sanguosha:getCard(card_id):getType()
		for _,id in sgs.qlist(card_ids) do
			if (sgs.Sanguosha:getCard(id)):getType()==ctype then
				acard_ids:append(id)
			else	
				room:moveCardTo(sgs.Sanguosha:getCard(id),nil,sgs.Player_DiscardPile,reason,true)
			end
		end
		for _,p in sgs.qlist(room:getPlayers()) do
			p:invoke("clearAG")
		end
		local target=room:askForPlayerChosen(player,room:getAllPlayers(),self:objectName())
		local log= sgs.LogMessage()
			log.type = "#thshenzhou"
			log.from = player
			log.to:append(target)
			log.arg = tonumber(acard_ids:length())
			log.arg2 = ctype
		room:sendLog(log)
		for _,id in sgs.qlist(acard_ids) do
			target:obtainCard(sgs.Sanguosha:getCard(id))
		end
	end,
}

--[天流] 锁定技，摸牌阶段，你须放弃摸牌，改为进行一次判定，若结果为红桃，你摸三张牌；若结果为方片，你摸两张牌；若结果为草花，你摸一张牌。
thtianliu=sgs.CreateTriggerSkill{
	name="thtianliu",
	frequency=sgs.Skill_Compulsory,
	events={sgs.EventPhaseStart},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:getPhase()~=sgs.Player_Draw then return end
		local log= sgs.LogMessage()
			log.type = "#TriggerSkill"
			log.from = player
			log.arg  = self:objectName()
		room:sendLog(log)
		local judge=sgs.JudgeStruct()
			judge.pattern=sgs.QRegExp("(.*):(spade|club):(.*)")
			judge.good=false
			judge.reason=self:objectName()
			judge.who=player
		room:judge(judge)
		if judge:isGood() then
			room:setEmotion(player,"good")
		else
			room:setEmotion(player,"bad")
		end
		if judge.card:getSuit()==sgs.Card_Heart then
			player:drawCards(3)
		elseif judge.card:getSuit()==sgs.Card_Diamond then
			player:drawCards(2)
		elseif judge.card:getSuit()==sgs.Card_Club then
			player:drawCards(1)
		end
		return true
	end,
}

--[乾仪] 你的回合外，每当你使用或打出一张【闪】时，可观看一名其他角色的手牌，将其中一张锦囊牌交给另一名角色。
thqianyi=sgs.CreateTriggerSkill{
	name="thqianyi",
	frequency=sgs.Skill_Frequent,
	events={sgs.CardUsed,sgs.CardResponsed},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:getPhase()~=sgs.Player_NotActive then return end
		local card
		if event==sgs.CardUsed then
			card=data:toCardUse().card
		else
			card=data:toCard()
		end
		if not card:isKindOf("Jink") then return false end
		if not player:askForSkillInvoke(self:objectName()) then return end
		local target=room:askForPlayerChosen(player,room:getOtherPlayers(player),self:objectName())
		local log= sgs.LogMessage()
			log.type = "#thqianyi"
			log.from = player
			log.to:append(target)
		room:sendLog(log)
		local card_ids=target:handCards()
		room:fillAG(card_ids,player)
		local card_id 
		local sucess=false
		local newcard
		while not sucess do
            card_id=room:askForAG(player, card_ids, true, self:objectName())
            if card_id == -1 then
                sucess=true
            else
                newcard=sgs.Sanguosha:getCard(card_id)
                if newcard:getType() == "trick" then 
					sucess=true 
				end
            end
        end
		player:invoke("clearAG")
		if card_id == -1 then return end
		target=room:askForPlayerChosen(player,room:getOtherPlayers(target),self:objectName())
		target:obtainCard(newcard)
	end,
}

----kaze009
--[祸祟] 出牌阶段，你可以弃置一张手牌并指定你攻击范围内的一名其他角色，该角色需打出一张【闪】，否则你须选择一项：摸一张牌或对其使用一张【杀】（此【杀】不计入每阶段的使用限制），每阶段限一次。
thhuosuicard=sgs.CreateSkillCard{
	name="thhuosuicard",
	target_fixed=false,
	will_throw=true,
	filter=function(self, targets, to_select, player)
		return player:canSlash(to_select) and #targets==0
	end,	
	on_use=function(self, room, source, targets)
		if room:askForCard(targets[1],"jink","@thhuosuijink") then return end
		if not room:askForUseSlashTo(source, targets[1], "@thhuosui-slash") then
			source:drawCards(1)
		end
	end,
}

thhuosui=sgs.CreateViewAsSkill{
	name="thhuosui",
	n=1,
	view_filter=function(self, selected, to_select)
		return not to_select:isEquipped()
	end,
	view_as=function(self, cards)
		if #cards~=1 then return end
		local HScard=thhuosuicard:clone()
		HScard:addSubcard(cards[1])
		HScard:setSkillName(self:objectName())
		return HScard
	end,
	enabled_at_play=function(self, player)
		return not player:hasUsed("#thhuosuicard")
	end,
}

--[天滴] 当其他角色使用【杀】指定你为目标时，你可以摸一张牌。
thtiandi=sgs.CreateTriggerSkill{
	name="thtiandi",
	frequency=sgs.Skill_Frequent,
	events={sgs.TargetConfirming},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local use=data:toCardUse()
		if not use.card:isKindOf("Slash") then return end
		if not player:askForSkillInvoke(self:objectName()) then return end
		player:drawCards(1)
	end,
}

--[坤仪] 限定技，出牌阶段，你可以将你的武将牌翻面，并对你攻击范围内的一名角色造成1点伤害。
thkunyicard=sgs.CreateSkillCard{
	name="thkunyicard",
	target_fixed=false,
	filter=function(self, targets, to_select, player)
		return player:inMyAttackRange(to_select)
	end,
	on_use=function(self, room, source, targets)
		source:loseMark("@kunyi")
		source:gainMark("@kunyiused")
		source:turnOver()
		local damage=sgs.DamageStruct()
			damage.damage=1
			damage.nature=sgs.DamageStruct_Normal 
			damage.chain=false 
			damage.from=source
			damage.to=targets[1]
		room:damage(damage)
	end,
}

thkunyivs=sgs.CreateViewAsSkill{
	name="thkunyivs",
	n=0,
	view_as=function(self, cards)
		local KYcard=thkunyicard:clone()
		KYcard:setSkillName("thkunyi")
		return KYcard
	end,
	enabled_at_play=function(self, player)
		return player:getMark("@kunyi")>0
	end,
}

thkunyi=sgs.CreateTriggerSkill{
	name="thkunyi",
	frequency=sgs.Skill_Limited,
	events={sgs.GameStart},
	view_as_skill=thkunyivs,
	on_trigger=function(self,event,player,data)
		player:gainMark("@kunyi")
	end,
}

----kaze010
--[残虐] 出牌阶段，你可以将一张方片牌交给一名其他角色，该角色须选择一项：1. 对其攻击范围内的另一名由你指定的角色使用一张【杀】 2. 令你获得其一张牌或对其造成1点伤害。每阶段限一次。
thcannuecard=sgs.CreateSkillCard{
	name="thcannuecard",
	will_throw=false,
	filter=function(self, targets, to_select, player)
	    return #targets==0 and to_select:objectName() ~= player:objectName()
	end,
	on_effect=function(self,effect)
		effect.to:obtainCard(self)
		local room=effect.to:getRoom()
    	local choice=room:askForChoice(effect.to, "thcannue", "cnslash+cnother")
    	if(choice == "cnslash")then
        	local players=room:getOtherPlayers(effect.to)
			local targets=sgs.SPlayerList()
        	for _,player in sgs.qlist(players) do
            	if(effect.to:canSlash(player) and player:objectName() ~= effect.from:objectName()) then
                	targets:append(player)
				end
			end
        	if(not targets:isEmpty())then
            	local target=room:askForPlayerChosen(effect.from, targets, "thcannue")
            	if not room:askForUseSlashTo(effect.to, target, "@thcannue-slash") then
					choice="cnother"
				end
			else
				choice="cnother"
			end
    	end
		if(choice == "cnother")then
        	choice=room:askForChoice(effect.from, "thcannue", "cnget+cnhit")
        	if(choice == "cnget")then
            	local card_id=room:askForCardChosen(effect.from, effect.to, "he", "thcannue")
            	effect.from:obtainCard(sgs.Sanguosha:getCard(card_id))
        	else
            	local damage=sgs.DamageStruct()
            		damage.from=effect.from
            		damage.to=effect.to
            	room:damage(damage)
			end
    	end
	end,
}

thcannue=sgs.CreateViewAsSkill{
	name="thcannue",
	n=1,
	
	view_filter=function(self, selected, to_select)
		return to_select:getSuit()==sgs.Card_Diamond
	end,

	view_as=function(self, cards)
		if #cards~=1 then return nil end		
		local CNcard=thcannuecard:clone()			
			CNcard:addSubcard(cards[1])
			CNcard:setSkillName(self:objectName())
		return CNcard	
	end,

	enabled_at_play=function(self, player)
		return not player:hasUsed("#thcannuecard")
	end,
}

--[肆暴] 你可以将一张装备牌当【酒】使用。 
thsibaovs=sgs.CreateViewAsSkill{
	name="thsibaovs",
	n=1,
	view_filter=function(self, selected, to_select)
		return to_select:isKindOf("EquipCard")
	end,
	view_as=function(self, cards)
		if #cards~=1 then return nil end		
		local YScard=sgs.Sanguosha:cloneCard("analeptic",cards[1]:getSuit(),cards[1]:getNumber())			
			YScard:addSubcard(cards[1])
			YScard:setSkillName("thsibao")
		return YScard	
	end,

	enabled_at_play=function(self, player)
		return not player:hasUsed("Analeptic")
	end,
	
	enabled_at_response=function(self,player,pattern) 
		return pattern=="Analeptic"
	end,
}

thsibao=sgs.CreateTriggerSkill{
	name="thsibao",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.AskForPeaches},
	priority=1,
	view_as_skill=thsibaovs,
	on_trigger=function(self,event,player,data)
		local dying=data:toDying()
		if dying.who:objectName()~=player:objectName() then return end
		local room=player:getRoom()
		local recover = sgs.RecoverStruct()
			recover.who = player
		if player:getHp()>0 then return end
		local card=room:askForCard(player,"Analeptic","@thsibao",sgs.CardUsed)
		while card do
				recover.card = card
			room:recover(player, recover)
			if player:getHp()>0 then break end
			card=room:askForCard(player,"Analeptic","@thsibao",sgs.CardUsed)
		end
	end,
}

----kaze011
--[罔罠] 出牌阶段，若你的武将牌上没有牌，你可以将一张手牌面朝下置于你的武将牌上称为"网"，然后令一名其他角色获得1枚"蛛丝"标记，每阶段限一次。其他角色的出牌阶段开始时，若其拥有"蛛丝"标记，须弃置之并展示一张手牌，然后你展示一张"网"，若这两张牌的点数之差大于X+2（X为你的体力值），则你可以选择以下一项：1. 弃置这张"网"，并对该角色造成1点伤害。2. 获得这张"网"，并弃置该角色一张牌。否则，该角色获得这张"网"，然后摸一张牌。
thwangmincard=sgs.CreateSkillCard{
	name="thwangmincard",
	target_fixed=false,
	will_throw=false,
	filter = function(self, targets, to_select, player)
		return #targets==0 and to_select:objectName()~=player:objectName()
	end,	
	on_use = function(self, room, source, targets)
		source:addToPile("wangminpile",self,false)
		targets[1]:gainMark("@zhusi")
	end,
}

thwangminvs=sgs.CreateViewAsSkill{
	name="thwangminvs",
	n=1,
	view_filter = function(self, selected, to_select)
		return not to_select:isEquipped()
	end,
	view_as = function(self, cards)
		if #cards==0 then return end
		local card=thwangmincard:clone()
		card:addSubcard(cards[1])
		card:setSkillName("thwangmin")
		return card
	end,
	enabled_at_play=function(self, player)
		return player:getPile("wangminpile"):isEmpty()
	end,
}

thwangmin=sgs.CreateTriggerSkill{
	name="thwangmin",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseStart},
	view_as_skill=thwangminvs,
	on_trigger=function(self,event,player,data)
		if player:getPhase()~=sgs.Player_Play then return end
		if player:getMark("@zhusi")<=0 then return end
		player:loseAllMarks("@zhusi")
		local room=player:getRoom()
		local splayer=room:findPlayerBySkillName(self:objectName())
		if not splayer then return end
		if splayer:getPile("wangminpile"):isEmpty() then return end
		local card=room:askForCardShow(player,splayer,self:objectName())
		room:showCard(player,card:getId())
		room:showCard(splayer,splayer:getPile("wangminpile"):first())
		local newcard=sgs.Sanguosha:getCard(splayer:getPile("wangminpile"):first())
		local ninus=math.abs(card:getNumber()-newcard:getNumber())
		local choice="cancel"
		if ninus>splayer:getHp()+2 then
			if not player:isNude() then
				choice=room:askForChoice(splayer,self:objectName(),"wangmin1+wangmin2+cancel")
			else
				choice=room:askForChoice(splayer,self:objectName(),"wangmin1+cancel")
			end
		end
		if choice=="wangmin1" then
			room:throwCard(newcard,splayer)
			local damage=sgs.DamageStruct()
				damage.damage=1
				damage.from=splayer
				damage.to=player
			room:damage(damage)
		elseif choice=="wangmin2" then
			splayer:obtainCard(newcard,false)
			local card_id=room:askForCardChosen(splayer,player,"he",self:objectName())
			local reason=sgs.CardMoveReason()
			reason.m_reason   = sgs.CardMoveReason_S_REASON_DISMANTLE
			reason.m_playerId = splayer:objectName()
    		reason.m_targetId = player:objectName()
			room:moveCardTo(sgs.Sanguosha:getCard(card_id), nil, nil, sgs.Player_DiscardPile, reason)
		else
			player:obtainCard(newcard,false)
			player:drawCards(1)
		end
	end,
	can_trigger=function(self,target)
		return true
	end,
}

----kaze012
--[葛笼] 出牌阶段，你可以与一名其他角色拼点。若你赢，你须选择一项：交给该角色一张手牌或者失去1点体力；若你没赢，你须选择一项：对该角色造成1点伤害或获得其一张牌。每阶段限一次。
thgelongcard=sgs.CreateSkillCard{
	name="thgelongcard",
	target_fixed=false,
	will_throw=false,
	filter=function(self, targets, to_select, player)
		return #targets==0 and not to_select:isKongcheng() and to_select:objectName()~=player:objectName()
	end,
	on_use=function(self, room, source, targets)
		local win=source:pindian(targets[1],"thgelong",sgs.Sanguosha:getCard(self:getEffectiveId()))
		local choice
		if win then
			choice="gllosehp"
			if not source:isKongcheng() then
				choice=room:askForChoice(source,"thgelong","glgive+gllosehp")
			end
		else
			choice="gldamage"
			if not targets[1]:isNude() then
				choice=room:askForChoice(source,"thgelong","gldamage+glget")
			end
		end
		local card_id
		if choice=="glgive" then
			card_id=room:askForCardChosen(source,source,"h","thgelong")
			room:moveCardTo(sgs.Sanguosha:getCard(card_id), targets[1], sgs.Player_PlaceHand, false)
		elseif choice=="gllosehp" then
			room:loseHp(source)
		elseif choice=="gldamage" then
			local damage=sgs.DamageStruct()
				damage.damage=1
				damage.from=source
				damage.to=targets[1]
			room:damage(damage)
		else
			card_id=room:askForCardChosen(source,targets[1],"he","thgelong")
			if(room:getCardPlace(card_id)==sgs.Player_PlaceHand) then
				room:moveCardTo(sgs.Sanguosha:getCard(card_id),source,sgs.Player_PlaceHand,false)
			else
				room:obtainCard(source,card_id)
			end
		end
	end,
}

thgelong=sgs.CreateViewAsSkill{
	name="thgelong",
	n=1,
	view_filter=function(self, selected, to_select)
		return not to_select:isEquipped()
	end,
	view_as=function(self, cards)
		if #cards~=1 then return end
		local GLcard=thgelongcard:clone()
		GLcard:addSubcard(cards[1])
		GLcard:setSkillName(self:objectName())
		return GLcard
	end,
	enabled_at_play=function(self, player)
		return not player:hasUsed("#thgelongcard")
	end,
}

--[怨咒] 回合结束阶段开始时，若你的手牌数是全场最少的（或之一），你可以弃置场上手牌数最多的一名角色的区域的一张牌。
thyuanzhou=sgs.CreateTriggerSkill{
	name="thyuanzhou",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseChanging},
	on_trigger=function(self,event,player,data)
		local change=data:toPhaseChange()
		if change.to~=sgs.Player_Finish then return end
		local room=player:getRoom()
		local cannot=false
		local maxnum=0
		for _,p in sgs.qlist(room:getOtherPlayers(player)) do
			if p:getHandcardNum()<player:getHandcardNum() then
				cannot=true
				break
			end
			if p:getHandcardNum()>maxnum then
				maxnum=p:getHandcardNum()
			end
		end
		if cannot then return end
		if not player:askForSkillInvoke(self:objectName()) then return end
		local targets=sgs.SPlayerList()
		for _,p in sgs.qlist(room:getAllPlayers()) do
			if p:getHandcardNum()==maxnum and p:getCards("hej"):length()~=0 then
				targets:append(p)
			end
		end
		if targets:isEmpty() then return end
		local target=room:askForPlayerChosen(player,targets,"thyuanzhou")
		local log= sgs.LogMessage()
			log.type = "#thyuanzhou"
			log.from = player
			log.to:append(target)
		room:sendLog(log)
		local card_id=room:askForCardChosen(player,target,"hej","thyuanzhou")
		local reason=sgs.CardMoveReason()
		reason.m_reason   = sgs.CardMoveReason_S_REASON_DISMANTLE
		reason.m_playerId = player:objectName()
    	reason.m_targetId = target:objectName()
		room:moveCardTo(sgs.Sanguosha:getCard(card_id), nil, nil, sgs.Player_DiscardPile, reason)
	end,
}

----kaze015
--[焰轮] 出牌阶段，你可以与一名其他角色拼点。若你赢，你获得以下技能直到回合结束：你可以将一张红色手牌当【火攻】使用；你使用【火攻】时可弃置与目标角色展示的手牌颜色相同的手牌；你每使用【火攻】造成一次伤害后，可以摸一张牌。若你没赢，则其对你造成1点火焰伤害。每阶段限一次。
thyanluncard=sgs.CreateSkillCard{
	name="thyanluncard",
	will_throw=false,
	filter=function(self, targets, to_select, player)
		return to_select:objectName()~=player:objectName() and (not to_select:isKongcheng()) and #targets==0
	end,
	on_use=function(self, room, source, targets)
		local win=source:pindian(targets[1],"thyanlun",sgs.Sanguosha:getCard(self:getEffectiveId()))
		if win then
			room:setPlayerFlag(source,"yanlun")
		else
			local damage=sgs.DamageStruct()
				damage.damage=1
				damage.from=targets[1]
				damage.to=source
				damage.nature=sgs.DamageStruct_Fire
			room:damage(damage)
		end
	end,
}

thyanlunvs=sgs.CreateViewAsSkill{
	name="thyanlunvs",
	n=1,
	view_filter=function(self, selected, to_select)
		if sgs.Self:hasFlag("yanlun") then
			return (not to_select:isEquipped()) and to_select:isRed()
		else
			return not to_select:isEquipped()
		end
	end,
	view_as=function(self, cards)
		if #cards~=1 then return end
		local YLcard
		if sgs.Self:hasFlag("yanlun") then
			YLcard=sgs.Sanguosha:cloneCard("fire_attack",cards[1]:getSuit(),cards[1]:getNumber())
		else
			YLcard=thyanluncard:clone()
		end
		YLcard:addSubcard(cards[1])
		YLcard:setSkillName("thyanlun")
		return YLcard
	end,
	enabled_at_play=function(self, player)
		return not player:hasUsed("#thyanluncard")
	end,
}

thyanlun=sgs.CreateTriggerSkill{
	name="thyanlun",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseChanging,sgs.Damage},
	priority=1,
	view_as_skill=thyanlunvs,
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if event==sgs.Damage then
			if not player:hasFlag("yanlun") then return end
			if not data:toDamage().card:isKindOf("FireAttack") then return end
			if not player:askForSkillInvoke(self:objectName()) then return end
			player:drawCards(1)
			return
		end
		if event==sgs.EventPhaseChanging then
			local change=data:toPhaseChange()
			if change.to~=sgs.Player_NotActive then return end
			room:setPlayerFlag(player,"-yanlun")
			return
		end
	end,
}

thyanluntr=sgs.CreateTriggerSkill{
	name="#thyanluntr",
	frequency=sgs.Skill_Compulsory,
	events={sgs.CardEffect},
	priority=-2,
	on_trigger=function(self,event,player,data)
		if not player:hasFlag("yanlun") then return end
		local effect=data:toCardEffect()
		if not effect.card:isKindOf("FireAttack") then return false end
		local room=player:getRoom()
		local thread=room:getThread()
		local new_data = sgs.QVariant()
		new_data:setValue(effect)
		room:setTag("SkipGameRule", sgs.QVariant(true))
		local avoid = thread:trigger(sgs.CardEffected, room, effect.to, new_data)
		if avoid then return true end
		local canceled=room:isCanceled(effect)
		if not canceled then
			if effect.to:isKongcheng() then return true end
			local card=room:askForCardShow(effect.to,effect.from,effect.card:objectName())
			room:showCard(effect.to,card:getEffectiveId())
			local color=""
			if card:isRed() then
				color="red"
			else
				color="black"
			end
			local pattern="."..color
			local prompt=("@fire-attackex:%s::%s"):format(effect.to:getGeneralName(),color)
			if room:askForCard(effect.from, pattern, prompt, sgs.QVariant(), sgs.CardDiscarded) then
				local damage=sgs.DamageStruct()
				damage.card=effect.card
				damage.from=effect.from
				damage.to=effect.to
				damage.nature=sgs.DamageStruct_Fire
				room:damage(damage)
			end
			return true
		end
		return true
	end,
}

----kaze017
--[埋火] 出牌阶段，你可以将一张红桃牌交给一名其他角色并选择一种花色，然后展示该角色全部的手牌，其中每有一张该花色的牌，该角色摸一张牌（至多摸三张），每阶段限一次。
thmaihuocard=sgs.CreateSkillCard{
	name="thmaihuocard",
	target_fixed=false,
	will_throw=false,
	filter = function(self, targets, to_select, player)
		return #targets==0 and to_select:objectName()~=player:objectName()
	end,
	on_use = function(self, room, source, targets)
		local target=targets[1]
		target:obtainCard(self)
		local suit=room:askForSuit(source,"thmaihuo")
		room:showAllCards(target,nil)
		local card_ids=target:handCards()
		local num=0
		for _,id in sgs.qlist(card_ids) do
			if sgs.Sanguosha:getCard(id):getSuit()==suit then
				num=num+1
			end
		end
		if num==0 then return end
		target:drawCards(math.min(3,num))
	end,
}

thmaihuo=sgs.CreateViewAsSkill{
	name="thmaihuo",
	n=1,
	view_filter = function(self, selected, to_select)
		return to_select:getSuit()==sgs.Card_Heart
	end,
	view_as = function(self, cards)
		if #cards~=1 then return end
		local MHcard=thmaihuocard:clone()
		MHcard:addSubcard(cards[1])
		MHcard:setSkillName(self:objectName())
		return MHcard
	end,
	enabled_at_play=function(self, player)
		return not player:hasUsed("#thmaihuocard")
	end,
}

--[无念] 锁定技，你即将造成的伤害视为没有来源的伤害，未受伤的角色使用的【杀】和非延时类锦囊牌对你无效。
thwunian=sgs.CreateTriggerSkill{
	name="thwunian",
	frequency=sgs.Skill_Compulsory,
	events={sgs.Predamage,sgs.CardEffected},
	priority=1,
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local log= sgs.LogMessage()
			log.type = "#TriggerSkill"
			log.from = player
			log.arg  = self:objectName()
		if event==sgs.Predamage then
			room:sendLog(log)
			local damage=data:toDamage()
			damage.from=nil
			data:setValue(damage)
			return
		end
		local effect=data:toCardEffect()
		if (effect.card:isNDTrick() or effect.card:isKindOf("Slash")) and not effect.from:isWounded() then
			room:sendLog(log)
			return true
		end
		return
	end,
}

----hana003
--[彼岸] 当一名角色进入濒死状态时，你可以弃置两张手牌，则该角色失去1点体力。每回合限一次。
thbian=sgs.CreateTriggerSkill{
	name="thbian",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.Dying,sgs.EventPhaseChanging},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local splayer=room:findPlayerBySkillName(self:objectName())
		if not splayer then return end
		if event==sgs.EventPhaseChanging then
			local change=data:toPhaseChange()
			if change.to==sgs.Player_NotActive then
				splayer:removeMark("thbian")
			end
			return false
		end
		if player:getHp()>0 then return end
		if splayer:getMark("thbian")~=0 then return end
		if splayer:getCardCount(true)<2 then return end
		if not room:askForSkillInvoke(splayer,self:objectName()) then return end
		if not room:askForDiscard(splayer,self:objectName(),2,2,true,false) then return end
		splayer:addMark("thbian")
		room:loseHp(player)
	end,
	can_trigger=function(self,target)
		return true
	end,
}

--[归航] 当一名有手牌的角色进入濒死状态时，你可以展示该角色的一张手牌，若该牌为红色，该角色须弃置这张牌并回复1点体力。 
thguihang=sgs.CreateTriggerSkill{
	name="thguihang",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.Dying},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:getHp()>0 then return end
		local splayer=room:findPlayerBySkillName(self:objectName())
		if not splayer then return end
		if player:isKongcheng() then return end
		if not room:askForSkillInvoke(splayer,self:objectName()) then return end
		local card
		if splayer:objectName()==player:objectName() then
			card=room:askForCardShow(splayer,splayer,"@thguihang")
			room:showCard(player,card:getId())
		else
			card=room:askForCardChosen(splayer,player,"h",self:objectName())
			room:showCard(player,card)
		end
		if card:isBlack() then return end
		room:throwCard(card,player)
		local recover=sgs.RecoverStruct()
			recover.recover=1
			recover.card=nil
			recover.who=splayer
		room:recover(player, recover)
	end,
	can_trigger=function(self,target)
		return true
	end,
}

--[无间] 出牌阶段，你可以弃置一张牌并指定你攻击范围内的一名其他角色，直到你的下回合开始，当该角色计算与除其以外的角色的距离时，始终+1，每阶段限一次。 
thwujiancard=sgs.CreateSkillCard{
	name="thwujiancard",
	target_fixed=false,
	will_throw=true,
	filter=function(self, targets, to_select, player)
		return player:inMyAttackRange(to_select) and to_select:objectName()~=player:objectName() and #targets==0
	end,
	on_use=function(self, room, source, targets)
		targets[1]:gainMark("@wujian")
	end,
}

thwujianvs=sgs.CreateViewAsSkill{
	name="thwujianvs",
	n=1,
	view_filter=function(self, selected, to_select)
		return true
	end,

	view_as=function(self, cards)
		if #cards~=1 then return end 
		local WJcard=thwujiancard:clone()
		WJcard:addSubcard(cards[1])
		WJcard:setSkillName(self:objectName())
		return WJcard
	end,

	enabled_at_play=function(self, player)
		return not player:hasUsed("#thwujiancard")
	end,
}

thwujian=sgs.CreateTriggerSkill{
	name="thwujian",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseChanging,sgs.Death},
	view_as_skill=thwujianvs,
	
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if event==sgs.Death then
			for _,p in sgs.qlist(room:getAllPlayers()) do
				if p:getMark("@wujian")>0 then
					p:loseAllMarks("@wujian")
				end
			end
			return
		end
		local change=data:toPhaseChange()
		if change.to~=sgs.Player_Start then return end
		for _,p in sgs.qlist(room:getAllPlayers()) do
			if p:getMark("@wujian")~=0 then 
				p:loseAllMarks("@wujian")
			end
		end
	end,

	can_trigger=function(self,target)
		return target and target:hasSkill(self:objectName())
	end,
}

thwujiandis=sgs.CreateDistanceSkill{
	name="#thwujiandis",
	correct_func=function(self,from,to)
		if from:getMark("@wujian")~=0 then
			return 1
		end
	end,
}

----hana006
--[戏画] 出牌阶段，你可以选择一至四项：1. 弃置两张红桃牌并回复1点体力 2. 弃置两张草花牌并弃置一名其他角色的一张牌 3. 弃置两张方片牌并令一名其他角色摸两张牌，然后该角色须弃置一张牌 4. 弃置两张黑桃牌并令一名其他角色摸两张牌，然后该角色将其武将牌翻面 
thxihuaspadecard=sgs.CreateSkillCard{
	name="thxihuaspadecard",
	target_fixed=false,
	will_throw=true,
	filter=function(self, targets, to_select, player)
		return #targets==0
	end,
	on_use=function(self, room, source, targets)
		targets[1]:drawCards(2)
		targets[1]:turnOver()
	end,
}

thxihuaheartcard=sgs.CreateSkillCard{
	name="thxihuaheartcard",
	target_fixed=true,
	will_throw=true,
	on_use=function(self, room, source, targets)
		local recover=sgs.RecoverStruct()
			recover.recover=1
			recover.card=nil
			recover.who=source
		room:recover(source, recover)
	end,
}

thxihuaclubcard=sgs.CreateSkillCard{
	name="thxihuaclubcard",
	target_fixed=false,
	will_throw=true,
	filter=function(self, targets, to_select, player)
		return #targets==0 and to_select:objectName()~=player:objectName() and not to_select:isNude()
	end,
	on_use=function(self, room, source, targets)
		local card_id=room:askForCardChosen(source,targets[1],"he","thxihua")
		local reason=sgs.CardMoveReason()
		reason.m_reason   = sgs.CardMoveReason_S_REASON_DISMANTLE
		reason.m_playerId = source:objectName()
    	reason.m_targetId = targets[1]:objectName()
		room:moveCardTo(sgs.Sanguosha:getCard(card_id), nil, nil, sgs.Player_DiscardPile, reason)
	end,
}

thxihuadiamondcard=sgs.CreateSkillCard{
	name="thxihuadiamondcard",
	target_fixed=false,
	will_throw=true,
	filter=function(self, targets, to_select, player)
		return #targets==0
	end,
	on_use=function(self, room, source, targets)
		targets[1]:drawCards(2)
		if not targets[1]:isNude() then
			room:askForDiscard(targets[1],"thxihua",1,1,false,true)
		end
	end,
}

thxihua=sgs.CreateViewAsSkill{
	name="thxihua",
	n=2,
	view_filter=function(self, selected, to_select)
		if #selected == 1 then
			return to_select:getSuit()==selected[1]:getSuit()
		end
		return true
	end,
	view_as=function(self, cards)
		if #cards~=2 then return end
		local XHcard
		local suit=cards[1]:getSuit()
		if suit==sgs.Card_Spade then
			XHcard=thxihuaspadecard:clone()
		elseif suit==sgs.Card_Heart then
			XHcard=thxihuaheartcard:clone()
		elseif suit==sgs.Card_Club then
			XHcard=thxihuaclubcard:clone()
		else
			XHcard=thxihuadiamondcard:clone()
		end
		XHcard:addSubcard(cards[1])
		XHcard:addSubcard(cards[2])
		XHcard:setSkillName(self:objectName())
		return XHcard
	end,
}

----hana007
--[暗云] 摸牌阶段，你可以放弃摸牌，若如此做，此回合的回合结束阶段开始时，你摸两张牌。 
thanyun=sgs.CreateTriggerSkill{
	name="thanyun",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseStart},
	
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:getPhase()==sgs.Player_Draw then
			if not room:askForSkillInvoke(player,self:objectName(),data) then return end
			room:broadcastSkillInvoke(self:objectName(),math.random(1,2))
			room:setPlayerFlag(player,"thanyun")
			return true
		elseif player:getPhase()==sgs.Player_Finish then
			if player:hasFlag("thanyun") then
				room:setPlayerFlag(player,"-thanyun")
				room:broadcastSkillInvoke(self:objectName(),3)
				player:drawCards(2)
			end
		elseif player:getPhase()==sgs.Player_NotActive then
			room:setPlayerFlag(player,"-thanyun")
		end
	end,
}

--[迷蒙] 你可将你最后的手牌当除【无中生有】、【五谷丰登】、【顺手牵羊】、【桃园结义】和【万箭齐发】以外的基本牌或非延时类锦囊牌使用或者打出。
all_card={}
card_pattern={}
ban_card={"amazing_grace", "archery_attack", "ex_nihilo", "god_salvation", "snatch", "nullification", "jink"}
thmimengcard=sgs.CreateSkillCard{
	name="thmimengcard",
	target_fixed=true,
	
	on_use=function(self, room, source, targets)
		local cardIds=sgs.Sanguosha:getRandomCards()
		for _,card_id in sgs.qlist(cardIds) do
			local card=sgs.Sanguosha:getCard(card_id)
			if not table.contains(all_card, card:objectName()) and (card:isKindOf("BasicCard") or card:isNDTrick()) then
				table.insert(all_card, card:objectName())
			end
		end
		local temp_table=table.copyFrom(all_card)
		for _,name in ipairs(temp_table) do
			if table.contains(ban_card, name) then
				table.removeOne(all_card, name)
			end
		end
		if not (source:canSlashWithoutCrossbow() or (source:getWeapon() and source:getWeapon():className() == "Crossbow")) then
			table.removeOne(all_card, "slash")
			table.removeOne(all_card, "thunder_slash")
			table.removeOne(all_card, "fire_slash")
		end
		if source:hasUsed("Analeptic") then
			table.removeOne(all_card, "analeptic")
		end
		if not source:isWounded() then
			table.removeOne(all_card, "peach")
		end
		local choice
		choice=room:askForChoice(source, "thmimeng", table.concat(all_card, "+"))
		local card
		for id=0,159,1 do
			card=sgs.Sanguosha:getCard(id)
			if card:objectName()==choice then
				room:setPlayerMark(source,"thmimengmark",id+1)
				break
			end
		end
		--table.remove(card_pattern)
		--table.insert(card_pattern, choice)
		room:askForUseCard(source, "@@thmimeng", "@thmimeng")
		room:setPlayerMark(source,"thmimengmark",0)
	end,
}

thmimengpeachcard=sgs.CreateSkillCard{
	name="thmimengpeachcard",
	target_fixed=true,
	on_use=function(self, room, source, targets)
		local choice=room:askForChoice(source,"thmimeng","peach+analeptic")
		room:askForUseCard(source, choice,"@thmimengsave")
	end,
}

thmimengironchaincard=sgs.CreateSkillCard{
	name="thmimengironchaincard",
	target_fixed=false,
	filter=function(self, targets, to_select, player)
		return #targets<2
	end,
	on_use=function(self, room, source, targets)
		local card=sgs.Sanguosha:getCard(self:getSubcards():first())
		local newcard=sgs.Sanguosha:cloneCard("iron_chain",card:getSuit(),card:getNumber())
		newcard:addSubcard(card)
		newcard:setSkillName("thmimeng")
		local use=sgs.CardUseStruct()
        	use.card=newcard
        	use.from=source
			for x=1,#targets,1 do
        		use.to:append(targets[x])
			end
		room:useCard(use, true)
	end,
}

thmimeng=sgs.CreateViewAsSkill{
	name="thmimeng",
	n=1,
	
	view_filter=function(self, selected, to_select)
		return not to_select:isEquipped()
	end,

	view_as=function(self, cards)
		if #card_pattern == 0 and sgs.Self:getMark("thmimengmark")<=0 then return thmimengcard:clone() end
		if card_pattern[1]=="peach+analeptic" then
			return thmimengpeachcard:clone()
		end
		if #cards~=1 then return nil end
		local card,cardname
		local id=sgs.Self:getMark("thmimengmark")-1
		if id~=-1 then
			cardname=sgs.Sanguosha:getCard(id):objectName()
		end
		if cardname=="iron_chain" then
			card=thmimengironchaincard:clone()
		elseif cardname then
			card=sgs.Sanguosha:cloneCard(cardname, cards[1]:getSuit(), cards[1]:getNumber())
		else
			card=sgs.Sanguosha:cloneCard(card_pattern[1], cards[1]:getSuit(), cards[1]:getNumber())
		end
		card:addSubcard(cards[1])
		card:setSkillName(self:objectName())
		return card
	end,

	enabled_at_play=function(self, player)
		if #card_pattern ~= 0 then
			table.remove(card_pattern)
		end
		if player:getMark("thmimengmark")~=0 then
			player:setMark("thmimengmark",0)
		end
		return player:getHandcardNum()==1
	end,
	
	enabled_at_response=function(self,player,pattern)
		if player:getHandcardNum()~=1 then return false end
		if pattern=="slash" or pattern=="jink" or pattern=="peach" or pattern=="analeptic" or pattern=="peach+analeptic" or pattern=="nullification" then
			table.remove(card_pattern)
			table.insert(card_pattern, pattern)
		end
		return (#card_pattern ~= 0 or pattern == "@@thmimeng")
	end,
	
	enabled_at_nullification=function(self, player)
		return player:getHandcardNum()==1
	end
}

thmimengtr=sgs.CreateTriggerSkill{
	name="#thmimengtr",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.CardUsed},
	on_trigger=function(self,event,player,data)
		local use=data:toCardUse()
		local room=player:getRoom()
		if use.card:getSkillName()==self:objectName() then
			if player:getMark("thmimengmark")>0 then
				room:setPlayerMark(player,"thmimengmark",0)
			end
		end
	end,
}

----hana008
--[劝善] 出牌阶段，你可选择一名体力值不小于你且有手牌的其他角色，该角色须将至少一张手牌交给另一名除你以外的角色，每阶段限一次。
thquanshangivecard=sgs.CreateSkillCard{
	name="thquanshangivecard",
	target_fixed=false,
	will_throw=false,
	filter=function(self, targets, to_select, player)
		return #targets==0 and to_select:objectName()~=player:objectName() and not to_select:hasSkill("thquanshan")
	end,
	on_use=function(self, room, source, targets)
		room:moveCardTo(self,targets[1],sgs.Player_PlaceHand,false)
	end,
}

thquanshangive=sgs.CreateViewAsSkill{
	name="thquanshangive",
	n=998,
	view_filter=function(self, selected, to_select)
		return not to_select:isEquipped()
	end,
	view_as=function(self, cards)
		if #cards==0 then return end
		local card=thquanshangivecard:clone()
		card:setSkillName("thquanshan")
		for i=1,#cards,1 do
			card:addSubcard(cards[i])
		end
		return card
	end,
	enabled_at_play=function(self, player)
		return false
	end,
	enabled_at_response=function(self,player,pattern) 
		return pattern=="@@thquanshangive!"
	end,
}

thquanshancard=sgs.CreateSkillCard{
	name="thquanshancard",
	target_fixed=false,
	filter=function(self, targets, to_select, player)
		return not to_select:isKongcheng() and to_select:getHp()>=player:getHp() and to_select:objectName()~=player:objectName() and #targets==0
	end,
	on_use=function(self, room, source, targets)
		if room:alivePlayerCount()==2 then return end
		room:askForUseCard(targets[1],"@@thquanshangive!","@thquanshan")
	end,
}

thquanshan=sgs.CreateViewAsSkill{
	name="thquanshan",
	n=0,
	view_as=function(self, cards)
		local QScard=thquanshancard:clone()
		QScard:setSkillName(self:objectName())
		return QScard
	end,
	enabled_at_play=function(self, player)
		return not player:hasUsed("#thquanshancard")
	end,
}

--[仙罡] 每当你受到伤害时，可以进行一次判定，若结果为草花，防止此伤害。
thxiangang=sgs.CreateTriggerSkill{
	name="thxiangang",
	frequency=sgs.Skill_Frequent,
	events={sgs.DamageInflicted},
	priority=2,
	on_trigger=function(self,event,player,data)
		if not player:askForSkillInvoke(self:objectName()) then return end
		local room=player:getRoom()
		local judge=sgs.JudgeStruct()
			judge.pattern=sgs.QRegExp("(.*):(club):(.*)")
			judge.good=true
			judge.reason=self:objectName()
			judge.who=player
		room:judge(judge)
		if judge:isGood() then
			room:setEmotion(player,"good")
		else
			room:setEmotion(player,"bad")
			return
		end
		local log= sgs.LogMessage()
			log.type = "#thxiangang"
			log.from = player
		room:sendLog(log)
		return true
	end,
}

----hana011
--[报春] 摸牌阶段，你可以放弃摸牌，改为将至多X张红色手牌交给一名其他角色，然后摸等量的牌（X为该角色已损失的体力值）。
thbaochuncard=sgs.CreateSkillCard{
	name="thbaochuncard",
	target_fixed=false,
	will_throw=false,
	filter = function(self, targets, to_select, player)
		return #targets==0 and to_select:objectName()~=player:objectName() and self:subcardsLength()<=to_select:getLostHp()
	end,
	on_use = function(self, room, source, targets)
		room:moveCardTo(self,targets[1],sgs.Player_PlaceHand,false)
		source:drawCards(self:subcardsLength())
	end,
}

thbaochunvs=sgs.CreateViewAsSkill{
	name="thbaochunvs",
	n=998,
	view_filter = function(self, selected, to_select)
		return not to_select:isEquipped() and to_select:isRed()
	end,
	view_as = function(self, cards)
		if #cards==0 then return end
		local card=thbaochuncard:clone()
		for i=1,#cards,1 do
			card:addSubcard(cards[i])
		end
		card:setSkillName("thbaochun")
		return card
	end,
	enabled_at_play=function(self, player)
		return false
	end,
	enabled_at_response=function(self,player,pattern) 
		return pattern=="@@thbaochun"
	end,
}

thbaochun=sgs.CreateTriggerSkill{
	name="thbaochun",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseStart},
	view_as_skill=thbaochunvs,
	on_trigger=function(self,event,player,data)
		if player:getPhase()~=sgs.Player_Draw then return end
		if player:isKongcheng() then return end
		if not player:askForSkillInvoke(self:objectName()) then return end
		local room=player:getRoom()
		if not room:askForUseCard(player,"@@thbaochun","@thbaochun") then return end
		return true
	end,
}

--[探春] 你的回合外，每当其他角色的方片牌因弃置而置入弃牌堆时，你可以摸一张牌。
thtanchun=sgs.CreateTriggerSkill{
	name="thtanchun",
	frequency=sgs.Skill_Frequent,
	events={sgs.CardsMoveOneTime},
	priority=4,
	on_trigger=function(self,event,player,data)
		local move=data:toMoveOneTime()
		if move.from==nil or move.from:objectName()==player:objectName() then return end
		local reason=move.reason.m_reason
		local invoke= reason==sgs.CardMoveReason_S_REASON_DISCARD or reason==sgs.CardMoveReason_S_REASON_RULEDISCARD or reason==sgs.CardMoveReason_S_REASON_THROW or reason==sgs.CardMoveReason_S_REASON_CHANGE_EQUIP or reason==sgs.CardMoveReason_S_REASON_DISMANTLE
		local card_id
		if move.to_place==sgs.Player_DiscardPile and invoke then
            for i=0,(move.card_ids:length()-1),1 do
                card_id = (move.card_ids):at(i)
				if sgs.Sanguosha:getCard(card_id):getSuit() == sgs.Card_Diamond and (move.from_places):at(i) ~= sgs.Player_PlaceDelayedTrick and (move.from_places):at(i) ~= sgs.Player_PlaceSpecial then
					if player:askForSkillInvoke(self:objectName()) then
						player:drawCards(1)
					end
				end
			end
		end
	end,
}

----hana013
--[硬化] 你的回合外，每当你受到伤害时，你可以防止此伤害，然后获得等同于受到伤害数量的"坚韧"标记。
thyinghua=sgs.CreateTriggerSkill{
	name="thyinghua",
	frequency=sgs.Skill_Frequent,
	priority=3,
	events={sgs.DamageInflicted},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local damage=data:toDamage()
		if player:getPhase()~=sgs.Player_NotActive then return end
		if not player:askForSkillInvoke(self:objectName()) then return end
		player:gainMark("@jianren",damage.damage)
		return true
	end,
}

--[疗愈] 回合开始阶段开始时，若你拥有“坚韧”标记，你可弃置一张牌并选择X种花色（X为你拥有的“坚韧”标记的数量，且至多为4），然后进行一次判定，若结果为你所选的花色之一，你弃置1枚“坚韧”标记。你可重复此流程直到你没有“坚韧”标记为止。
thliaoyu=sgs.CreateTriggerSkill{
	name="thliaoyu",
	frequency=sgs.Skill_Frequent,
	events={sgs.EventPhaseStart},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:getPhase()~=sgs.Player_Start then return end
		if player:getMark("@jianren")<=0 then return end
		if player:isNude() then return end
		local maxtimes=player:getMark("@jianren")
		local choice
		if not player:askForSkillInvoke(self:objectName()) then return end
		if not room:askForDiscard(player,self:objectName(),1,1,true,true) then return end
		local allsuit={"spade","heart","club","diamond"}
		local canchoice={}
		local choiced={}
		local goon=true 
		local canlose=false
		local judge,log
		while true do
			if player:getMark("@jianren")<4 then
				choiced={}
				canchoice=table.copyFrom(allsuit)
				for i=1,player:getMark("@jianren"),1 do
					choice=room:askForChoice(player,self:objectName(), table.concat(canchoice, "+"))
					log= sgs.LogMessage()
						log.type = "#ChooseSuit"
						log.from = player
						log.arg  = choice
					room:sendLog(log)
					table.removeOne(canchoice,choice)
					table.insert(choiced,choice)
				end
			else
				choiced=allsuit
			end
			judge=sgs.JudgeStruct()
				judge.pattern=sgs.QRegExp("(.*):(.*):(.*)")
				judge.good=true
				judge.reason=self:objectName()
				judge.who=player
			room:judge(judge)
			if table.contains(choiced,judge.card:getSuitString())then
				room:setEmotion(player,"good")
				player:loseMark("@jianren")
			else
				room:setEmotion(player,"bad")
			end
			if player:isNude() then break end
			if player:getMark("@jianren")==0 then return end
			if not room:askForDiscard(player,self:objectName(),1,1,true,true) then break end
		end
	end,
}

--[后知] 锁定技，回合结束阶段开始时，你须弃置全部的"坚韧"标记，并失去等量的体力。
thhouzhi=sgs.CreateTriggerSkill{
	name="thhouzhi",
	frequency=sgs.Skill_Compulsory,
	events={sgs.EventPhaseEnd},	
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:getPhase()~=sgs.Player_Finish then return end
		local x=player:getMark("@jianren")
		if x<=0 then return end
		local log= sgs.LogMessage()
			log.type = "#TriggerSkill"
			log.from = player
			log.arg  = self:objectName()
		room:sendLog(log)
		room:loseHp(player,x)
		player:loseAllMarks("@jianren")
	end,
}

----hana016
--[尸解] 当你处于濒死状态时，你每回复1点体力，可以从牌堆顶亮出一张牌置于你的武将牌上，称为“皿”。你可以将一张“皿”当【无懈可击】使用。
thshijiecard=sgs.CreateSkillCard{
	name="thshijiecard",
	target_fixed=true,
}

thshijie=sgs.CreateViewAsSkill{
	name="thshijie",
	n=0,
	view_as = function(self, cards)
		local acard=thshijiecard:clone()
		acard:setSkillName("thshijie")
		return acard
	end,
	enabled_at_play=function(self, player)
		return false
	end,
	enabled_at_response=function(self,player,pattern) 
		return pattern=="nullification" and player:getPile("shijiepile"):length()~=0
	end,
	enabled_at_nullification = function(self, player)
		return player:getPile("shijiepile"):length()~=0
	end
}

thshijietr=sgs.CreateTriggerSkill{
	name="#thshijietr",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.CardUsed,sgs.HpRecover},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if event==sgs.CardUsed then
			local use=data:toCardUse()
			if use.card:getSkillName()=="thshijie" or use.card:getSkillName()=="thshijiecard" then
				local card_ids=player:getPile("shijiepile")
				room:fillAG(card_ids,nil)
				local card_id=room:askForAG(player,card_ids,false,"thshijie")
				for _,p in sgs.qlist(room:getPlayers()) do
					p:invoke("clearAG")
				end
				local card=sgs.Sanguosha:getCard(card_id)
				use.card=sgs.Sanguosha:cloneCard("nullification",card:getSuit(),card:getNumber())
				use.card:addSubcard(card)
				data:setValue(use)
			end
			return
		end
		local recover=data:toRecover()
		if player:getHp()<=0 then
			for i=1,recover.recover,1 do
				if not player:askForSkillInvoke("thshijie") then break end
				player:addToPile("shijiepile",room:drawCard(),true)
			end
		end
	end,
}

--[圣贽] 其他角色的回合开始时，你可以弃置一张黑色手牌或“皿”并选择一个阶段，然后令该角色跳过此回合的该阶段。若以此法跳过摸牌阶段，你失去1点体力；若以此法跳过出牌阶段，该角色回复1点体力。
thshengzhi=sgs.CreateTriggerSkill{
	name="thshengzhi",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.TurnStart,sgs.EventPhaseChanging},
	priority=4,
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if event==sgs.EventPhaseChanging then
			if player:getMark("thshengzhi")==0 then return end
			local change=data:toPhaseChange()
			local to=change.to
			if player:getMark("thshengzhistart")>0 and to==sgs.Player_Start then 
				room:setPlayerMark(player,"thshengzhi",0)
				room:setPlayerMark(player,"thshengzhistart",0)
				player:skip(to)
			end
			if player:getMark("thshengzhijudge")>0 and to==sgs.Player_Judge then 
				room:setPlayerMark(player,"thshengzhi",0)
				room:setPlayerMark(player,"thshengzhijudge",0)
				player:skip(to)
			end
			if player:getMark("thshengzhidraw")>0 and to==sgs.Player_Draw then
				room:setPlayerMark(player,"thshengzhi",0)
				room:setPlayerMark(player,"thshengzhidraw",0)
				player:skip(to)
			end
			if player:getMark("thshengzhiplayy")>0 and to==sgs.Player_Play then
				room:setPlayerMark(player,"thshengzhi",0)
				room:setPlayerMark(player,"thshengzhiplayy",0)
				player:skip(to)
			end
			if player:getMark("thshengzhidiscard")>0 and to==sgs.Player_Discard then 
				room:setPlayerMark(player,"thshengzhi",0)
				room:setPlayerMark(player,"thshengzhidiscard",0)
				player:skip(to)
			end
			if player:getMark("thshengzhifinish")>0 and to==sgs.Player_Finish then 
				room:setPlayerMark(player,"thshengzhi",0)
				room:setPlayerMark(player,"thshengzhifinish",0)
				player:skip(to)
			end
			return
		end
		local splayer=room:findPlayerBySkillName(self:objectName())
		if not splayer then return end
		if not player:faceUp() then return end
		if player:objectName()==splayer:objectName() then return end
		if splayer:isKongcheng() and splayer:getPile("shijiepile"):length()==0 then return end
		if not splayer:askForSkillInvoke(self:objectName()) then return end
		local canskip=false
		if not splayer:isKongcheng() then
			if room:askForCard(splayer,".black","@thshengzhi",data,sgs.CardDiscarded) then
				canskip=true
			end
		end
		if splayer:getPile("shijiepile"):length()~=0 and not canskip then
			local card_ids=splayer:getPile("shijiepile")
			room:fillAG(card_ids,nil)
			local card_id=room:askForAG(splayer,card_ids,true,"thshengzhi")
			for _,p in sgs.qlist(room:getPlayers()) do
				p:invoke("clearAG")
			end
			if card_id~=-1 then 
				room:throwCard(sgs.Sanguosha:getCard(card_id),player)
				canskip=true
			end
		end
		if not canskip then return end
		local choice=room:askForChoice(splayer,"thshengzhi","start+judge+draw+playy+discard+finish")
		player:addMark("thshengzhi")
		player:addMark("thshengzhi"..choice)
		if choice=="draw" then room:loseHp(splayer) end
		if choice=="playy" then 
			local recover=sgs.RecoverStruct()
				recover.who=splayer
			room:recover(player,recover)
		end
	end,
	can_trigger=function(self,target)
		return true
	end,
}

----hana017
--[诏谕] 一名角色的回合开始阶段开始时，你可以将一张牌置于牌堆顶。
thzhaoyucard=sgs.CreateSkillCard{
	name="thzhaoyucard",
	target_fixed=true,
	will_throw=false,
	on_use = function(self, room, source, targets)
		room:moveCardTo(self,nil,sgs.Player_DrawPile,false)
	end,
}

thzhaoyuvs=sgs.CreateViewAsSkill{
	name="thzhaoyuvs",
	n=1,
	view_filter = function(self, selected, to_select)
		return true
	end,
	view_as = function(self, cards)
		if #cards~=1 then return end
		local card=thzhaoyucard:clone()
		card:addSubcard(cards[1])
		card:setSkillName("thzhaoyu")
		return card
	end,
	enabled_at_play=function(self, player)
		return false
	end,
	enabled_at_response=function(self,player,pattern) 
		return pattern=="@@thzhaoyu"
	end,
}

thzhaoyu=sgs.CreateTriggerSkill{
	name="thzhaoyu",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseStart},
	view_as_skill=thzhaoyuvs,
	on_trigger=function(self,event,player,data)
		if player:getPhase()~=sgs.Player_Start then return end
		local room=player:getRoom()
		local splayer=room:findPlayerBySkillName(self:objectName())
		if not splayer then return end
		if splayer:isKongcheng() then return end
		if not splayer:askForSkillInvoke(self:objectName()) then return end
		room:askForUseCard(splayer,"@@thzhaoyu","@thzhaoyu")
	end,
	can_trigger=function(self,target)
		return true
	end,
}

--[无忤] 锁定技，弃牌阶段结束时，若你在此阶段没有弃置手牌，你须弃置一张手牌。
thwuwu=sgs.CreateTriggerSkill{
	name="thwuwu",
	frequency=sgs.Skill_Compulsory,
	events={sgs.EventPhaseStart,sgs.EventPhaseEnd,sgs.CardDiscarded},
	priority = 1,
	on_trigger=function(self,event,player,data)
		if player:getMark("thrudao")>0 then return end
		local room=player:getRoom()
		if player:getPhase()~=sgs.Player_Discard then return end
		if event==sgs.EventPhaseStart then
			player:addMark("thwuwu")
			return
		end
		if event==sgs.EventPhaseEnd then
			if player:getMark("thwuwu")==0 then return end
			room:setPlayerMark(player,"thwuwu",0)
			if player:isKongcheng() then return end
			room:broadcastSkillInvoke(self:objectName())
			local log= sgs.LogMessage()
				log.type = "#TriggerSkill"
				log.from = player
				log.arg  = "thwuwu"
			room:sendLog(log)
			room:askForDiscard(player,"thwuwu",1,1,false,false)
			return
		end
		if event==sgs.CardDiscarded then
			room:setPlayerMark(player,"thwuwu",0)
			return
		end
	end,
}

--[入道] 觉醒技，回合开始阶段开始时，若你没有手牌，你须摸两张牌，然后减少3点体力上限，并失去技能“无忤”。
thrudao=sgs.CreateTriggerSkill{
	name="thrudao",
	frequency=sgs.Skill_Wake,
	events={sgs.EventPhaseStart},
	priority=0,
	on_trigger=function(self,event,player,data)
		if player:getMark(self:objectName())>0 then return end
		if player:getPhase()~=sgs.Player_Start then return end
		if not player:isKongcheng() then return end
		local room=player:getRoom()
		local log= sgs.LogMessage()
			log.type = "#thrudao"
			log.from = player
			log.arg  = self:objectName()
		room:sendLog(log)
		room:broadcastSkillInvoke(self:objectName())
		room:getThread():delay()
		player:drawCards(2)
		room:loseMaxHp(player,3)
		room:detachSkillFromPlayer(player,"thwuwu")
		player:addMark(self:objectName())
	end,
}

----hana018
--[六震] 出牌阶段，你使用【杀】指定目标后，可以选择任意名你攻击范围内的不为该【杀】目标的其他角色。该【杀】在结算后置入弃牌堆，你获得之并对你所选的角色使用，其中每有一名角色使用【闪】抵消了该【杀】的效果，你须弃置两张牌或失去1点体力。每阶段限一次。
thliuzhencard=sgs.CreateSkillCard{
	name="thliuzhencard",
	target_fixed=false,
	filter=function(self, targets, to_select, player)
		return to_select:objectName()~=player:objectName() and (not to_select:hasFlag("liuzhenold")) and player:inMyAttackRange(to_select)
	end,
	on_use=function(self, room, source, targets)
		for i=1,#targets,1 do
			room:setPlayerFlag(targets[i],"liuzhennew")
		end
	end,
}

thliuzhenvs=sgs.CreateViewAsSkill{
	name="thliuzhenvs",
	n=0,
	view_as=function(self, cards)
		local LZcard=thliuzhencard:clone()
		LZcard:setSkillName("thliuzhen")
		return LZcard
	end,
	enabled_at_play=function(self, player)
		return false
	end,
	enabled_at_response=function(self,player,pattern) 
		return pattern=="@@thliuzhen"
	end,
}

thliuzhen=sgs.CreateTriggerSkill{
	name="thliuzhen",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.CardUsed,sgs.CardFinished},
	view_as_skill=thliuzhenvs,
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local use=data:toCardUse()
		if event==sgs.CardFinished then 
			if not use.card:isKindOf("Slash") then return end
			if not player:hasFlag("liuzhenuse") then return end
			room:setPlayerFlag(player,"-liuzhenuse")
			if use.card:getEffectiveId()~=-1 and room:getCardPlace(use.card:getEffectiveId()) == sgs.Player_DiscardPile then
				player:obtainCard(use.card)
				local newuse=sgs.CardUseStruct()
        			newuse.card=use.card
        			newuse.from=player
					for _,tar in sgs.qlist(room:getAllPlayers()) do
        				if tar:hasFlag("liuzhennew") then
							newuse.to:append(tar)
						end
					end
				room:useCard(newuse,false)
			end
			for _,tar in sgs.qlist(room:getAllPlayers()) do
				if tar:hasFlag("liuzhennew") then
					room:setPlayerFlag(tar,"-liuzhennew")
				end
			end
			return 
		end
		if player:getPhase()~=sgs.Player_Play then return end
		if not use.card:isKindOf("Slash") then return end
		if player:hasUsed("#thliuzhencard") then return end
		for _,tar in sgs.qlist(use.to) do
			room:setPlayerFlag(tar,"liuzhenold")
		end
		if room:askForUseCard(player,"@@thliuzhen","@thliuzhen") then room:setPlayerFlag(player,"liuzhenuse") end
		for _,tar in sgs.qlist(use.to) do
			room:setPlayerFlag(tar,"-liuzhenold")
		end
	end,
}

thliuzhen_buff=sgs.CreateTriggerSkill{
	name="#thliuzhen_buff",
	frequency=sgs.Skill_Compulsory,
	events={sgs.CardUsed},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local card=data:toCardUse().card
		if not card:isKindOf("Jink") then return end
		local splayer=room:findPlayerBySkillName("thliuzhen")
		if player:hasFlag("liuzhennew") then
			local log= sgs.LogMessage()
				log.type = "#thliuzhentr"
				log.from = splayer
				log.to:append(player)
				log.arg  = "thliuzhen"
			room:sendLog(log)
			if splayer:getCardCount(true)>1 then
				if not room:askForDiscard(splayer,"thliuzhen",2,2,true,true) then
					room:loseHp(splayer)
				end
			else
				room:loseHp(splayer)
			end
		end
	end,
	can_trigger=function(self,target)
		return true
	end,
}

--[天道] 主公技，当你处于濒死状态时，其他花势力的角色可以将黑桃2~9的手牌当【桃】使用。
thtiandaocard=sgs.CreateSkillCard{
	name="thtiandaocard",
	target_fixed=true,
	on_use=function(self, room, source, targets)
		local target=room:getLord()
		local card=sgs.Sanguosha:getCard(self:getSubcards():first())
		local newcard=sgs.Sanguosha:cloneCard("peach",card:getSuit(),card:getNumber())
		newcard:addSubcard(card)
		newcard:setSkillName("thtiandao")
		local use=sgs.CardUseStruct()
        	use.card=newcard
        	use.from=source
        	use.to:append(target)
		room:useCard(use,true)
	end,
}

thtiandaovs=sgs.CreateViewAsSkill{
	name="thtiandaovs",
	n=1,
	view_filter=function(self, selected, to_select)
		return not to_select:isEquipped() and to_select:getSuit()==sgs.Card_Spade and to_select:getNumber()>1 and to_select:getNumber()<10
	end,
	view_as=function(self, cards)
		if #cards~=1 then return end
		local TDcard=thtiandaocard:clone()
		TDcard:addSubcard(cards[1])
		TDcard:setSkillName("thtiandao")
		return TDcard
	end,
	enabled_at_play=function(self, player)
		return false
	end,
	enabled_at_response=function(self,player,pattern) 
		return pattern=="@@thtiandao"
	end,
}

thtiandao=sgs.CreateTriggerSkill{
	name="thtiandao$",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.GameStart,sgs.AskForPeaches},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if event==sgs.GameStart then
			if player:hasLordSkill("thtiandao") then
				for _,p in sgs.qlist(room:getOtherPlayers(player)) do
					room:attachSkillToPlayer(p,"thtiandaovs")
				end
			end
			return
		end
		local splayer=room:getLord()
		local dying=data:toDying()
		if dying.who:objectName()~=splayer:objectName() then return end
		if player:getKingdom()~="wei" then return end
		if not player:hasSkill("thtiandaovs") then return end
		room:askForUseCard(player,"@@thtiandao","@thtiandao")
	end,
	can_trigger=function(self,target)
		return true
	end,
}

----yuki001
--[缄魔] 其他角色的出牌阶段开始时，若其手牌数不小于体力上限，你可以令其选择一项：摸一张牌，且此阶段不能使用或打出【杀】；或此阶段使用【杀】指定目标时须弃置一张牌，否则此【杀】无效。
thjianmo=sgs.CreateTriggerSkill{
	name="thjianmo",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseStart},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:hasFlag("tianyi_failed") then
			room:setPlayerFlag(player,"-tianyi_failed")
		end
		if player:hasFlag("jianmodis") then
			room:setPlayerFlag(player,"-jianmodis")
		end
		local splayer=room:findPlayerBySkillName(self:objectName())
		if not splayer then return end
		if player:getPhase()~=sgs.Player_Play then return end
		if player:objectName()==splayer:objectName() then return end
		if player:getHandcardNum()<player:getMaxHp() then return end
		if not splayer:askForSkillInvoke(self:objectName()) then return end
		local log= sgs.LogMessage()
		if room:askForChoice(player,self:objectName(),"jmget+jmdis")=="jmget" then
				log.type = "#thjianmochoose1"
				log.from = player
				log.arg  = "1"
			room:sendLog(log)
			player:drawCards(1)
			room:setPlayerFlag(player,"tianyi_failed")
		else
				log.type = "#thjianmochoose2"
				log.from = player
				log.arg  = "2"
			room:sendLog(log)
			room:setPlayerFlag(player,"jianmodis")
		end
	end,
	can_trigger=function(self,target)
		return true
	end,
}

thjianmo_buff=sgs.CreateTriggerSkill{
	name="#thjianmo_buff",
	frequency=sgs.Skill_Compulsory,
	events={sgs.CardUsed},
	on_trigger=function(self,event,player,data)
		local use=data:toCardUse()
		local room=player:getRoom()
		if not player:hasFlag("jianmodis") then return end
		if not use.card:isKindOf("Slash") then return end
		if (use.card:subcardsLength()~=0 or use.card:getEffectiveId()~=-1) then
			room:moveCardTo(use.card,nil,sgs.Player_DiscardPile,true)
		end
		local log= sgs.LogMessage()
			log.type = "#thjianmotr"
			log.from = room:findPlayerBySkillName("thjianmo")
			log.to:append(player)
			log.arg  = "thjianmo"
		room:sendLog(log)
		if player:isNude() then return true end
		if room:askForDiscard(player,"thjianmo",1,1,true,true) then return end
		return true
	end,
	can_trigger=function(self,target)
		return true
	end,
}

--[二重] 觉醒技，回合开始阶段开始时，若你的体力值不大于2，你须弃置两张牌，并减少1点体力上限，然后获得技能“幻法”和“祝祭”。
therchong=sgs.CreateTriggerSkill{
	name="therchong",
	frequency=sgs.Skill_Wake,
	events={sgs.EventPhaseStart},	
	on_trigger=function(self,event,player,data)
		if player:getMark(self:objectName())>0 then return end
		if player:getPhase()~=sgs.Player_Start then return end
		if player:getHp()>2 then return end
		local room=player:getRoom()
		local log= sgs.LogMessage()
			log.type = "#therchong"
			log.from = player
			log.arg  = self:objectName()
			log.arg2 = player:getHp()
		room:sendLog(log)
		room:getThread():delay()
		local x=math.min(player:getCardCount(true),2)
		room:askForDiscard(player,self:objectName(),x,x,false,true)
		room:loseMaxHp(player)
		room:acquireSkill(player,"nosxuanhuo")
		room:acquireSkill(player,"yicong")
		player:addMark(self:objectName())
	end,
}

--[春度] 主公技，每当其他雪势力角色使用一张红桃基本牌时，可以令你观看牌堆顶的一张牌，然后你须将此牌交给一名其他角色或置入弃牌堆。
thchundu=sgs.CreateTriggerSkill{
	name="thchundu$",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.CardUsed},	
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local use=data:toCardUse()
		if player:getKingdom()~="wu" then return end
		if not (use.card:isKindOf("BasicCard") and use.card:getSuit()==sgs.Card_Heart) then return end
		room:moveCardTo(use.card,nil,sgs.Player_DiscardPile,true)
		local card,target
		for _,p in sgs.qlist(room:getAlivePlayers()) do
			if p:objectName()~=player:objectName() and p:hasLordSkill(self:objectName()) then
				if player:askForSkillInvoke(self:objectName()) then
					card=room:peek()
					p:drawCards(1)
					if room:askForChoice(p,self:objectName(),"cdgive+cddis")=="cdgive" then
						target=room:askForPlayerChosen(p,room:getOtherPlayers(p),"thchundu")
						room:moveCardTo(card,target,sgs.Player_PlaceHand,false)
					else
						room:moveCardTo(card,nil,sgs.Player_DiscardPile,true)
					end
				end
			end
		end
	end,
	can_trigger=function(self,target)
		return true
	end,
}

----yuki002
--[萃梦] 回合开始阶段开始时，你可以进行一次判定，若结果为红色，你获得此牌，你可以重复此流程，直到出现黑色的判定结果为止。 
thcuimeng=sgs.CreateTriggerSkill{
	name="thcuimeng",
	frequency=sgs.Skill_Frequent,
	events={sgs.EventPhaseStart, sgs.FinishJudge},
	on_trigger=function(self, event, player, data)
		local judge
		if(event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Start) then
			local room=player:getRoom()
			while(room:askForSkillInvoke(player,self:objectName())) do
				judge=sgs.JudgeStruct()
				judge.pattern=sgs.QRegExp("(.*):(heart|diamond):(.*)")
				judge.good=true
				judge.reason=self:objectName()
				judge.who=player
				room:judge(judge)
				if(judge:isBad()) then break end
			end
		end
		if(event == sgs.FinishJudge) then
			judge=data:toJudge()
			if(judge.reason == self:objectName()) then
				if(judge.card:isRed()) then
					player:obtainCard(judge.card)
					return true
				end
			end
		end
	end
}

--[醉梦] 锁定技，你的红桃的基本牌均视为【酒】。当你使用一张【酒】时，你摸一张牌。 
thzuimeng=sgs.CreateFilterSkill{
	name="thzuimeng",
	view_filter=function(self,to_select)
		return to_select:isKindOf("BasicCard") and to_select:getSuit()==sgs.Card_Heart
	end,
	view_as=function(self,card)
		local jiu = sgs.Sanguosha:cloneCard("analeptic",card:getSuit(),card:getNumber())
        jiu:setSkillName(self:objectName())
        local card=sgs.Sanguosha:getWrappedCard(card:getId())
        card:takeOver(jiu)
        return card
	end
}

thzuimengtr=sgs.CreateTriggerSkill{
	name="#thzuimengtr",
	frequency=sgs.Skill_Compulsory,
	events={sgs.CardUsed},
	on_trigger=function(self,event,player,data)
		local use=data:toCardUse()
		local room=player:getRoom()
		if use.card:isKindOf("Analeptic") then
			local log= sgs.LogMessage()
				log.type = "#TriggerSkill"
				log.from = player
				log.arg  = "thzuimeng"
			room:sendLog(log)
			player:drawCards(1)
		end
	end,
}

--[濛雾] 锁定技，若你已受伤，你的手牌上限+1。
thmengwu=sgs.CreateMaxCardsSkill{
	name="thmengwu",
	extra_func=function(self,target)
		if not target:hasSkill(self:objectName()) then return 0 end
		if target:isWounded() then
			return 1
		else
			return 0
		end
	end
}

----yuki003
--[慈航] 当你使用的【杀】被目标角色的【闪】抵消时，你可令此【杀】依然造成伤害，若如此做，你须选择一项：弃置等同于目标角色已损失的体力值数量的牌（不足则全弃）；或令目标角色摸等同于其体力值数量的牌（至多摸五张）。
thcihang=sgs.CreateTriggerSkill{
	name="thcihang",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.SlashMissed},
	
	on_trigger=function(self,event,player,data)
		local effect=data:toSlashEffect()

        local room=player:getRoom()
        if(room:askForSkillInvoke(player,self:objectName(), data)) then
			room:broadcastSkillInvoke(self:objectName())
            room:slashResult(effect, nil)
			if effect.to:isDead() then return end
            if(room:askForChoice(player, self:objectName(), "chdis+chdra") == "chdis") then
				if effect.to:getLostHp()==0 then return end
				local n=math.min(player:getCardCount(true),effect.to:getLostHp())
				room:askForDiscard(player, self:objectName(), n, n, false, true)
            else
				local x
				if effect.to:getHp()>5 then
					x=5
				else
					x=effect.to:getHp()
				end
				if x==0 then return end
                effect.to:drawCards(x)
			end
		end
        return false
	end,
}

----yuki004
--[战操] 你的回合外，当你攻击范围内的一名角色成为【杀】的目标时，你可选择一项使该【杀】对目标角色无效：失去1点体力且该【杀】在结算后置入弃牌堆时，你获得之；或弃置你装备区内的一张防具牌或坐骑牌。 
thzhancao=sgs.CreateTriggerSkill{
	name="thzhancao",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.SlashEffected,sgs.CardFinished},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local splayer=room:findPlayerBySkillName(self:objectName())
		if not splayer then return end
		if event==sgs.CardFinished then
			local use=data:toCardUse()
			if not use.card:isKindOf("Slash") then return end
			if not splayer:hasFlag("thzhancao") then return end
			room:setPlayerFlag(splayer,"-thzhancao")
			if use.card:getEffectiveId()~=-1 and room:getCardPlace(use.card:getEffectiveId()) == sgs.Player_DiscardPile then
				local log= sgs.LogMessage()
					log.type = "#thzhancao"
					log.from = player
					log.arg  = self:objectName()
				room:sendLog(log)
				splayer:obtainCard(use.card)
			end
			return 
		end
		if splayer:getPhase()~=sgs.Player_NotActive then return end
		local effect=data:toSlashEffect()
		if effect.slash:getEffectiveId()==-1 then return end
		if not splayer:inMyAttackRange(player) then return end
		if not splayer:askForSkillInvoke(self:objectName()) then return end
		if not room:askForCard(splayer,"Horse,Armor|.|.|equipped","@thzhancao",data,sgs.CardDiscarded) then
			room:loseHp(splayer)
			room:setPlayerFlag(splayer,"thzhancao")
		end
		return true
	end,
	can_trigger=function(self,target)
		return true
	end,
}

----yuki005
--[缘起] 出牌阶段，你可以进行一次判定，然后将一张与该判定牌颜色相同的手牌交给一名其他角色，该角色须选择一项：1.摸一张牌，然后失去1点体力 2.弃置这张牌，并令你获得其一张牌 每阶段限一次。
thyuanqicard=sgs.CreateSkillCard{
	name="thyuanqicard",
	target_fixed=true,
	on_use=function(self, room, source, targets)
		local judge=sgs.JudgeStruct()
			judge.pattern=sgs.QRegExp("(.*):(.*):(.*)")
			judge.good=true
			judge.reason="thyuanqi"
			judge.who=source
		room:judge(judge)
		local red=judge.card:isRed()
		local cards=source:getHandcards()
		local card_ids=sgs.IntList()
		for _,card in sgs.qlist(cards) do
			if card:isRed()==red then
				card_ids:append(card:getId())
			end
		end
		if card_ids:isEmpty() then return end
		room:fillAG(card_ids,source)
		local card_id=room:askForAG(source,card_ids,false,"thyuanqi")
		source:invoke("clearAG")
		local target=room:askForPlayerChosen(source,room:getOtherPlayers(source),"thyuanqi")
		local log= sgs.LogMessage()
			log.type = "#thyuanqi"
			log.from = player
			log.to:append(target)
			log.card_str = tonumber(card_id)
		room:sendLog(log)
		room:moveCardTo(sgs.Sanguosha:getCard(card_id),target,sgs.Player_PlaceHand,true)
		local choice=room:askForChoice(target,"thyuanqi","yqdra+yqdis")
		if choice=="yqdra" then
			target:drawCards(1)
			room:loseHp(target)
		else
			room:throwCard(sgs.Sanguosha:getCard(card_id),target)
			if target:isNude() then return end
			card_id=room:askForCardChosen(source,target,"he","thyuanqi")
			source:obtainCard(sgs.Sanguosha:getCard(card_id))
		end
	end,
}

thyuanqi=sgs.CreateViewAsSkill{
	name="thyuanqi",
	view_as=function(self, cards)
		local YQcard=thyuanqicard:clone()
		YQcard:setSkillName("thyuanqi")
		return YQcard
	end,
	enabled_at_play=function(self, player)
		return not player:hasUsed("#thyuanqicard")
	end,
}

--[墨迹] 若你的装备区没有防具牌，每当你需要使用一张【闪】响应一名角色对你使用的【杀】时，你可以进行一次判定：若结果与该【杀】的颜色相同，则视为你使用了一张【闪】。 
thmoji=sgs.CreateTriggerSkill{
	name="thmoji",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.SlashEffected,sgs.CardFinished,sgs.CardAsked},	
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local splayer=room:findPlayerBySkillName(self:objectName())
		if not splayer then return end
		if event==sgs.SlashEffected then
			local effect=data:toSlashEffect()
			local slash=effect.slash
			if effect.to:objectName()~=splayer:objectName() then return end
			splayer:addMark("thmojican")
			if slash:isRed() then
				splayer:setMark("mojisuit",1)
			elseif slash:isBlack() then
				splayer:setMark("mojisuit",2)
			end
			return
		end
		if event==sgs.CardFinished then
			local use=data:toCardUse()
			if not use.card:isKindOf("Slash") then return end
			splayer:setMark("thmojican",0)
			splayer:setMark("mojisuit",0)
		end
		if event==sgs.CardAsked then
			if player:objectName()~=splayer:objectName() then return end
			if player:getMark("thmojican")==0 then return end
			if player:getArmor() then return end
			if data:toString()~="jink" then return false end
			if not room:askForSkillInvoke(player, self:objectName()) then return end
			local judge=sgs.JudgeStruct()
				judge.pattern=sgs.QRegExp("(.*):(.*):(.*)")
				judge.good=true
				judge.reason=self:objectName()
				judge.who=player
			room:judge(judge)
			local can=false
			if player:getMark("mojisuit")==1 then
				can=judge.card:isRed()
			elseif player:getMark("mojisuit")==2 then
				can=judge.card:isBlack()
			end
			if can then 
				room:setEmotion(player,"good")
			else
				room:setEmotion(player,"bad")
				return 
			end
			local jink_card=sgs.Sanguosha:cloneCard("jink",sgs.Card_NoSuit,0)
			jink_card:setSkillName(self:objectName())
			room:provide(jink_card)	
			return true
		end
	end,
	can_trigger=function(self,target)
		return true
	end,
}

----yuki008
--[垂迹] 你的回合外，每当失去牌时，若你的手牌数不大于你的体力上限，可指定一名角色并令其进行一次判定，若为红色，该角色回复1点体力。
thchuiji=sgs.CreateTriggerSkill{
	name="thchuiji",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.CardsMoveOneTime},
	on_trigger=function(self,event,player,data)
		local room = player:getRoom()
		if player:getPhase()~=sgs.Player_NotActive then return end
		if player:getHandcardNum()>player:getMaxHp() then return end
		local move = data:toMoveOneTime()
		if not move.from or move.from:objectName()~=player:objectName() then return end
		local invoke=false
		for i=0,(move.from_places):length()-1,1 do
			if ((move.from_places):at(i) == sgs.Player_PlaceHand or (move.from_places):at(i) == sgs.Player_PlaceEquip) then
				invoke=true
				break
			end
		end
		if invoke then
			if not player:askForSkillInvoke(self:objectName(),data) then return end
			local target=room:askForPlayerChosen(player,room:getAllPlayers(),self:objectName())
			local judge=sgs.JudgeStruct()
				judge.pattern = sgs.QRegExp("(.*):(heart|diamond):(.*)")
				judge.good=true
				judge.reason=self:objectName()
				judge.who=target
			room:judge(judge)
			if judge:isGood() then
				room:setEmotion(player,"good")
			else
				room:setEmotion(player,"bad")
				return 
			end
			local recover = sgs.RecoverStruct()
				recover.who = player
			room:recover(target, recover)
		end
	end,
}

--[紫云] 锁定技，你不能成为【兵粮寸断】的目标。
thziyun=sgs.CreateProhibitSkill{
	name="thziyun",
	is_prohibited=function(self,from,to,card)
    	if (to:hasSkill(self:objectName())) then
        	return card:isKindOf("SupplyShortage")
    	end
	end,
}

----yuki017
--[溟灵] 锁定技，防止你受到的火焰伤害，你每次受到的雷电伤害+1。
thmingling=sgs.CreateTriggerSkill{
	name="thmingling",
	frequency=sgs.Skill_Compulsory,
	events={sgs.DamageInflicted},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local damage=data:toDamage()
		local log= sgs.LogMessage()
			log.type = "#TriggerSkill"
			log.from = player
			log.arg  = self:objectName()
		if damage.nature==sgs.DamageStruct_Thunder then
			room:sendLog(log)
			damage.damage=damage.damage+1
			data:setValue(damage)
		elseif damage.nature==sgs.DamageStruct_Fire then
			room:sendLog(log)
			return true
		end
	end,
}

--[水难] 出牌阶段，你可以失去1点体力并令你攻击范围内的一名其他角色获得1枚“溺水”标记，每阶段限一次。其他角色每拥有1枚“溺水”标记，其手牌上限-1。其他角色的回合结束阶段开始时，若其拥有1枚或更多的“溺水”标记，须进行一次判定，若为红色，弃置全部的“溺水”标记；若为黑色，获得1枚“溺水”标记。
thshuinancard=sgs.CreateSkillCard{
	name="thshuinancard",
	target_fixed=false,
	filter=function(self, targets, to_select, player)
		return player:inMyAttackRange(to_select) and to_select:objectName()~=player:objectName() and #targets==0
	end,
	on_use=function(self, room, source, targets)
		targets[1]:gainMark("@nishui")
		room:loseHp(source)
	end,
}

thshuinanvs=sgs.CreateViewAsSkill{
	name="thshuinanvs",
	view_as=function(self, cards)
		local SNcard=thshuinancard:clone()
		SNcard:setSkillName("thshuinan")
		return SNcard
	end,
	enabled_at_play=function(self, player)
		return not player:hasUsed("#thshuinancard")
	end,
}

thshuinan=sgs.CreateTriggerSkill{
	name="thshuinan",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseStart},
	view_as_skill=thshuinanvs,
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:getPhase()==sgs.Player_Finish then
			if player:getMark("@nishui")<1 then return end
			local log= sgs.LogMessage()
				log.type = "#thshuinan"
				log.from = player
				log.arg  = "@nishui"
			room:sendLog(log)
			local judge=sgs.JudgeStruct()
				judge.pattern=sgs.QRegExp("(.*):(heart|diamond):(.*)")
				judge.good=true
				judge.reason=self:objectName()
				judge.who=player
			room:judge(judge)
			if judge:isGood() then
				room:setEmotion(player,"good")
				player:loseAllMarks("@nishui")
			else
				room:setEmotion(player,"bad")
				player:gainMark("@nishui")
			end
		end
	end,
	can_trigger=function(self,target)
		return true
	end,
}

thshuinan_buff=sgs.CreateMaxCardsSkill{
	name="thshuinan_buff",
	extra_func=function(self,target)
		if target:getMark("@nishui")<=0 then return 0 end
		return -target:getMark("@nishui")
	end,
}

----yuki018
--[灵蝶] 出牌阶段，你可以弃置一张牌并选择一名角色，该角色可观看另一名角色的手牌，每阶段限一次。
thlingdiecard=sgs.CreateSkillCard{
	name="thlingdiecard",
	target_fixed=false,
	filter=function(self, targets, to_select, player)
		return #targets==0
	end,	
	on_use=function(self, room, source, targets)
		local target=room:askForPlayerChosen(targets[1],room:getOtherPlayers(targets[1]),"thlingdie")
		local log= sgs.LogMessage()
			log.type = "#thlingdie"
			log.from = targets[1]
			log.to:append(target)
		room:sendLog(log)
		room:showAllCards(target,targets[1])
	end,
}

thlingdie=sgs.CreateViewAsSkill{
	name="thlingdie",
	n=1,
	view_filter=function(self, selected, to_select)
		return true
	end,
	view_as=function(self, cards)
		if #cards~= 1 then return end
		local LDcard=thlingdiecard:clone()
		LDcard:addSubcard(cards[1])
		LDcard:setSkillName(self:objectName())
		return LDcard
	end,
	enabled_at_play=function(self, player)
		return not player:hasUsed("#thlingdiecard")
	end,
}

--[无寿] 每当你受到伤害时，你可以将你的手牌补至四张。
thwushou=sgs.CreateTriggerSkill{
	name="thwushou",
	frequency=sgs.Skill_Frequent,
	events={sgs.DamageInflicted},
	on_trigger=function(self,event,player,data)
		if player:getHandcardNum()>=4 then return end
		if not player:askForSkillInvoke(self:objectName()) then return end
		player:drawCards(4-player:getHandcardNum())
	end,
}

--[浮月] 主公技，其他雪势力角色的出牌阶段，若你已受伤，可与你拼点，若该角色没有赢，你回复1点体力，每阶段限一次。
thfuyuecard=sgs.CreateSkillCard{
	name="thfuyuecard",
	will_throw=false,
	filter=function(self, targets, to_select, player)
		return to_select:hasLordSkill("thfuyue") and to_select:isWounded() and to_select:objectName()~=player:objectName() and not to_select:isKongcheng()
	end,
	on_use=function(self, room, source, targets)
		local splayer=room:getLord()
		local win=source:pindian(splayer,self:objectName(),sgs.Sanguosha:getCard(self:getEffectiveId()))
		if win then return end
		local recover=sgs.RecoverStruct()
			recover.recover=1
			recover.card=nil
			recover.who=source
		room:recover(splayer, recover)
	end,
}

thfuyuevs=sgs.CreateViewAsSkill{
	name="thfuyuevs",
	n=1,
	view_filter=function(self, selected, to_select)
		return not to_select:isEquipped()
	end,
	view_as=function(self, cards)
		if #cards~=1 then return end
		local FYcard=thfuyuecard:clone()
		FYcard:addSubcard(cards[1])
		FYcard:setSkillName("thfuyue")
		return FYcard
	end,
	enabled_at_play=function(self, player)
		return (not player:hasUsed("#thfuyuecard")) and player:getKingdom() == "wu"
	end,
}

thfuyue=sgs.CreateTriggerSkill{
	name="thfuyue$",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.GameStart},	
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:hasLordSkill("thfuyue") then
			for _,p in sgs.qlist(room:getOtherPlayers(player)) do
				room:attachSkillToPlayer(p,"thfuyuevs")
			end
		end
	end,
}

----tsuki001
--[锁命] 每当你受到1点伤害后，你可以指定一名角色，横置或重置其武将牌。
thsuoming=sgs.CreateTriggerSkill{
	name="thsuoming",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.Damaged},	
	on_trigger=function(self,event,player,data)
		if not player:askForSkillInvoke(self:objectName()) then return end
		local damage=data:toDamage().damage
		local room=player:getRoom()
		local target
		local log= sgs.LogMessage()
			log.type = "#thnishang"
			log.from = player
		for i=1,damage,1 do
			target=room:askForPlayerChosen(player,room:getAllPlayers(),self:objectName())
				log.to:append(target)
				if target:isChained() then
					log.arg  = "chongzhi"
				else
					log.arg  = "hengzhi"
				end
			room:sendLog(log)
			room:setPlayerProperty(target,"chained",sgs.QVariant(not target:isChained()))
		end
	end,
}

--[浓雾] 锁定技，当你的武将牌横置时，普通【杀】对你无效。
thnongwu=sgs.CreateTriggerSkill{
	name="thnongwu",
	frequency=sgs.Skill_Compulsory,
	events={sgs.SlashEffected},	
	on_trigger=function(self,event,player,data)
		if not player:isChained() then return end
		local effect=data:toSlashEffect()
		if effect.nature == sgs.DamageStruct_Normal then
			local log= sgs.LogMessage()
				log.from = player
				log.to:append(effect.from)
				log.type = "#thnongwu"
				log.arg  = self:objectName()
				log.arg2 = effect.slash:objectName()
			player:getRoom():sendLog(log)
			return true
		end
	end,
}

--[夜王] 主公技，若场上没有角色的武将牌横置，其他月势力角色可以在各自的出牌阶段将你的武将牌横置，每阶段限一次。
thyewangcard=sgs.CreateSkillCard{
	name="thyewangcard",
	target_fixed=true,
	will_throw=false,
	on_use = function(self, room, source, targets)
		local invoke=true
		for _,p in sgs.qlist(room:getAllPlayers()) do
			if p:isChained() then
				invoke=false
				break
			end
		end
		local lords=sgs.SPlayerList()
		local target
		local log= sgs.LogMessage()
		if invoke then
			for _,p in sgs.qlist(room:getAllPlayers()) do
				if p:hasLordSkill("thyewang") then
					targets:append(p)
				end
			end
			if targets:isEmpty() then return end
			target=room:askForPlayerChosen(source,lords,"thyewang")
				log.type = "#thyewang"
				log.from = player
				log.to:append(target)
				log.arg  = "hengzhi"
			room:sendLog(log)
			room:setPlayerProperty(target,"chained",sgs.QVariant(true))
		else
				log.type = "#thyewangfail"
				log.from = player
			room:sendLog(log)
		end
	end,
}

thyewangvs=sgs.CreateViewAsSkill{
	name="thyewangvs",
	n=0,
	enabled_at_play=function(self, player)
		return not player:hasUsed("#thyewangcard") and player:getKingdom() == "qun"
	end,
}

thyewang=sgs.CreateTriggerSkill{
	name="thyewang$",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.GameStart},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:hasLordSkill("thyewang") then
			for _,p in sgs.qlist(room:getOtherPlayers(player)) do
				room:attachSkillToPlayer(p,"thyewangvs")
			end
		end
	end,
}

----tsuki003
--[狂气] 出牌阶段，当你使用【杀】或【决斗】对目标角色造成伤害时，你可以弃置一张【桃】、【酒】或防具牌，则此伤害+1。
thkuangqi=sgs.CreateTriggerSkill{
	name="thkuangqi",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.DamageCaused},
	on_trigger=function(self,event,player,data)
		if player:getPhase()~=sgs.Player_Play then return end
		local damage=data:toDamage()
		if not damage.card or not (damage.card:isKindOf("Slash") or damage.card:isKindOf("Duel")) then return end
		if not player:askForSkillInvoke(self:objectName()) then return end
		local room=player:getRoom()
		local card=room:askForCard(player,"Peach,Analeptic,Armor","@thkuangqi",data,sgs.CardDiscarded)
		if not card then return end
		local log= sgs.LogMessage()
			log.type = "#thkuangqi"
			log.from = player
			log.to:append(damage.to)
			log.arg  = tonumber(damage.damage)
			log.arg2 = tonumber(damage.damage+1)
		room:sendLog(log)
		damage.damage=damage.damage+1
		data:setValue(damage)
	end,
}

----tsuki004
--[开运] 在一名角色的判定牌生效前，你可以弃置一张牌，然后观看牌堆顶的两张牌，将其中一张牌代替判定牌，然后获得另一张牌。
thkaiyun=sgs.CreateTriggerSkill{
	name="thkaiyun",
	events={sgs.AskForRetrial},
	on_trigger=function(self, event, player, data)
		local room=player:getRoom()
		local tuzi=room:findPlayerBySkillName(self:objectName())
		local judge=data:toJudge() 
		if tuzi:isNude() then return end
		if (room:askForSkillInvoke(tuzi, self:objectName(),data) ~= true) then return false end
		if not room:askForDiscard(player,self:objectName(),1,1,true,true) then return false end 
		local card_ids=room:getNCards(2)
		room:fillAG(card_ids,player)
		card_id=room:askForAG(player, card_ids, false, self:objectName())
		card_ids:removeOne(card_id)
		player:invoke("clearAG")
		room:retrial(sgs.Sanguosha:getCard(card_id), player, judge, self:objectName(), false)
		room:moveCardTo(sgs.Sanguosha:getCard(card_ids:first()), player, sgs.Player_PlaceHand, false)
	end,
}

--[狡兔] 每当你受到1点伤害后，可以令伤害来源进行一次判定，若结果不为红桃，该角色获得技能“无谋”直到该角色的下一个回合结束。
thjiaotu=sgs.CreateTriggerSkill{
	name="thjiaotu",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.Damaged,sgs.EventPhaseStart},
	
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local tuzi=room:findPlayerBySkillName(self:objectName())
		if event==sgs.Damaged then 
			local damage=data:toDamage()
			local judge 
			if damage.to:objectName()~=tuzi:objectName() then return end
			if not damage.from then return end
			for i=1,damage.damage,1 do
				if tuzi:isNude() then break end
				if not room:askForSkillInvoke(tuzi,self:objectName(),data) then break end
				judge=sgs.JudgeStruct()
					judge.pattern=sgs.QRegExp("(.*):(heart):(.*)")
					judge.good=true
					judge.reason=self:objectName()
					judge.who=damage.from
				room:judge(judge)
				if judge:isBad() then
					if not damage.from:hasSkill("wumou") then
						room:setPlayerFlag(judge.who,"thjiaotu")
						judge.who:gainMark("@jiaotu")
						room:acquireSkill(judge.who,"wumou")
					end
				end
			end
			return false
		elseif player:getPhase()==sgs.Player_NotActive then
			if player:hasFlag("thjiaotu") then 
				room:setPlayerFlag(player,"-thjiaotu")
			elseif player:getMark("@jiaotu")~=0 then 
				player:loseAllMarks("@jiaotu")
				room:detachSkillFromPlayer(player,"wumou")
			end
		end
	end,
	
	can_trigger=function(self,target)
		return true
	end,
}

----tsuki007
--[寸劲] 若你的装备区没有武器牌，当你使用的【杀】被【闪】抵消时，你可以弃置一张牌，则此【杀】依然造成伤害。 
thcunjing=sgs.CreateTriggerSkill{
	name="thcunjing",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.SlashMissed},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local effect=data:toSlashEffect()
		if player:getWeapon() then return end
		if not player:askForSkillInvoke(self:objectName(),data) then return end
		if not room:askForDiscard(player,self:objectName(),1,true,true) then return end
		room:slashResult(effect, nil)
	end,
}

--[莲华] 出牌阶段，你可弃置一张装备牌，然后观看牌堆顶的一张牌并将其交给一名角色。
thlianhuacard=sgs.CreateSkillCard{
	name="thlianhuacard",
	target_fixed=true,
	will_throw=true,
	on_use=function(self, room, source, targets)
		local card=room:peek()
		source:drawCards(1)
		local target=room:askForPlayerChosen(source,room:getAllPlayers(),"thlianhua")
		room:moveCardTo(card,target,sgs.Player_PlaceHand,false)
	end,
}

thlianhua=sgs.CreateViewAsSkill{
	name="thlianhua",
	n=1,
	view_filter=function(self, selected, to_select)
		return to_select:isKindOf("EquipCard")
	end,
	view_as=function(self, cards)
		if #cards==0 then return end
		local LHcard=thlianhuacard:clone()
		LHcard:addSubcard(cards[1])
		LHcard:setSkillName(self:objectName())
		return LHcard
	end,
}

----tsuki008
--[奇术] 其他角色的回合结束后，若你的武将牌背面朝上，你可将你的武将牌翻面并获得1枚“时计”标记，然后进行一个额外的回合。
thqishu=sgs.CreateTriggerSkill{
	name="thqishu",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseStart},	
	on_trigger=function(self,event,player,data)
		if player:getPhase()~=sgs.Player_NotActive then return end
		local room=player:getRoom()
		local splayer=room:findPlayerBySkillName(self:objectName())
		if not splayer then return end
		if splayer:faceUp() then return end
		if player:objectName()==splayer:objectName() then return end
		if not splayer:askForSkillInvoke(self:objectName()) then return end
		room:broadcastSkillInvoke(self:objectName())
		splayer:turnOver()
		splayer:gainMark("@shiji")
		splayer:gainAnExtraTurn(player)
	end,
	can_trigger=function(self,target)
		return true
	end,
}

--[时停] 回合开始阶段开始时，若你没有“时计”标记，你可以将你的武将牌翻面并将你的手牌补至等同于你体力上限的张数，然后跳过你此回合的判定阶段、摸牌阶段、出牌阶段和弃牌阶段。
thshiting=sgs.CreateTriggerSkill{
	name="thshiting",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseStart},
	on_trigger=function(self,event,player,data)
		if player:getPhase()~=sgs.Player_Start then return end
		if player:getMark("@shiji")>0 then return end
		if not player:askForSkillInvoke(self:objectName()) then return end
		player:getRoom():broadcastSkillInvoke(self:objectName())
		player:turnOver()
		if player:getHandcardNum()<player:getMaxHp() then
			player:drawCards(player:getMaxHp()-player:getHandcardNum())
		end
		player:skip(sgs.Player_Judge)
		player:skip(sgs.Player_Draw)
		player:skip(sgs.Player_Play)
		player:skip(sgs.Player_Discard)
	end,
}

--[幻在] 锁定技，回合结束阶段开始时，你须弃置全部“时计”标记。
thhuanzai=sgs.CreateTriggerSkill{
	name="thhuanzai",
	frequency=sgs.Skill_Compulsory,
	events={sgs.EventPhaseStart},
	on_trigger=function(self,event,player,data)
		if player:getPhase()~=sgs.Player_Finish then return end
		local room=player:getRoom()
		if player:getMark("@shiji")>0 then
			room:broadcastSkillInvoke(self:objectName())
			local log= sgs.LogMessage()
				log.type = "#TriggerSkill"
				log.from = player
				log.arg  = self:objectName()
			room:sendLog(log)
			player:loseAllMarks("@shiji")
		end
	end,
}

----tsuki011
--[歌咏] 每当你的体力值发生变化时，你可以进行一次判定，若不为红桃，你摸一张牌。
thgeyong=sgs.CreateTriggerSkill{
	name="thgeyong",
	frequency=sgs.Skill_Frequent,
	events={sgs.HpChanged},
	priority=-1,
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if(room:askForSkillInvoke(player,self:objectName()))then
			local judge=sgs.JudgeStruct()
				judge.pattern=sgs.QRegExp("(.*):(heart):(.*)")
				judge.good=false
				judge.reason=self:objectName()
				judge.who=player
			room:judge(judge)
			if judge:isBad() then return end
            player:drawCards(1)
		end
	end,
}

--[秘曲] 出牌阶段，若你的手牌数不小于你的体力值，你可展示全部手牌：若均为不同花色，你令一名角色失去1点体力；若均为相同花色，你获得一名其他角色的一张牌。每阶段限一次。
thmiqucard=sgs.CreateSkillCard{
	name="thmiqucard",
	target_fixed=true,
	on_use=function(self, room, source, targets)
		room:showAllCards(source)
    	local samecount,unsamecount=0,0
    	for _,card1 in sgs.qlist(source:getHandcards()) do
			for _,card2 in sgs.qlist(source:getHandcards()) do
				if(card1:getId() ~= card2:getId()) then
					if(card1:getSuit() == card2:getSuit()) then
						samecount=samecount+1
					else
						unsamecount=unsamecount+1
					end
				end
			end
		end
		local card1=source:getRandomHandCard()
    	if(unsamecount == 0)then
        	local targets=sgs.SPlayerList()
        	for _,i in sgs.qlist(room:getOtherPlayers(source)) do
            	if(not i:isNude()) then
                	targets:append(i)
				end
			end
        	if(not targets:isEmpty()) then
            	local t=room:askForPlayerChosen(source, targets, "thmiqu")
            	local card_id=room:askForCardChosen(source, t, "he", "thmiqu")
            	room:obtainCard(source, card_id)
        	end
		elseif(samecount == 0)then
       		local target=room:askForPlayerChosen(source, room:getAlivePlayers(), "thmiqu")
        	room:loseHp(target)
    	end
	end,
}

thmiqu=sgs.CreateViewAsSkill{
	name="thmiqu",
	n=0,
	view_as=function(self, cards)
		if(#cards~=0) then return nil end
		local ZXcard=thmiqucard:clone()
			ZXcard:setSkillName(self:objectName())
		return ZXcard
	end,
	enabled_at_play=function(self, player)
        return not player:hasUsed("#thmiqucard") and player:getHandcardNum() >= player:getHp()
	end,
}

----tsuki012
--[折射] 每当你受到一次伤害后，你可以弃置一张手牌并选择一名角色，该角色需打出一张【闪】，否则受到你对其造成的1点伤害。
thzheshe=sgs.CreateTriggerSkill{
	name="thzheshe",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.Damaged},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:isKongcheng() then return end
		if not player:askForSkillInvoke(self:objectName()) then return end
		if not room:askForCard(player,".","@thzheshe",data,sgs.CardDiscarded) then return end
		local target=room:askForPlayerChosen(player,room:getAllPlayers(),self:objectName())
		if room:askForCard(target,"jink","@thzheshejink") then return end
		local damage=sgs.DamageStruct()
			damage.damage=1
			damage.nature=sgs.DamageStruct_Normal 
			damage.chain=false
			damage.from=player
			damage.to=target
		room:damage(damage)
	end,
}

----tsuki014
--[恶戏] 回合结束阶段开始时，你可以弃置一张手牌并选择两名角色，这两名角色须同时展示一张手牌，若这两张牌点数不同，你获得其中一张牌，所展示的牌点数大的角色获得另一张牌；若点数相同，你在此回合结束后须进行一个额外的回合（此额外的回合内你不可以发动“恶戏”）。
thexicard=sgs.CreateSkillCard{
	name="thexicard",
	target_fixed=false,
	will_throw=false,
	filter=function(self, targets, to_select, player)
		if to_select:objectName()==player:objectName() then
			return #targets<2 and player:getHandcardNum()>1
		else
			return #targets<2 and not to_select:isKongcheng()
		end
	end,
	on_use=function(self, room, source, targets)
		if #targets~=2 then return end
		room:throwCard(self,source)
		local card={}
		card[1]=room:askForCardShow(targets[1],source,"thexi")
		card[2]=room:askForCardShow(targets[2],source,"thexi")
		room:showCard(targets[1],card[1]:getId())
		room:showCard(targets[2],card[2]:getId())
		local canget=true
		local other
		local bigcard,smallcard
		if card[1]:getNumber()>card[2]:getNumber() then
			bigcard=card[1]
			smallcard=card[2]
			other=targets[1]
		elseif card[1]:getNumber()<card[2]:getNumber() then
			bigcard=card[2]
			smallcard=card[1]
			other=targets[2]
		elseif card[1]:getNumber()==card[2]:getNumber() then
			canget=false
		end
		if canget then
			local choice=room:askForChoice(source,self:objectName(),"exbig+exsma")
			local othercard
			if choice=="exbig" then
				room:moveCardTo(bigcard,source,sgs.Player_PlaceHand,true)
				othercard=smallcard
			else
				room:moveCardTo(smallcard,source,sgs.Player_PlaceHand,true)
				othercard=bigcard
			end
			room:moveCardTo(othercard,other,sgs.Player_PlaceHand,true)
		else
			source:addMark("exi")
		end
	end,
}

thexivs=sgs.CreateViewAsSkill{
	name="thexivs",
	n=1,
	view_filter=function(self, selected, to_select)
		return not to_select:isEquipped()
	end,
	view_as=function(self, cards)
		if #cards~=1 then return end
		local EXcard=thexicard:clone()
		EXcard:addSubcard(cards[1])
		EXcard:setSkillName("thexi")
		return EXcard
	end,
	enabled_at_play=function(self, player)
		return false
	end,
	enabled_at_response=function(self,player,pattern) 
		return pattern=="@@thexi"
	end,
}
	

thexi=sgs.CreateTriggerSkill{
	name="thexi",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseStart},
	view_as_skill=thexivs,
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:getPhase()==sgs.Player_Finish then
			if player:isKongcheng() then return end
			if player:getMark("exiused")~=0 then 
				player:setMark("exiused",0) 
				return 
			end
			room:askForUseCard(player,"@@thexi","@thexi")
			return
		end
		if player:getPhase()==sgs.Player_NotActive then
			if player:getMark("exi")<=0 then return end
			player:setMark("exi",0)
			player:addMark("exiused")
			player:gainAnExtraTurn(player)
		end
	end,
}

--[星露] 当你进入濒死状态时，你可以与一名其他角色拼点：若你赢，你回复1点体力。
thxinglu=sgs.CreateTriggerSkill{
	name="thxinglu",
	events={sgs.Dying},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:isKongcheng() then return end
		local targets=sgs.SPlayerList()
		for _,p in sgs.qlist(room:getOtherPlayers(player)) do
			if not p:isKongcheng() then
				targets:append(p)
			end
		end
		if targets:isEmpty() then return end
		if not room:askForSkillInvoke(player,self:objectName()) then return end
		local target=room:askForPlayerChosen(player,targets,self:objectName())
		local win=player:pindian(target,self:objectName(),nil)
		if not win then return end
		local recover=sgs.RecoverStruct()
			recover.recover=1
			recover.card=nil
			recover.who=player
		room:recover(player,recover)
	end,
}

----tsuki016
--[神佑] 摸牌阶段，你可以放弃摸牌，改为获得一名其他角色区域内的一张牌，然后你可以对其使用一张【杀】，此【杀】对目标角色造成的伤害视为失去体力。
thshenyou=sgs.CreateTriggerSkill{
	name="thshenyou",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseStart,sgs.Predamage},
	priority=3,
	on_trigger=function(self,event,player,data)
		if player:getPhase()~=sgs.Player_Draw then return end
		local room=player:getRoom()
		if event==sgs.Predamage then
			local damage=data:toDamage()
			if damage.card:getSkillName()~=self:objectName() then return end
			room:loseHp(damage.to,damage.damage)
			return true
		end
		local targets=sgs.SPlayerList()
		for _,p in sgs.qlist(room:getOtherPlayers(player)) do
			if not p:isAllNude() then
				targets:append(p)
			end
		end
		if targets:isEmpty() then return end
		if not player:askForSkillInvoke(self:objectName()) then return end
		local target=room:askForPlayerChosen(player,targets,self:objectName())
		local card_id=room:askForCardChosen(player,target,"hej",self:objectName())
		if(room:getCardPlace(card_id)==sgs.Player_PlaceHand) then
			room:moveCardTo(sgs.Sanguosha:getCard(card_id),player,sgs.Player_PlaceHand,false)
		else
			room:obtainCard(player,card_id)
		end
		room:askForUseSlashTo(player,"","@thshenyou")
		return true
	end,
}

----tsuki017
--[归墟] 你的回合外，当其他角色使用一张除【无懈可击】外的锦囊牌时，你可以进行一次判定，若为红色，抵消该锦囊牌产生的效果，并将其置于你的武将牌上称为“海”。若“海”的数量大于1，你不能以此法进行判定。
thguixu=sgs.CreateTriggerSkill{
	name="thguixu",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.CardUsed},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local splayer=room:findPlayerBySkillName(self:objectName())
		if not splayer then return end
		if splayer:getPhase()~=sgs.Player_NotActive then return end
		local use=data:toCardUse()
		if splayer:getPile("thguixupile"):length()>1 then return end
		if (not use.card:isKindOf("TrickCard")) or use.card:isKindOf("Nullification") then return end
		if use.card:isNDTrick() and (use.card:subcardsLength()~=0 or use.card:getEffectiveId()~=-1) then
			room:moveCardTo(use.card,nil,sgs.Player_DiscardPile,true)
		elseif (use.card:subcardsLength()~=0 or use.card:getEffectiveId()~=-1) then
			room:moveCardTo(use.card,use.to:first(),sgs.Player_PlaceDelayedTrick,true)
		end
		if not splayer:askForSkillInvoke(self:objectName()) then return end
		local judge=sgs.JudgeStruct()
			judge.pattern=sgs.QRegExp("(.*):(heart|diamond):(.*)")
			judge.good=true
			judge.reason=self:objectName()
			judge.who=splayer
		room:judge(judge)
		if judge.card:isBlack() then return end
		if use.card:getSubcards():length()==0 then
			if use.card:getEffectiveId()~=-1 then
				splayer:addToPile("thguixupile",use.card:getId(),true)
			end
		else
			for _,id in sgs.qlist(use.card:getSubcards()) do
				splayer:addToPile("thguixupile",id,true)
			end
		end
		return true
	end,
	can_trigger=function(self,target)
		return true
	end,
}

--[天阙] 出牌阶段，你可以弃置一张手牌，并获得一张与该牌花色相同的“海”。
thtianquecard=sgs.CreateSkillCard{
	name="thtianquecard",
	target_fixed=true,
	on_use=function(self, room, source, targets)
		local card_ids=source:getPile("thguixupile")
		room:fillAG(card_ids,source)
		local card_id=room:askForAG(source, card_ids, true, "thtianque")
		source:invoke("clearAG")
		if card_id==-1 then return end
		local card=sgs.Sanguosha:getCard(card_id)
		source:obtainCard(card)
		local pattern="."..string.upper(string.sub(card:getSuitString(),1,1))
		local acard
		while not acard do
			acard=room:askForCard(source, pattern, "@thtianque", data, sgs.CardDiscarded)
		end
		if acard:getId()==card_id then
			source:addToPile("thguixupile",card_id,true)
		end
	end,
}

thtianque=sgs.CreateViewAsSkill{
	name="thtianque",
	n=0,
	view_as=function(self, cards)
		local TQcard=thtianquecard:clone()
		TQcard:setSkillName(self:objectName())
		return TQcard
	end,
	enabled_at_play=function(self, player)
		return player:getPile("thguixupile"):length()~=0
	end,
}

--[[--tsuki018
--[永夜] 出牌阶段，当你使用一张非延时类锦囊牌时，你可弃置一张黑色牌并为该牌多或少指定一个合理的目标。
thyongye=sgs.CreateTriggerSkill{
	name="thyongye",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.CardUsed},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local use=data:toCardUse()
		if use.card:getSkillName()==self:objectName() then return end
		if not use.card:isKindOf("Duel") and not use.card:isKindOf("Snatch") and not use.card:isKindOf("Dismantlement") and not use.card:isKindOf("Collateral") and not use.card:isKindOf("FireAttack") and not use.card:isKindOf("SavageAssault") and not use.card:isKindOf("ArcheryAttack") and not use.card:isKindOf("AmazingGrace") and not use.card:isKindOf("GodSalvation") and not use.card:isKindOf("IronChain") then return end
		
		if (use.card:subcardsLength()~=0 or use.card:getEffectiveId()~=-1) then
			room:moveCardTo(use.card,nil,sgs.Player_DiscardPile,true)
		end
		
		local key=room:askForCard(player,".|.|.|.|black","@thyongye",data,sgs.CardDiscarded)
		
		if not key then return end
		
		local getcantarget=function(self,use,room,player)
			local alltargets=room:getAlivePlayers()
			local alreadytars=use.to
			local cantarget=alltargets
			for _,p in sgs.qlist(alltargets) do
				if alreadytars:contains(p) or player:isProhibited(p,use.card) then
					cantarget:removeOne(p)
				end
			end
			return cantarget
		end
		
		local getnewtarget=function(self,targets,room,player)
			local newtarget=room:askForPlayerChosen(player,targets,self:objectName())
			return newtarget
		end
		
		local getoldtarget=function(self,use,room,player)
			local alreadytars=use.to
			local oldtarget=room:askForPlayerChosen(player,alreadytars,self:objectName())
			return oldtarget
		end
		local cantarget=getcantarget(self,use,room,player)
		local used
		local target
		local maychoose=cantarget
		if use.card:isKindOf("Duel") or use.card:isKindOf("IronChain") then
			if not maychoose:isEmpty() then 
				if room:askForChoice(player,self:objectName(),"wantadd+wantmove")=="wantadd" then
					used=true
					target=getnewtarget(self,maychoose,room,player)
					use.to:append(target)
				end
			end
		elseif use.card:isKindOf("FireAttack") then
			for _,p in sgs.qlist(cantarget) do
				if p:isKongcheng() then
					maychoose:removeOne(p)
				end
			end
			if not maychoose:isEmpty() then 
				if room:askForChoice(player,self:objectName(),"wantadd+wantmove")=="wantadd" then
					used=true
					target=getnewtarget(self,maychoose,room,player)
					use.to:append(target)
				end
			end
		elseif use.card:isKindOf("Snatch") then
			local snatchs=sgs.SPlayerList()
			for _,p in sgs.qlist(cantarget) do
				if not p:isAllNude() and player:distanceTo(p)<=1 and player:objectName()~=p:objectName() then
					snatchs:append(p)
				end
			end
			if not snatchs:isEmpty() then 
				if room:askForChoice(player,self:objectName(),"wantadd+wantmove")=="wantadd" then
					used=true
					target=getnewtarget(self,snatchs,room,player)
					use.to:append(target)
				end
			end
		elseif use.card:isKindOf("Dismantlement") then
			for _,p in sgs.qlist(cantarget) do
				if p:isAllNude() then
					maychoose:removeOne(p)
				end
			end
			if not maychoose:isEmpty() then 
				if room:askForChoice(player,self:objectName(),"wantadd+wantmove")=="wantadd" then
					used=true
					target=getnewtarget(self,maychoose,room,player)
					use.to:append(target)
				end
			end
		elseif use.card:isKindOf("Collateral") then
			local slasher,slashee={},{}
			slasher[1]=use.to:at(0)
			slashee[1]=use.to:at(1)
			local newslashers=sgs.SPlayerList()
			for _,p in sgs.qlist(room:getOtherPlayers(player)) do
				if p:getWeapon() and not player:isProhibited(p,use.card) and slasher[1]:objectName()~=p:objectName() then
					newslashers:append(p)
				end
			end
			if not newslashers:isEmpty() then
				if room:askForChoice(player,self:objectName(),"wantadd+wantmove")=="wantadd" then
					slasher[2]=room:askForPlayerChosen(player,newslashers,self:objectName())
				end
			end
			if slasher[2] then
				local newslashees=sgs.SPlayerList()
				for _,p in sgs.qlist(room:getOtherPlayers(slasher[2])) do
					if slasher[2]:canSlash(p,true) then
						newslashees:append(p)
					end
				end
				if not newslashees:isEmpty() then
					slashee[2]=room:askForPlayerChosen(player,newslashees,self:objectName())
				end
			end
			if slashee[2] then
				for i=1,2,1 do
					for _,p in sgs.qlist(room:getAlivePlayers()) do
						if slasher[2]:objectName()==p:objectName() then
							use.to=sgs.SPlayerList()
							use.to:append(p)
							slasher[2]=nil
							use.to:append(slashee[2])
							slashee[2]=nil
						elseif slasher[1]:objectName()==p:objectName() then
							use.to=sgs.SPlayerList()
							use.to:append(p)
							slasher[1]=nil
							use.to:append(slashee[1])
							slashee[1]=nil
						end
						use.card:setSkillName(self:objectName())
						room:useCard(use,false)
					end
				end
				return true
			end
		end
		if not used then
			if use.card:isKindOf("Collateral") then
				return true
			end
			target=getoldtarget(self,use,room,player)
			use.to:removeOne(target)
			if use.to:isEmpty() then 
				return true
			end
		end
		data:setValue(use)
	end,
}

--[世明] 摸牌阶段，你可以放弃摸牌，改为从牌堆顶亮出四张牌，获得红色牌或者点数不大于9的牌，将其余的牌置入弃牌堆。 
thshiming=sgs.CreateTriggerSkill{
	name="thshiming",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseStart},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:getPhase()~=sgs.Player_Draw then return end
		if not room:askForSkillInvoke(player,self:objectName(),data) then return end
		local card_ids = room:getNCards(4)
		room:fillAG(card_ids,nil)
		local choice=room:askForChoice(player,self:objectName(),"shimred+shimsmall")
		local card
		local acard_ids=sgs.IntList()
		if choice=="shimred" then 
			for _,id in sgs.qlist(card_ids) do
				card=sgs.Sanguosha:getCard(id)
				if card:isBlack() then
					room:takeAG(nil,id)
				else
					acard_ids:append(id)
				end
			end
		else
			for _,id in sgs.qlist(card_ids) do
				card=sgs.Sanguosha:getCard(id)
				if card:getNumber()>9 then
					room:takeAG(nil,id)
				else
					acard_ids:append(id)
				end
			end
		end
		room:getThread():delay(2000)
		for _,p in sgs.qlist(room:getPlayers()) do
			p:invoke("clearAG")
		end
		for _,id in sgs.qlist(acard_ids) do
			player:obtainCard(sgs.Sanguosha:getCard(id))
		end
		return true
	end,
}

--[神宝] 限定技，出牌阶段，你可以从一名其他角色的区域获得等同于你攻击范围数量的牌，若如此做，回合结束阶段开始时，你须弃置等同于你攻击范围数量的牌（不足则全弃）。 
thshenbaocard=sgs.CreateSkillCard{
	name="thshenbaocard",
	target_fixed=false,
	will_throw=false,
	on_use = function(self, room, source, targets)
	
	end,
	
	on_effect=function(self,effect)
		
	end,
}

--[云隠] 主公技，每当其他月势力角色造成一次伤害后，可进行一次判定，若为黑色，你摸一张牌。 
]]

----kami002
--[[[极光] 回合开始阶段开始时，你可选择一项“气象”，效果持续到你的下回合开始。你不能选择你上回合所选择的“气象”。 
“风雨”：所有角色计算与其他角色的距离时，始终-1。 
“浓雾”：所有角色每使用【杀】对与其距离1以内的角色造成一次伤害后，回复1点体力。 
“烈日”：所有角色每次受到的火焰伤害+1。 
“黄砂”：所有角色每次受到多于1点的伤害时，防止多余的伤害。 
“昙天”：所有角色可将红桃花色的【闪】当【桃】使用。 ]]
thjgall={"jgfengyu","jgnongwu","jglieri","jghuangsha","jgtantian"}
thjgchosen={}
thjiguang=sgs.CreateTriggerSkill{
	name="thjiguang",
	frequency=sgs.Skill_NotFrequent,
	events={sgsEventPhaseStart},
	on_trigger=function(self,event,player,data)
		if player:getPhase()~=sgs.Player_Start then return end
		local room=player:getRoom()
		if thjgchosen[1] then
			player:loseAllMarks("@"..thjgchosen[1])
			if thjgchosen[1]=="jgfengyu" then
				for _,p in sgs.qlist(room:getAllPlayers()) do
					room:setPlayerMark(p,"jgfengyu",0)
				end
			end
			if thjgchosen[1]=="jgtantian" then
				for _,p in sgs.qlist(room:getAllPlayers()) do
					room:detachSkillFromPlayer(p,"thjgtantian")
				end
			end
		end
		local choice
		if not player:askForSkillInvoke(self:objectName()) then
			thjgchosen[1]=nil
		else
			local jgall=table.copyFrom(thjgall)
			if thjgchosen[1] then
				table.removeOne(jgall,thjgchosen[1])
			end
			choice=room:askForChoice(player,self:objectName(),table.concat(jgall,"+"))
			thjgchosen[1]=choice
			player:gainMark("@"..choice)
			if choice=="jgfengyu" then
				for _,p in sgs.qlist(room:getAllPlayers()) do
					room:setPlayerMark(p,"jgfengyu",1)
				end
			end
			if choice=="jgtantian" then
				for _,p in sgs.qlist(room:getAllPlayers()) do
					room:attachSkillToPlayer(p,"thjgtantian")
				end
			end
		end
	end,
}

thjgfengyu=sgs.CreateDistanceSkill{
	name="#thjgfengyu",
	correct_func=function(self,from,to)
		if from:getMark("jgfengyu")>0 then
			return -1
		end
	end,
}

thjg_buff=sgs.CreateTriggerSkill{
	name="#thjg_buff",
	frequency=sgs.Skill_Compulsory,
	events={sgs.DamageInflicted,sgs.DamageCaused},
	priority=-1,
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local splayer=room:findPlayerBySkillName("thjiguang")
		if not splayer then return end
		local damage=data:toDamage()
		if event==sgs.DamageInflicted then
			if splayer:getMark("@jglieri")>0 then
				if damage.nature~=sgs.DamageStruct_Fire then return end
				damage.damage=damage.damage+1
				data:setValue(damage)
				return
			elseif splayer:getMark("@jghuangsha")>0 then
				if damage.damage<2 then return end
				damage.damage=1
				data:setValue(damage)
				return
			else
				return
			end
		else
			if splayer:getMark("@jgnongwu")<1 then return end
			if player:distanceTo(damage.to)>1 then return end
			if not damage.card:isKindOf("Slash") then return end
			local recover=sgs.RecoverStruct()	
				recover.who=splayer
			room:recover(player,recover)
			return
		end
	end,
	can_trigger=function(self,target)
		return true
	end,
}

thjgtantian=sgs.CreateViewAsSkill{
	name="thjgtantian",
	n=1,
	view_filter = function(self, selected, to_select)
		return to_select:getSuit()==sgs.Card_Heart and to_select:isKindOf("Jink")
	end,
	view_as = function(self, cards)
		if #cards~=1 then return end
		local card=cards[1]
		local acard=sgs.Sanguosha:cloneCard("peach",card:getSuit(),card:getNumber())
		acard:addSubcard(card)
		acard:setSkillName("thjiguang")
		return acard
	end,
	enabled_at_play=function(self, player)
		return player:isWounded()
	end,
	enabled_at_response=function(self,player,pattern) 
		return pattern=="peach" or pattern=="peach+analeptic"
	end,
}

----kami004
--[夜行] 锁定技，回合开始阶段开始时，你须弃置全部的“月夜”标记并亮出牌堆顶的一张牌，若不为方片，你获得1枚“月夜”标记，然后将该牌置入弃牌堆。若你没有“月夜”标记，你的牌对其他角色无效；否则当你计算与其他角色的距离时，始终-1。
thyexing=sgs.CreateTriggerSkill{
	name="thyexing",
	frequency=sgs.Skill_Compulsory,
	events={sgs.EventPhaseStart},	
	on_trigger=function(self,event,player,data)
		local room=player:getRoom() 
		if player:getPhase() ~= sgs.Player_Start then return end
		player:loseAllMarks("@yueye")
		local card_id=room:drawCard()
		local log= sgs.LogMessage()
			log.type="#TriggerSkill"
			log.from=player
			log.arg =self:objectName()
		room:sendLog(log)
		local card=sgs.Sanguosha:getCard(card_id)
		room:moveCardTo(card, nil, player, sgs.Player_PlaceTable, sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_TURNOVER, player:objectName(), "thyexing", ""), true)
		room:getThread():delay()
		if card:getSuit()~=sgs.Card_Diamond then
			room:setEmotion(player,"good")
			player:gainMark("@yueye")
		else
			room:setEmotion(player,"bad")
		end
		room:moveCardTo(card, nil, sgs.Player_DiscardPile, true)
	end,
}

thyexingtr=sgs.CreateTriggerSkill{
	name="#thyexingtr",
	frequency=sgs.Skill_Compulsory,
	events={sgs.CardEffect},
	priority=5,
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:getMark("@yueye")~=0 then return end
		local effect=data:toCardEffect()
		if effect.to:objectName()==player:objectName() then return end
		return true
	end,
}

thyexingdis=sgs.CreateDistanceSkill{
	name="#thyexingdis",
	correct_func=function(self,from,to)
		if from:hasSkill("thyexing") and from:getMark("@yueye")~=0 then
			return -1
		end
	end,
}

--[千狱] 觉醒技，回合开始阶段开始时，若你已受伤，你须减少1点体力上限并获得技能“虎咆”和“狂魔”（锁定技，你的【桃】均视为【杀】。每当你使用红色的【杀】对目标角色造成1点伤害后，你回复1点体力。）。
thqianyu=sgs.CreateTriggerSkill{
	name="thqianyu",
	frequency=sgs.Skill_Wake,
	events={sgs.EventPhaseStart},
	priority=2,
	on_trigger=function(self,event,player,data)
		local room=player:getRoom() 
		if player:getMark(self:objectName())~=0 then return end
		if player:getPhase() ~= sgs.Player_Start then return end
		if not player:isWounded() then return end
		local log= sgs.LogMessage()
			log.type = "#thqianyu"
			log.from = player
			log.arg  = self:objectName()
		room:sendLog(log)
		room:getThread():delay()
		room:loseMaxHp(player)
		room:acquireSkill(player, "paoxiao")
		room:acquireSkill(player, thkuangmo)
		room:acquireSkill(player, thkuangmorec)
		player:addMark(self:objectName())
	end,
}

--[狂魔] 锁定技，你的【桃】均视为【杀】。每当你使用红色的【杀】造成伤害后，你回复1点体力。
thkuangmo=sgs.CreateFilterSkill{
	name="thkuangmo",
	view_filter=function(self,to_select)
		return to_select:isKindOf("Peach")
	end,
	view_as=function(self,card)
		local slash=sgs.Sanguosha:cloneCard("slash",card:getSuit(),card:getNumber())
		slash:setSkillName(self:objectName())
		local card=sgs.Sanguosha:getWrappedCard(card:getId())
        card:takeOver(slash)
		return card
	end
}

thkuangmorec=sgs.CreateTriggerSkill{
	name="#thkuangmorec",
	frequency=sgs.Skill_Compulsory,
	events={sgs.Damage},	
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local damage=data:toDamage()
		if damage.card:isKindOf("Slash") and damage.card:isRed() then
			local log= sgs.LogMessage()
				log.type = "#TriggerSkill"
				log.from = player
				log.arg  = "thkuangmo"
			room:sendLog(log)
			local recover=sgs.RecoverStruct()
				recover.recover=damage.damage
				recover.who=player
			room:recover(player, recover)
		end
	end,
}

--[红雾] 觉醒技，每当你扣减1点体力时，若你的体力值为0，你须减少1点体力上限并获得技能“终曲”、“赤律”（出牌阶段，你可以用一张手牌替换你武将牌上的一张牌。）和“昙雾”（锁定技，每当你回复1点体力时，你进行一次判定，若为红色，你获得此判定牌。你武将牌上每有一张牌，你的手牌上限便+1。）。
thhongwu=sgs.CreateTriggerSkill{
	name="thhongwu",
	frequency=sgs.Skill_Wake,
	events={sgs.HpChanged},
	priority=-1,
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:getMark(self:objectName())~=0 then return end
		if player:getHp()>0 then return end
		local log= sgs.LogMessage()
			log.type = "#thhongwu"
			log.from = player
			log.arg  = self:objectName()
		room:sendLog(log)
		room:getThread():delay()
		room:loseMaxHp(player)
		room:acquireSkill(player, "buqu")
		room:acquireSkill(player, "thchilv")
		room:acquireSkill(player, "thtanwu")
		room:acquireSkill(player, "#thtanwurec")
		player:addMark(self:objectName())
	end,
}

--[赤律] 出牌阶段，你可以将一张手牌替换武将牌上的一张牌。
thchilvcard=sgs.CreateSkillCard{
	name="thchilvcard",
	target_fixed=true,
	will_throw=false,
	on_use=function(self, room, source, targets)
		local card_ids=source:getPile("buqu")
		room:fillAG(card_ids,source)
		local card_id=room:askForAG(source,card_ids,true,self:objectName())
		source:invoke("clearAG")
		if card_id==-1 then return end
		source:obtainCard(sgs.Sanguosha:getCard(card_id))
		source:addToPile("buqu",self:getEffectiveId(),true)
		card_ids=source:getPile("buqu")
		local buqunums=sgs.IntList()
		local num
		local willdying=false
		for _,id in sgs.qlist(card_ids) do
			num=sgs.Sanguosha:getCard(id):getNumber()
			if not buqunums:contains(num) then
				buqunums:append(num)
			else
				willdying=true
				break
			end
		end
		if willdying then
			local log= sgs.LogMessage()
				log.type = "#thchilv"
				log.from = player
			room:sendLog(log)
			room:enterDying(source,nil)
		end
		return 
	end,
}

thchilv=sgs.CreateViewAsSkill{
	name="thchilv",
	n=1,
	view_filter=function(self, selected, to_select)
		return not to_select:isEquipped()
	end,
	view_as=function(self, cards)
		if #cards~=1 then return end
		local card=thchilvcard:clone()
		card:setSkillName(self:objectName())
		card:addSubcard(cards[1])
		return card
	end,
	enabled_at_play=function(self, player)
		return not player:getPile("buqu"):isEmpty()
	end,
}

--[昙雾] 锁定技，每当你回复1点体力时，你进行一次判定，若为红色，你获得此判定牌。你武将牌上每有一张牌，你的手牌上限便+1。
thtanwu=sgs.CreateMaxCardsSkill{
	name="thtanwu",
	extra_func=function(self,target)
		if not target:hasSkill(self:objectName()) then return 0 end
		return target:getPile("buqu"):length()
	end,
}

thtanwurec=sgs.CreateTriggerSkill{
	name="#thtanwurec",
	frequency=sgs.Skill_Compulsory,
	events={sgs.HpRecover},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local log= sgs.LogMessage()
			log.type = "#TriggerSkill"
			log.from = player
			log.arg  = self:objectName()
		local judge=sgs.JudgeStruct()
			judge.pattern=sgs.QRegExp("(.*):(heart|diamond):(.*)")
			judge.good=true
			judge.reason=self:objectName()
			judge.who=player
		local recover=data:toRecover()
		for i=1,recover.recover,1 do
			room:sendLog(log)
			room:judge(judge)
			if judge.card:isRed() then
				player:obtainCard(judge.card)
			end
		end
	end,
}

----kami009
--[愈心] 摸牌阶段，你可弃置一张牌，并放弃摸牌，改为从牌堆顶亮出两张牌并获得之，若这两张牌均为红桃，你可以指定一名已受伤的角色并令其回复1点体力。
thyuxin=sgs.CreateTriggerSkill{
	name="thyuxin",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseStart},
	on_trigger=function(self,event,player,data)
		if player:getPhase()~=sgs.Player_Draw then return end
		local room=player:getRoom()
		if not player:askForSkillInvoke(self:objectName()) then return end
		if not room:askForDiscard(player,self:objectName(),1,1,true,true) then return end
		local card_id=room:drawCard()
		local card=sgs.Sanguosha:getCard(card_id)
		room:moveCardTo(card, nil, player, sgs.Player_PlaceTable, sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_TURNOVER, player:objectName(), self:objectName(), ""), true)
		room:getThread():delay()
		player:obtainCard(card)
		local card_id2=room:drawCard()
		local card2=sgs.Sanguosha:getCard(card_id2)
		room:moveCardTo(card2, nil, player, sgs.Player_PlaceTable, sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_TURNOVER, player:objectName(), self:objectName(), ""), true)
		room:getThread():delay()
		player:obtainCard(card2)
		if card:getSuit()==sgs.Card_Heart and card2:getSuit()==sgs.Card_Heart then
			local targets=sgs.SPlayerList()
			for _,p in sgs.qlist(room:getAllPlayers()) do
				if p:isWounded() then
					targets:append(p)
				end
			end
			if not targets:isEmpty() then
				local target=room:askForPlayerChosen(player,targets,self:objectName())
				local recover = sgs.RecoverStruct()
					recover.who = player
				room:recover(target, recover)
			end
		end
		return true
	end,
}

--[创心] 出牌阶段开始时，你可弃置X张牌，然后选择X项：1. 获得技能“攻心”，直到回合结束 2. 获得技能“捞月”，直到回合结束。
thchuangxincard=sgs.CreateSkillCard{
	name="thchuangxincard",
	target_fixed=true,
	will_throw=true,	
	on_use = function(self, room, source, targets)
		if self:subcardsLength()==1 then 
			local choice=room:askForChoice(source,"thchuangxin","gongxin+biyue")
			room:acquireSkill(source,choice)
		else
			room:acquireSkill(source,"gongxin")
			room:acquireSkill(source,"biyue")
		end
	end,
}

thchuangxinvs=sgs.CreateViewAsSkill{
	name="thchuangxinvs",
	n=2,
	view_filter = function(self, selected, to_select)
		return true
	end,
	view_as = function(self, cards)
		if #cards==0 then return end
		local CXcard=thchuangxincard:clone()
		CXcard:addSubcard(cards[1])
		if #cards==2 then
			CXcard:addSubcard(cards[2])
		end
		CXcard:setSkillName("thchuangxin")
		return CXcard
	end,
	enabled_at_play=function(self, player)
		return false
	end,
	enabled_at_response=function(self,player,pattern) 
		return pattern=="@@thchuangxin"
	end,
}

thchuangxin=sgs.CreateTriggerSkill{
	name="thchuangxin",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseStart},
	view_as_skill=thchuangxinvs,
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:getPhase()==sgs.Player_NotActive then
			room:detachSkillFromPlayer(player,"gongxin")
			room:detachSkillFromPlayer(player,"biyue")
		end
		if player:getPhase()~=sgs.Player_Play then return end
		if player:isNude() then return end
		if not player:askForSkillInvoke(self:objectName()) then return end
		room:askForUseCard(player,"@@thchuangxin","@thchuangxin")
	end,
}

--[天心] 你的回合开始时，你可弃置X张牌，然后选择X项：1. 获得技能“预悉”，直到回合结束 2. 获得技能“天妒”，直到回合结束。
thtianxincard=sgs.CreateSkillCard{
	name="thtianxincard",
	target_fixed=true,
	will_throw=true,	
	on_use = function(self, room, source, targets)
		if self:subcardsLength()==1 then 
			local choice=room:askForChoice(source,"thtianxin","guanxing+tiandu")
			room:acquireSkill(source,choice)
		else
			room:acquireSkill(source,"guanxing")
			room:acquireSkill(source,"tiandu")
		end
	end,
}

thtianxinvs=sgs.CreateViewAsSkill{
	name="thtianxinvs",
	n=2,
	view_filter = function(self, selected, to_select)
		return true
	end,
	view_as = function(self, cards)
		if #cards==0 then return end
		local TXcard=thtianxincard:clone()
		TXcard:addSubcard(cards[1])
		if #cards==2 then
			TXcard:addSubcard(cards[2])
		end
		TXcard:setSkillName("thtianxin")
		return TXcard
	end,
	enabled_at_play=function(self, player)
		return false
	end,
	enabled_at_response=function(self,player,pattern) 
		return pattern=="@@thtianxin"
	end,
}

thtianxin=sgs.CreateTriggerSkill{
	name="thtianxin",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.TurnStart,sgs.EventPhaseStart},
	view_as_skill=thtianxinvs,
	on_trigger=function(self,event,player,data)
		if event==sgs.TurnStart then
			if not player:faceUp() then return end
			if player:isNude() then return end
			if not player:askForSkillInvoke(self:objectName()) then return end
			local room=player:getRoom()
			room:askForUseCard(player,"@@thtianxin","@thtianxin")
			return
		end
		local room=player:getRoom()
		if player:getPhase()==sgs.Player_NotActive then
			room:detachSkillFromPlayer(player,"guanxing")
			room:detachSkillFromPlayer(player,"tiandu")
			return
		end
	end,
}

----kami013
--[散灵] 锁定技，一名角色的回合结束后，若你没有手牌，你立即死亡。
thsanling=sgs.CreateTriggerSkill{
	name="thsanling",
	frequency=sgs.Skill_Compulsory,
	events={sgs.EventPhaseStart},
	priority=6,
	
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local splayer=room:findPlayerBySkillName(self:objectName())
		if not splayer then return end
		if player:getPhase()==sgs.Player_NotActive then
			if not splayer:isKongcheng() then return end
			local log= sgs.LogMessage()
				log.type = "#TriggerSkill"
				log.from = splayer
				log.arg  = self:objectName()
			room:sendLog(log)
			room:loseMaxHp(splayer,splayer:getMaxHp())
		end
	end,
	
	can_trigger=function(self,target)
		return true
	end,
}

--[氷障] 每当你受到伤害或失去体力时，你可以弃置两张牌，然后防止此伤害或此次失去体力。 
thbingzhang=sgs.CreateTriggerSkill{
	name="thbingzhang",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.DamageInflicted,sgs.HpLost},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:getCardCount(true)<2 then return end
		if not room:askForSkillInvoke(player,self:objectName()) then return end
		if not room:askForDiscard(player,self:objectName(),2,2,true,true) then return end
		return true
	end,
}

--[极武] 锁定技，你的【桃】和【酒】均视为【闪】。弃牌阶段外，每当你的【闪】置入弃牌堆或其他角色每获得你的一张手牌时，你摸一张牌。
thjiwu=sgs.CreateFilterSkill{
	name="thjiwu",
	view_filter=function(self,to_select)
		return to_select:isKindOf("Peach") or to_select:isKindOf("Analeptic")
	end,
	view_as=function(self,card)
		local jink=sgs.Sanguosha:cloneCard("jink",card:getSuit(),card:getNumber())
		jink:setSkillName(self:objectName())
		local card=sgs.Sanguosha:getWrappedCard(card:getId())
        card:takeOver(jink)
		return card
	end
}

thjiwutr=sgs.CreateTriggerSkill{
	name="#thjiwutr",
	events={sgs.CardsMoveOneTime},
	frequency=sgs.Skill_Compulsory,
	on_trigger=function(self, event, player, data)
		local room=player:getRoom()
		local move=data:toMoveOneTime()
		if not move.from or (move.from):objectName()~=player:objectName() then return end
		if player:getPhase()==sgs.Player_Discard then return end
		local n=(move.from_places):length()-1
		local log= sgs.LogMessage()
			log.type = "#TriggerSkill"
			log.from = player
			log.arg  = "thjiwu"
		for i=0,n,1 do
			if (move.from_places):at(i) == sgs.Player_PlaceHand and move.to and ((move.to:objectName() ~= player:objectName() and move.to_place ~= sgs.Player_PlaceDelayedTrick and move.to_place ~= sgs.Player_PlaceSpecial) or (move.to_place==sgs.Player_PlaceTable)) then
				room:sendLog(log)
				player:drawCards(1)
			end
		end
		for i=0,n,1 do
			if move.to==nil and move.to_place == sgs.Player_DiscardPile and (sgs.Sanguosha:getCard((move.card_ids):at(i)):isKindOf("Jink") or sgs.Sanguosha:getCard((move.card_ids):at(i)):isKindOf("Peach") or sgs.Sanguosha:getCard((move.card_ids):at(i)):isKindOf("Analeptic")) then
				room:sendLog(log)
				player:drawCards(1)
			end
		end
	end
}

--[祀祟] 回合开始阶段开始时，你可以令所有其他角色各弃置一张手牌，然后你从弃牌堆获得这些牌中的至多三张牌，并依次交给一名角色。
thsisui=sgs.CreateTriggerSkill{
	name="thsisui",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseStart},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:getPhase()~=sgs.Player_Start then return end
		if not room:askForSkillInvoke(player,self:objectName(),data) then return end
		room:setPlayerFlag(player,"thsisui")
		if sisuicardids:length()~= 0 then
			sisuicardids=sgs.IntList()
		end
		for _,p in sgs.qlist(room:getOtherPlayers(player)) do
			if not p:isKongcheng() then
				room:askForDiscard(p,self:objectName(),1,1,false,false)
			end
		end
		room:setPlayerFlag(player,"-thsisui")
		if sisuicardids:isEmpty() then return end
		local newlist=sgs.IntList()
		for _,id in sgs.qlist(sisuicardids) do
			if room:getCardPlace(id) == sgs.Player_DiscardPile then
				newlist:append(id)
			end
		end
		if newlist:isEmpty() then return end
		local target
		for i=1,3,1 do
			room:fillAG(newlist,nil)
			card_id=room:askForAG(player,newlist, true, "thsisui")
			for _,p in sgs.qlist(room:getPlayers()) do
				p:invoke("clearAG")
			end
			if card_id == -1 then break end
			newlist:removeOne(card_id)
			target=room:askForPlayerChosen(player,room:getAllPlayers(),self:objectName())
			target:obtainCard(sgs.Sanguosha:getCard(card_id))
			if newlist:isEmpty() then break end
		end
	end,
}

sisuicardids=sgs.IntList()
thsisuirecord=sgs.CreateTriggerSkill{
	name="#thsisuirecord",
	frequency=sgs.Skill_Compulsory,
	events={sgs.CardsMoveOneTime},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local splayer=room:findPlayerBySkillName(self:objectName())
		if not splayer then return end
		if not splayer:hasFlag("thsisui") then return end
		local move=data:toMoveOneTime()
		local n=(move.card_ids):length()-1
		for i=0,n,1 do
			id=(move.card_ids):at(i)
			sisuicardids:append(id)
		end
	end,
	can_trigger=function(self,target)
		return true
	end,
}

--[湛樱] 锁定技，你始终跳过你的摸牌阶段；你的手牌上限+4。
thzhanying=sgs.CreateMaxCardsSkill{
	name="thzhanying",
	extra_func=function(self,target)
		if not target:hasSkill(self:objectName()) then return 0 end
		return 4
	end
}

thzhanyingskip=sgs.CreateTriggerSkill{
	name="#thzhanyingskip",
	frequency=sgs.Skill_Compulsory,
	events={sgs.EventPhaseChanging},
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local change=data:toPhaseChange()
		if change.to == sgs.Player_Draw then
			local log= sgs.LogMessage()
				log.type = "#TriggerSkill"
				log.from = player
				log.arg  = "thzhanying"
			room:sendLog(log)
			player:skip(sgs.Player_Draw)
		end
	end,
}

--[霓裳] 回合开始阶段开始时，你可以将一名其他角色的武将牌横置或者重置。
thnishang=sgs.CreateTriggerSkill{
	name="thnishang",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseStart},	
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:getPhase()~=sgs.Player_Start then return end
		if not player:askForSkillInvoke(self:objectName(),data) then return end
		local target=room:askForPlayerChosen(player,room:getAllPlayers(),self:objectName())
		local log= sgs.LogMessage()
			log.type = "#thnishang"
			log.from = player
			log.to:append(target)
			if target:isChained() then
				log.arg  = "chongzhi"
			else
				log.arg  = "hengzhi"
			end
		room:sendLog(log)
		room:setPlayerProperty(target,"chained",sgs.QVariant(not target:isChained()))
	end,
}

--[奇门] 锁定技，当你计算与武将牌横置的角色的距离、武将牌横置的角色计算与你的距离时，无视你们之外的其他角色。
thqimen=sgs.CreateDistanceSkill{
	name="thqimen",
	correct_func=function(self,from,to)
		if (from:hasSkill("thqimen") and to:isChained()) or (to:hasSkill("thqimen") and from:isChained())then
			local x=math.abs(from:getSeat()-to:getSeat())
			local y=from:aliveCount()-x
			return 1-math.min(x, y)
		end
	end,
}

--[贯甲] 锁定技，你无视其他角色装备区的防具牌。
thguanjia=sgs.CreateTriggerSkill{
	name="thguanjia",
	frequency=sgs.Skill_Compulsory,
	events={sgs.CardUsed,sgs.CardFinished},
	priority=2,	
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local use=data:toCardUse()
		local card=use.card
		if event==sgs.CardFinished then
			for _,p in sgs.qlist(use.to) do
				p:removeMark("qinggang")
			end
			return
		end
		if card:isKindOf("Slash") or card:isKindOf("ArcheryAttack") or card:isKindOf("SavageAssault") or card:isKindOf("FireAttack") then
			local log= sgs.LogMessage()
				log.type = "#TriggerSkill"
				log.from = player
				log.arg  = self:objectName()
			room:sendLog(log)
		end
		for _,p in sgs.qlist(use.to) do
			p:addMark("qinggang")
		end
	end,
}

----bangai001
--[诅杀] 出牌阶段，你可以弃置一张黑桃手牌并令一名其他角色获得1枚“诅咒”标记，每阶段限一次。其他角色的判定阶段开始时，若其拥有1枚或更多的“诅咒”标记，须进行一次判定，若为黑色，其失去1点体力；判定阶段结束时，该角色须进行一次判定，若为红色，弃置1枚“诅咒”标记。 
thzushacard=sgs.CreateSkillCard{
	name="thzushacard",
	target_fixed=false,
	will_throw=true,
	filter = function(self, targets, to_select, player)
		return #targets==0 and to_select:objectName()~=player:objectName()
	end,
	on_use = function(self, room, source, targets)
		targets[1]:gainMark("@zuzhou")
	end,
}

thzushavs=sgs.CreateViewAsSkill{
	name="thzushavs",
	n=1,
	view_filter = function(self, selected, to_select)
		return to_select:getSuit()==sgs.Card_Spade and not to_select:isEquipped()
	end,
	view_as = function(self, cards)
		if #cards~=1 then return end
		local ZScard=thzushacard:clone()
		ZScard:addSubcard(cards[1])
		ZScard:setSkillName("thzusha")
		return ZScard
	end,
	enabled_at_play=function(self, player)
		return not player:hasUsed("#thzushacard")
	end,
}

thzusha=sgs.CreateTriggerSkill{
	name="thzusha",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseStart,sgs.EventPhaseEnd},
	view_as_skill=thzushavs,
	on_trigger=function(self,event,player,data)
		if player:getMark("@zuzhou")<=0 then return end
		if player:getPhase()~=sgs.Player_Judge then return end
		local room=player:getRoom()
		local log= sgs.LogMessage()
			log.type = "#thzusha"
			log.from = player
			log.arg  = "@zuzhou"
		room:sendLog(log)
		local judge=sgs.JudgeStruct()
			judge.pattern=sgs.QRegExp("(.*):(spade|club):(.*)")
			judge.good=false
			judge.reason="thzusha"
			judge.who=player
		room:judge(judge)
		if event==sgs.EventPhaseStart then
			if judge:isBad() then
				room:setEmotion(player,"bad")
				room:loseHp(player)
			else
				room:setEmotion(player,"good")
			end
		elseif event==sgs.EventPhaseEnd then
			if judge:isGood() then
				room:setEmotion(player,"good")
				player:loseMark("@zuzhou")
			else
				room:setEmotion(player,"bad")
			end
		end
	end,
	can_trigger=function(self,target)
		return true
	end,
}

--[妖魅] 限定技，出牌阶段，你可以弃置一张红色手牌并选择两名已受伤的角色，已损失的体力值较小的角色失去1点体力（若相同，则由你选择一名角色），然后另一名角色回复1点体力。
thyaomeicard=sgs.CreateSkillCard{
	name="thyaomeicard",
	target_fixed=false,
	will_throw=false,
	filter = function(self, targets, to_select, player)
		return #targets<2 and to_select:isWounded()
	end,
	on_use = function(self, room, source, targets)
		if #targets<2 then return end
		room:throwCard(self,source)
		source:loseMark("@yaomei")
		source:gainMark("@yaomeiused")
		local losthp={}
		losthp[1]=targets[1]:getLostHp()
		losthp[2]=targets[2]:getLostHp()
		local minindex=0
		if losthp[1]<losthp[2] then
			minindex=1
		elseif losthp[1]>losthp[2] then
			minindex=2
		end
		local newtargets=sgs.SPlayerList()
		newtargets:append(targets[1])
		newtargets:append(targets[2])
		local target
		if minindex~=0 then
			target=targets[minindex]
		else
			target=room:askForPlayerChosen(source,newtargets,self:objectName())
		end
		newtargets:removeOne(target)
		room:loseHp(target)
		local recover=sgs.RecoverStruct()
			recover.who=source
		room:recover(newtargets:first(),recover)
	end,
}

thyaomeivs=sgs.CreateViewAsSkill{
	name="thyaomeivs",
	n=1,
	view_filter = function(self, selected, to_select)
		return to_select:isRed() and not to_select:isEquipped()
	end,
	view_as = function(self, cards)
		if #cards~=1 then return end
		local YMcard=thyaomeicard:clone()
		YMcard:addSubcard(cards[1])
		YMcard:setSkillName("thyaomei")
		return YMcard
	end,
	enabled_at_play=function(self, player)
		return player:getMark("@yaomei")>0
	end,
}

thyaomei=sgs.CreateTriggerSkill{
	name="thyaomei",
	frequency=sgs.Skill_Limited,
	events={sgs.GameStart},
	view_as_skill=thyaomeivs,
	on_trigger=function(self,event,player,data)
		player:gainMark("@yaomei")
	end,
}

--[忠节] 锁定技，若你的装备区里没有防具牌，一名角色的回合内，你受到该角色对你造成的伤害时，若该伤害多于1点，则防止多余的伤害。
thzhongjie=sgs.CreateTriggerSkill{
	name="thzhongjie",
	frequency=sgs.Skill_Compulsory,
	events={sgs.DamageInflicted},	
	on_trigger=function(self,event,player,data)
		if player:getArmor() then return end
		local room=player:getRoom()
		local damage=data:toDamage()
		if damage.from:getPhase()==sgs.Player_NotActive then return end
		if damage.damage<=1 then return end
		local log= sgs.LogMessage()
			log.type = "#TriggerSkill"
			log.from = player
			log.arg  = self:objectName()
		room:sendLog(log)
		damage.damage=1
		data:setValue(damage)
	end,
}

----bangai002
--[半月] 当你使用【杀】时，可以进行一次判定，若结果为黑色，为该【杀】额外指定一个目标；若为红色，弃置目标角色一张牌。
thbanyue=sgs.CreateTriggerSkill{
	name="thbanyue",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.CardUsed},	
	on_trigger=function(self,event,player,data)
		local use=data:toCardUse()
		if not use.card:isKindOf("Slash") then return end
		if not player:askForSkillInvoke(self:objectName()) then return end
		local room=player:getRoom()
		local judge=sgs.JudgeStruct()
			judge.pattern=sgs.QRegExp("(.*):(.*):(.*)")
			judge.good=true
			judge.reason=self:objectName()
			judge.who=player
		room:judge(judge)
		local card_id
		if judge.card:isRed() then
			for _,p in sgs.qlist(use.to) do
				if not p:isNude() then
					card_id=room:askForCardChosen(player,p,"he",self:objectName())
					local reason=sgs.CardMoveReason()
					reason.m_reason   = sgs.CardMoveReason_S_REASON_DISMANTLE
					reason.m_playerId = player:objectName()
    				reason.m_targetId = p:objectName()
					room:moveCardTo(sgs.Sanguosha:getCard(card_id), nil, nil, sgs.Player_DiscardPile, reason)
				end
			end
		elseif judge.card:isBlack() then
			local targets=sgs.SPlayerList()
			for _,p in sgs.qlist(room:getOtherPlayers(player)) do
				if player:inMyAttackRange(p) and not use.to:contains(p) then
					targets:append(p)
				end
			end
			if targets:isEmpty() then return end
			local target=room:askForPlayerChosen(player,targets,self:objectName())
			use.to:append(target)
			data:setValue(use)
		end
	end,
}

----bangai004
--[辨方] 每当你使用【杀】对目标角色造成一次伤害后或受到一次伤害后，若你已受伤，你可以选择X种花色并进行一次判定，若结果为你所选花色之一，你弃置一名其他角色一张牌或回复1点体力（X为你已损失的体力值且至多为3）。
thbianfang=sgs.CreateTriggerSkill{
	name="thbianfang",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.Damage,sgs.Damaged},	
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		local damage=data:toDamage()
		if event==sgs.Damage and (not damage.card:isKindOf("Slash") or damage.chain) then return end
		if not player:isWounded() then return end
		x=player:getLostHp()
		local allsuit={"spade","heart","club","diamond"}
		local canchoice={}
		local choiced={}
		local judge,log
		choiced={}
		canchoice=table.copyFrom(allsuit)
		for i=1,x,1 do
			choice=room:askForChoice(player,self:objectName(), table.concat(canchoice, "+"))
			log= sgs.LogMessage()
				log.type = "#ChooseSuit"
				log.from = player
				log.arg  = choice
			room:sendLog(log)
			table.removeOne(canchoice,choice)
			table.insert(choiced,choice)
		end
		judge=sgs.JudgeStruct()
			judge.pattern=sgs.QRegExp("(.*):(.*):(.*)")
			judge.good=true
			judge.reason=self:objectName()
			judge.who=player
		room:judge(judge)
		if table.contains(choiced,judge.card:getSuitString())then
			local choice="bfdis"
			if player:isWounded() then
				choice=room:askForChoice(player,self:objectName(),"bfdis+bfrec")
			end
			if choice=="bfdis" then
				local targets=sgs.SPlayerList()
				for _,p in sgs.qlist(room:getOtherPlayers(player)) do
					if not p:isNude() then
						targets:append(p)
					end
				end
				if targets:isEmpty() then return end
				local target=room:askForPlayerChosen(player,targets,self:objectName())
				local card_id=room:askForCardChosen(player,target,"he",self:objectName())
				local reason=sgs.CardMoveReason()
				reason.m_reason   = sgs.CardMoveReason_S_REASON_DISMANTLE
				reason.m_playerId = player:objectName()
    			reason.m_targetId = target:objectName()
				room:moveCardTo(sgs.Sanguosha:getCard(card_id), nil, nil, sgs.Player_DiscardPile, reason)
			else
				local recover = sgs.RecoverStruct()
					recover.who = player
				room:recover(player, recover)
			end
		end
	end,
}

----bangai011
--[威德] 摸牌阶段，若你已受伤，你可以放弃摸牌，改为令一名其他角色摸X张牌，若如此做，你获得手牌数最多的一名其他角色的等量的手牌（X为你已损失的体力值）。
--[[thweide=sgs.CreateTriggerSkill{
	name="thweide",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseStart},	
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if player:getPhase()~=sgs.Player_Draw then return end
		if not player:isWounded() then return end
		local x=player:getLostHp()
		if not player:askForSkillInvoke(self:objectName()) then return end
		local target=room:askForPlayerChosen(player,room:getOtherPlayers(player),self:objectName())
		target:drawCards(x)
		local num=0
		for _,p in sgs.qlist(room:getOtherPlayers(player)) do
			if p:getHandcardNum()>num then
				num=p:getHandcardNum()
			end
		end
		local targets=sgs.SPlayerList()
		for _,p in sgs.qlist(room:getOtherPlayers(player)) do
			if p:getHandcardNum()==num then
				targets:append(p)
			end
		end
		target=room:askForPlayerChosen(player,targets,self:objectName())
		local dummycard
		for i=1,x,1 do
			if target:isKongcheng() then return end
			
	end,
}]]

kaze002:addSkill(thjilanwen)

kaze003:addSkill(thnianxie)
kaze003:addSkill(thjilan)

kaze004:addSkill(thwangshou)
kaze004:addSkill(thhongye)

kaze005:addSkill(thenan)
kaze005:addSkill(thbeiyun)

kaze007:addSkill(thbisha)

kaze008:addSkill(thshenzhou)
kaze008:addSkill(thtianliu)
kaze008:addSkill(thqianyi)

kaze009:addSkill(thhuosui)
kaze009:addSkill(thtiandi)
kaze009:addSkill(thkunyi)

kaze010:addSkill(thcannue)
kaze010:addSkill(thsibao)

kaze011:addSkill(thwangmin)

kaze012:addSkill(thgelong)
kaze012:addSkill(thyuanzhou)

kaze015:addSkill(thyanlun)
kaze015:addSkill(thyanluntr)

kaze017:addSkill(thmaihuo)
kaze017:addSkill(thwunian)

hana003:addSkill(thbian)
hana003:addSkill(thguihang)
hana003:addSkill(thwujian)
hana003:addSkill(thwujiandis)

hana006:addSkill(thxihua)

hana007:addSkill(thanyun)
hana007:addSkill(thmimeng)
hana007:addSkill(thmimengtr)

hana008:addSkill(thquanshan)
hana008:addSkill(thxiangang)

hana011:addSkill(thbaochun)
hana011:addSkill(thtanchun)

hana013:addSkill(thyinghua)
hana013:addSkill(thliaoyu)
hana013:addSkill(thhouzhi)

hana016:addSkill(thshijie)
hana016:addSkill(thshijietr)
hana016:addSkill(thshengzhi)

hana017:addSkill(thzhaoyu)
hana017:addSkill(thwuwu)
hana017:addSkill(thrudao)

hana018:addSkill(thliuzhen)
hana018:addSkill(thliuzhen_buff)
hana018:addSkill(thtiandao)

yuki001:addSkill(thjianmo)
yuki001:addSkill(thjianmo_buff)
yuki001:addSkill(therchong)
yuki001:addSkill(thchundu)

yuki002:addSkill(thcuimeng)
yuki002:addSkill(thzuimeng)
yuki002:addSkill(thzuimengtr)
yuki002:addSkill(thmengwu)

yuki003:addSkill(thcihang)

yuki004:addSkill(thzhancao)

yuki005:addSkill(thyuanqi)
yuki005:addSkill(thmoji)

yuki008:addSkill(thchuiji)
yuki008:addSkill(thziyun)

yuki017:addSkill(thmingling)
yuki017:addSkill(thshuinan)

yuki018:addSkill(thlingdie)
yuki018:addSkill(thwushou)
yuki018:addSkill(thfuyue)

tsuki001:addSkill(thsuoming)
tsuki001:addSkill(thnongwu)
tsuki001:addSkill(thyewang)

tsuki003:addSkill(thkuangqi)

tsuki004:addSkill(thkaiyun)
tsuki004:addSkill(thjiaotu)

tsuki007:addSkill(thcunjing)
tsuki007:addSkill(thlianhua)

tsuki008:addSkill(thqishu)
tsuki008:addSkill(thshiting)
tsuki008:addSkill(thhuanzai)

tsuki011:addSkill(thgeyong)
tsuki011:addSkill(thmiqu)

tsuki012:addSkill(thzheshe)

tsuki014:addSkill(thexi)
tsuki014:addSkill(thxinglu)

tsuki016:addSkill(thshenyou)

tsuki017:addSkill(thguixu)
tsuki017:addSkill(thtianque)

kami002:addSkill(thjiguang)
kami002:addSkill(thjg_buff)

kami004:addSkill(thyexing)
kami004:addSkill(thyexingtr)
kami004:addSkill(thyexingdis)
kami004:addSkill(thqianyu)
kami004:addSkill(thhongwu)

kami009:addSkill(thyuxin)
kami009:addSkill(thchuangxin)
kami009:addSkill(thtianxin)

kami013:addSkill(thsanling)
kami013:addSkill(thbingzhang)
kami013:addSkill(thjiwu)
kami013:addSkill(thjiwutr)
kami013:addSkill(thsisui)
kami013:addSkill(thsisuirecord)
kami013:addSkill(thzhanying)
kami013:addSkill(thzhanyingskip)

sp002:addSkill(thnishang)
sp002:addSkill(thqimen)
sp002:addSkill(thguanjia)

bangai001:addSkill(thzusha)
bangai001:addSkill(thyaomei)
bangai001:addSkill(thzhongjie)

bangai002:addSkill(thbanyue)

bangai004:addSkill(thbianfang)

local skills=sgs.SkillList()
if not sgs.Sanguosha:getSkill("thshuinan_buff") then skills:append(thshuinan_buff) end
if not sgs.Sanguosha:getSkill("thtiandaovs") then skills:append(thtiandaovs) end
if not sgs.Sanguosha:getSkill("thyewangvs") then skills:append(thyewangvs) end
if not sgs.Sanguosha:getSkill("thchilv") then skills:append(thchilv) end
if not sgs.Sanguosha:getSkill("thkuangmo") then skills:append(thkuangmo) end
if not sgs.Sanguosha:getSkill("#thkuangmorec") then skills:append(thkuangmorec) end
if not sgs.Sanguosha:getSkill("thtanwu") then skills:append(thtanwu) end
if not sgs.Sanguosha:getSkill("#thtanwurec") then skills:append(thtanwurec) end
if not sgs.Sanguosha:getSkill("thquanshangive") then skills:append(thquanshangive) end
if not sgs.Sanguosha:getSkill("thfuyuevs") then skills:append(thfuyuevs) end
if not sgs.Sanguosha:getSkill("thjgtantian") then skills:append(thjgtantian) end
if not sgs.Sanguosha:getSkill("#thjgfengyu") then skills:append(thjgfengyu) end
sgs.Sanguosha:addSkills(skills)

sgs.LoadTranslationTable{
	["touhou"]="东方",
	
	["#kaze002"]="幻想风靡",
	["kaze002"]="射命丸文",
	["&kaze002"]="文文",
	["designer:kaze002"]="幻桜落 | Codeby:Slob",
	["illustrator:kaze002"]="水佾",
	["cv:kaze002"]="飞鸟",
	["~kaze002"]="糟糕...被追上了...",
	["thjilanwen"]="疾岚",
	[":thjilanwen"]="摸牌阶段，你可以放弃摸牌，改为进行一次判定，你获得此判定牌以及场上的一张与此判定牌花色不同的牌。",
	["$thjilanwen1"]="嘿！好素材，好素材~",
	["$thjilanwen2"]="今天的头条有着落啦~",
	
	["#kaze003"]="花果子念报记者",
	["kaze003"]="姬海棠羽立",
	["&kaze003"]="羽立",
	["designer:kaze003"]="神·冥狐 | Codeby:Slob",
	["illustrator:kaze003"]="nyanya",
	["cv:kaze003"]="暂无",
	["thnianxie"]="念写",
	[":thnianxie"]="出牌阶段，你可以交给一名其他角色一张【闪】，然后展示其一张手牌，若为【闪】，则你与该角色各摸一张牌。每阶段限一次。 ",
	["thnianxiecard"]="念写",
	["thjilan"]="极岚",
	[":thjilan"]="每当你受到1点伤害后，可令一名角色弃置X张牌（X为该角色已损失的体力值，且至少为1）。",
	
	["#kaze004"]="下位哨戒天狗",
	["kaze004"]="犬走椛",
	["&kaze004"]="椛椛",
	["designer:kaze004"]="幻桜落 | Codeby:Slob",
	["illustrator:kaze004"]="明星かがよ",
	["cv:kaze004"]="凉子",
	["~kaze004"]="一招不慎...满盘皆输...",
	["thwangshou"]="王手",
	[":thwangshou"]="每当你对其他角色造成一次伤害后，可令其进行一次判定，若结果为黑色，你可以弃置其一张牌。",
	["$thwangshou1"]="将军！",
	["$thwangshou2"]="这一手如何！？",
	["thhongye"]="红叶",
	[":thhongye"]="你的回合外，当其他角色的判定牌为红色且生效后，你可对其使用一张【杀】。",
	["@thhongye"]="请对该角色使用一张【杀】",
	["$thhongye1"]="红叶啊，化作疾风吧！",
	["$thhongye2"]="此处是妖怪山，尔等休想前进一步！",
	
	["#kaze005"]="运命之暗",
	["kaze005"]="键山雏",
	["&kaze005"]="转转",
	["designer:kaze005"]="零度雨 | Codeby:Slob",
	["illustrator:kaze005"]="DomotoLain",
	["cv:kaze005"]="暂无",
	["thenan"]="厄难",
	[":thenan"]="出牌阶段，你可以减少1点体力上限，然后令你攻击范围内的一名角色失去1点体力，每阶段限一次。",
	["thenancard"]="厄难",
	["thbeiyun"]="悲运",
	[":thbeiyun"]="当你处于濒死状态时，你可以亮出牌堆顶的X张牌（X为你的体力上限且最多为4），并选择一至两项：1.其中若有方片花色的牌，将所有红色牌置入弃牌堆，并回复1点体力。2.将所有黑色牌置入弃牌堆并增加1点体力上限。然后你可以获得其余的牌。",
	["thbeiyun1"]="扔红回复体力",
	["thbeiyun2"]="扔黑增加上限",
	["cancel"]="取消",
	["beiyunget"]="我要剩下的牌",
	["beiyundis"]="不要剩下的牌",
	
	["#kaze007"]="大江山岚",
	["kaze007"]="星熊勇仪",
	["&kaze007"]="勇仪",
	["designer:kaze007"]="幻桜落 | Codeby:Slob",
	["illustrator:kaze007"]="けん",
	["cv:kaze007"]="向晚",
	["~kaze007"]="哈哈哈...痛快！",
	["thbisha"]="必杀",
	[":thbisha"]="出牌阶段，你可将一张黑色非锦囊牌当【兵粮寸断】或方片牌当【乐不思蜀】置于你的判定区内，然后摸一张牌并选择一名其他角色。若如此做，视为你对其使用一张【杀】（此【杀】无视其防具且不计入每阶段的使用限制），并且无视与该角色的距离直到回合结束。每阶段限一次。",
	["thbishavs"]="必杀",
	["thbishacard"]="必杀",
	["$thbisha1"]="看我三步之内取你小命！",
	["$thbisha2"]="吃我一拳！",
	
	["#kaze008"]="山与湖的化身",
	["kaze008"]="八坂神奈子",
	["&kaze008"]="神妈",
	["designer:kaze008"]="妒天のPAD | Codeby:Slob",
	["illustrator:kaze008"]="Gekka",
	["cv:kaze008"]="暂无",
	["thshenzhou"]="神粥",
	[":thshenzhou"]="每当你受到一次伤害后，可从牌堆顶亮出X张牌（X为存活角色的数量，且最多为5），将一种类别的牌交给一名角色，然后将其余的牌置入弃牌堆。",
	["#thshenzhou"]="%from 选择了 %to , %to 将得到 %arg 张 %arg2",
	["thtianliu"]="天流",
	[":thtianliu"]="<b>锁定技</b>，摸牌阶段，你须放弃摸牌，改为进行一次判定，若结果为红桃，你摸三张牌；若结果为方片，你摸两张牌；若结果为草花，你摸一张牌。",
	["thqianyi"]="乾仪",
	[":thqianyi"]="你的回合外，每当你使用或打出一张【闪】时，可观看一名其他角色的手牌，将其中一张锦囊牌交给另一名角色。",
	["#thqianyi"]="%from 观看了 %to 的手牌",
	
	["#kaze009"]="土著神的顶点",
	["kaze009"]="洩矢诹访子",
	["&kaze009"]="青蛙子",
	["designer:kaze009"]="幻桜落 | Codeby:Slob",
	["illustrator:kaze009"]="An2A",
	["cv:kaze009"]="暂无",
	["thhuosui"]="祸祟",
	[":thhuosui"]="出牌阶段，你可以弃置一张手牌并指定你攻击范围内的一名其他角色，该角色需打出一张【闪】，否则你须选择一项：摸一张牌或对其使用一张【杀】（此【杀】不计入每阶段的使用限制），每阶段限一次。",
	["thhuosuicard"]="祸祟",
	["@thhuosuijink"]="请打出一张【闪】",
	["@thhuosui-slash"]="你可以对目标角色使用一张【杀】",
	["thtiandi"]="天滴",
	[":thtiandi"]="当其他角色使用【杀】指定你为目标时，你可以摸一张牌。",
	["thkunyi"]="坤仪",
	[":thkunyi"]="<b>限定技</b>，出牌阶段，你可以将你的武将牌翻面，并对你攻击范围内的一名角色造成1点伤害。",
	["thkunyivs"]="坤仪",
	["thkunyicard"]="坤仪",
	["@kunyi"]="坤仪(未发动)",
	["@kunyiused"]="坤仪(已发动)",
	
	["#kaze010"]="井户的恐妖",
	["kaze010"]="琪斯美",
	["&kaze010"]="桶娘",
	["designer:kaze010"]="小掉线仙 | Codeby:Slob",
	["illustrator:kaze010"]="黒鴉",
	["cv:kaze010"]="暂无",
	["thcannue"]="残虐",
	[":thcannue"]="出牌阶段，你可以将一张方片牌交给一名其他角色，该角色须选择一项：1. 对其攻击范围内的另一名由你指定的角色使用一张【杀】 2. 令你获得其一张牌或对其造成1点伤害。每阶段限一次。 ",
	["thcannuecard"]="残虐",
	["cnslash"]="使用一张【杀】",
	["cnother"]="由她发落",
	["cnget"]="获得其一张牌",
	["cnhit"]="对其造成一点伤害",
	["@thcannue-slash"]="请对目标使用一张【杀】",
	["thsibao"]="肆暴",
	[":thsibao"]="你可以将一张装备牌当【酒】使用。",
	["thsibaovs"]="肆暴",
	["@thsibao"]="你可以发动【肆暴】将一张装备牌当【酒】来自救。",
	
	["#kaze011"]="暗之窟的明之网",
	["kaze011"]="黑谷山女",
	["&kaze011"]="山女",
	["designer:kaze011"]="正体不明 | Codeby:Slob",
	["illustrator:kaze011"]="ふーかでぃあ",
	["cv:kaze011"]="暂无",
	["thwangmin"]="罔罠",
	[":thwangmin"]="出牌阶段，若你的武将牌上没有牌，你可以将一张手牌面朝下置于你的武将牌上称为“网”，然后令一名其他角色获得1枚“蛛丝”标记，每阶段限一次。其他角色的出牌阶段开始时，若其拥有“蛛丝”标记，须弃置之并展示一张手牌，然后你展示一张“网”，若这两张牌的点数之差大于X+2（X为你的体力值），则你可以选择以下一项：\
1. 弃置这张“网”，并对该角色造成1点伤害。\
2. 获得这张“网”，并弃置该角色一张牌。\
否则，该角色获得这张“网”，然后摸一张牌。",
	["@zhusi"]="蛛丝",
	["thwangminvs"]="罔罠",
	["thwangmincard"]="罔罠",
	["wangminpile"]="网",
	["wangmin1"]="弃置“网”对其造成1点伤害",
	["wangmin2"]="获得“网”弃置其一张牌",
	
	["#kaze012"]="绿眼的嫉妒",
	["kaze012"]="水桥帕露西",
	["&kaze012"]="帕露西",
	["designer:kaze012"]="幻桜落 | Codeby:Slob",
	["illustrator:kaze012"]="ラムディア",
	["cv:kaze012"]="暂无",
	["thgelong"]="葛笼",
	[":thgelong"]="出牌阶段，你可以与一名其他角色拼点。若你赢，你须选择一项：交给该角色一张手牌或者失去1点体力；若你没赢，你须选择一项：对该角色造成1点伤害或获得其一张牌。每阶段限一次。",
	["thgelongcard"]="葛笼",
	["glgive"]="给他一张手牌",
	["gllosehp"]="流失一点体力",
	["gldamage"]="对他造成一点伤害",
	["glget"]="获得他的一张牌",
	["thyuanzhou"]="怨咒",
	[":thyuanzhou"]="回合结束阶段开始时，若你的手牌数是全场最少的（或之一），你可以弃置场上手牌数最多的一名角色的区域的一张牌。",
	["#thyuanzhou"]="%from 将弃置 %to 的一张牌",
	
	["#kaze015"]="地狱的轮祸",
	["kaze015"]="火焰猫燐",
	["&kaze015"]="燐",
	["designer:kaze015"]="幻桜落 | Codeby:Ellis&Slob",
	["illustrator:kaze015"]="七乃瀨",
	["cv:kaze015"]="暂无",
	["thyanlun"]="焰轮",
	[":thyanlun"]="出牌阶段，你可以与一名其他角色拼点。若你赢，你获得以下技能直到回合结束：你可以将一张红色手牌当【火攻】使用；你使用【火攻】时可弃置与目标角色展示的手牌颜色相同的手牌；你每使用【火攻】造成一次伤害后，可以摸一张牌。若你没赢，则其对你造成1点火焰伤害。每阶段限一次。",
	["thyanlunvs"]="焰轮",
	["thyanluncard"]="焰轮",
	["@fire-attackex"]="%src 展示的牌的颜色为 %arg，请弃置相同颜色的牌",
	["black"]="黑色",
	["red"]="红色",
	
	["#kaze017"]="紧闭的恋之扉",
	["kaze017"]="古明地恋",
	["&kaze017"]="恋恋",
	["designer:kaze017"]="冬天吃雪糕 | Codeby:Ellis&Slob",
	["illustrator:kaze017"]="bon",
	["cv:kaze017"]="暂无",
	["thmaihuo"]="埋火",
	[":thmaihuo"]="出牌阶段，你可以将一张红桃牌交给一名其他角色并选择一种花色，然后展示该角色全部的手牌，其中每有一张该花色的牌，该角色摸一张牌（至多摸三张），每阶段限一次。",
	["thmaihuocard"]="埋火",
	["thwunian"]="无念",
	[":thwunian"]="<b>锁定技</b>，你即将造成的伤害视为没有来源的伤害，未受伤的角色使用的【杀】和非延时类锦囊牌对你无效。",
	
	["#hana003"]="三途川的引路人",
	["hana003"]="小野塚小町",
	["&hana003"]="小町",
	["designer:hana003"]="幻桜落 | Codeby:Slob",
	["illustrator:hana003"]="ideolo",
	["cv:hana003"]="暂无",
	["thbian"]="彼岸",
	[":thbian"]="当一名角色进入濒死状态时，你可以弃置两张手牌，则该角色失去1点体力。每回合限一次。",
	["thguihang"]="归航",
	[":thguihang"]="当一名有手牌的角色进入濒死状态时，你可以展示该角色的一张手牌，若该牌为红色，该角色须弃置这张牌并回复1点体力。",
	["@thguihang"]="请展示一张手牌",
	["thwujiancard"]="无间",
	["thwujianvs"]="无间",
	["thwujian"]="无间",
	[":thwujian"]="出牌阶段，你可以弃置一张牌并指定你攻击范围内的一名其他角色，直到你的下回合开始，当该角色计算与除其以外的角色的距离时，始终+1，每阶段限一次。",
	["@wujian"]="无间",
	
	["#hana006"]="佐渡的狸妖",
	["hana006"]="二岩猯藏",
	["&hana006"]="二岩",
	["designer:hana006"]="妒天のPAD | Codeby:Slob",
	["illustrator:hana006"]="八重樫 南",
	["cv:hana006"]="暂无",
	["thxihua"]="戏画",
	[":thxihua"]="出牌阶段，你可以选择一至四项： \
1. 弃置两张红桃牌并回复1点体力 \
2. 弃置两张草花牌并弃置一名其他角色的一张牌 \
3. 弃置两张方片牌并令一名其他角色摸两张牌，然后该角色须弃置一张牌 \
4. 弃置两张黑桃牌并令一名其他角色摸两张牌，然后该角色将其武将牌翻面。",
	["thxihuaspadecard"]="戏画",
	["thxihuaheartcard"]="戏画",
	["thxihuadiamondcard"]="戏画",
	["thxihuaclubcard"]="戏画",
	
	["#hana007"]="平安京的妖云",
	["hana007"]="封兽鵺",
	["&hana007"]="鵺娘",
	["designer:hana007"]="星野梦美&幻桜落 | Codeby:Ellis",
	["illustrator:hana007"]="伍長",
	["cv:hana007"]="凉子",
	["~hana007"]="这...这张弓是...？！",
	["thanyun"]="暗云",
	[":thanyun"]="摸牌阶段，你可以放弃摸牌，若如此做，此回合的回合结束阶段开始时，你摸两张牌。",
	["$thanyun1"]="今夜，你们的眼睛将欺骗你们的心灵~！",
	["$thanyun2"]="今夜，一切都将变得虚实难辨~！",
	["$thanyun3"]="演出结束~！",
	["thmimeng"]="迷蒙",
	[":thmimeng"]="你可将你最后一张手牌当除【无中生有】、【五谷丰登】、【顺手牵羊】、【桃园结义】和【万箭齐发】以外的基本牌或非延时类锦囊牌使用或者打出。",
	["thmimengvs"]="迷蒙",
	["thmimengcard"]="迷蒙",
	["thmimengpeachcard"]="迷蒙",
	["thmimengironchaincard"]="迷蒙",
	["@thmimeng"]="请使用最后一张手牌",
	["~thmimeng"]="点击手牌→点击确定",
	["@thmimengsave"]="请使用最后一张手牌",
	["~thmimengsave"]="点击“迷蒙”技能→点击手牌→点击确定",
	["$thmimeng1"]="哈哈哈...真遗憾...",
	["$thmimeng2"]="你·猜·错·了~！",
	
	["#hana008"]="独臂有角的仙人",
	["hana008"]="茨木华扇",
	["&hana008"]="华扇",
	["designer:hana008"]="jachsu | Codeby:Slob",
	["illustrator:hana008"]="米白",
	["cv:hana008"]="暂无",
	["thquanshan"]="劝善",
	[":thquanshan"]="出牌阶段，你可选择一名体力值不小于你且有手牌的其他角色，该角色须将至少一张手牌交给另一名除你以外的角色，每阶段限一次。",
	["thquanshancard"]="劝善",
	["thquanshangive"]="劝善",
	["thquanshangivecard"]="劝善",
	["@thquanshan"]="请将至少一张手牌交给除使用者外的其他角色",
	["~thquanshan"]="选择任意张手牌→选择一名除使用者外的其他角色→点击确定",
	["thxiangang"]="仙罡",
	[":thxiangang"]="每当你受到伤害时，可以进行一次判定，若结果为草花，防止此伤害。",
	["#thxiangang"]="%from 判定成功，防止此伤害",
	
	["#hana011"]="春告的妖精",
	["hana011"]="莉莉•白",
	["&hana011"]="莉莉",
	["designer:hana011"]="天妒のPAD | Codeby:Slob",
	["illustrator:hana011"]="sola7764",
	["cv:hana011"]="暂无",
	["thbaochun"]="报春",
	[":thbaochun"]="摸牌阶段，你可以放弃摸牌，改为将至多X张红色手牌交给一名其他角色，然后摸等量的牌（X为该角色已损失的体力值）。",
	["thbaochunvs"]="报春",
	["thbaochuncard"]="报春",
	["@thbaochun"]="请将红色手牌交给一名其他角色",
	["~thbaochun"]="选择若干张红色手牌→选择一名其他角色→点击确定",
	["thtanchun"]="探春",
	[":thtanchun"]="你的回合外，每当其他角色的方片牌因弃置而置入弃牌堆时，你可以摸一张牌。",
	
	["#hana013"]="忠实的死体",
	["hana013"]="宫古芳香",
	["&hana013"]="僵尸",
	["designer:hana013"]="幻桜落 | Codeby:Slob",
	["illustrator:hana013"]="KS",
	["cv:hana013"]="暂无",
	["thyinghua"]="硬化",
	[":thyinghua"]="你的回合外，每当你受到伤害时，你可以防止此伤害，然后获得等同于受到伤害数量的“坚韧”标记。",
	["thliaoyu"]="疗愈",
	[":thliaoyu"]="回合开始阶段开始时，若你拥有“坚韧”标记，你可弃置一张牌并选择X种花色（X为你拥有的“坚韧”标记的数量，且至多为4），然后进行一次判定，若结果为你所选的花色之一，你弃置1枚“坚韧”标记。你可重复此流程直到你没有“坚韧”标记为止。",
	["thhouzhi"]="后知",
	[":thhouzhi"]="<b>锁定技</b>，回合结束阶段开始时，你须弃置全部的“坚韧”标记，并失去等量的体力。",
	["@jianren"]="坚韧",
	
	["#hana016"]="阴阳圣童女",
	["hana016"]="物部布都",
	["&hana016"]="布都",
	["designer:hana016"]="幻桜落 | Codeby:Slob",
	["illustrator:hana016"]="ファルまろ",
	["cv:hana016"]="暂无",
	["thshijie"]="尸解",
	[":thshijie"]="当你处于濒死状态时，你每回复1点体力，可以从牌堆顶亮出一张牌置于你的武将牌上，称为“皿”。你可以将一张“皿”当【无懈可击】使用。",
	["thshijiecard"]="无懈可击",
	["shijiepile"]="皿",
	["thshengzhi"]="圣贽",
	[":thshengzhi"]="其他角色的回合开始时，你可以弃置一张黑色手牌或“皿”并选择一个阶段，然后令该角色跳过此回合的该阶段。若以此法跳过摸牌阶段，你失去1点体力；若以此法跳过出牌阶段，该角色回复1点体力。",
	["@thshengzhi"]="请弃置一张黑色手牌",
	["playy"]="出牌",
	
	["#hana017"]="圣德道士",
	["hana017"]="丰聪耳神子",
	["&hana017"]="神子",
	["designer:hana017"]="幻桜落 | Codeby:Slob",
	["illustrator:hana017"]="いちやん",
	["cv:hana017"]="凉子",
	["~hana017"]="该来的，还是躲不...过...",
	["thzhaoyu"]="诏谕",
	[":thzhaoyu"]="一名角色的回合开始阶段开始时，你可以将一张牌置于牌堆顶。",
	["thzhaoyuvs"]="诏谕",
	["thzhaoyucard"]="诏谕",
	["@thzhaoyu"]="请将一张牌置于牌堆顶",
	["~thzhaoyu"]="选择一张牌→点击确定",
	["$thzhaoyu1"]="奉天承运，天皇诏曰。",
	["$thzhaoyu2"]="还不速速领旨？",
	["thwuwu"]="无忤",
	[":thwuwu"]="<b>锁定技</b>，弃牌阶段结束时，若你在此阶段没有弃置手牌，你须弃置一张手牌。",
	["$thwuwu1"]="以和为贵，以和为贵呀。",
	["$thwuwu2"]="居庙堂者，以无忤为宗。",
	["thrudao"]="入道",
	[":thrudao"]="<b>觉醒技</b>，回合开始阶段开始时，若你没有手牌，你须摸两张牌，然后减少3点体力上限，并失去技能“无忤”。",
	["#thrudao"]="%from 没有手牌，触发了觉醒技【%arg】",
	["$thrudao"]="长生，亦我所愿也。",
	
	["#hana018"]="非想非非想之女",
	["hana018"]="比那名居天子",
	["&hana018"]="天子",
	["designer:hana018"]="晓ャ绝对 | Codeby:Slob",
	["illustrator:hana018"]="田中にゃん",
	["cv:hana018"]="暂无",
	["thliuzhen"]="六震",
	[":thliuzhen"]="出牌阶段，你使用【杀】指定目标后，可以选择任意名你攻击范围内的不为该【杀】目标的其他角色。该【杀】在结算后置入弃牌堆，你获得之并对你所选的角色使用，其中每有一名角色使用【闪】抵消了该【杀】的效果，你须弃置两张牌或失去1点体力。每阶段限一次。",
	["thliuzhenvs"]="六震",
	["thliuzhencard"]="六震",
	["thliuzhen_buff"]="六震",
	["@thliuzhen"]="你可以使用技能【六震】",
	["~thliuzhen"]="选择任意名不为该【杀】目标的其他角色→点击确定",
	["#thliuzhentr"]="%to 闪避了 %from 的【杀】，【%arg】的效果被触发",
	["thtiandao"]="天道",
	[":thtiandao"]="<b>主公技</b>，当你处于濒死状态时，其他花势力的角色可以将黑桃2~9的手牌当【桃】使用。",
	["thtiandaovs"]="天道",
	[":thtiandaovs"]="主公濒死时，若你是花势力角色，你可以将一张黑桃2~9的手牌当【桃】使用。",
	["@thtiandao"]="你可以发动【天道】将黑桃2~9的手牌当【桃】使用",
	["thtiandaocard"]="天道",
	
	["#yuki001"]="乐园的巫女",
	["yuki001"]="博丽灵梦",
	["&yuki001"]="灵梦",
	["designer:yuki001"]="幻桜落 | Codeby:Slob",
	["illustrator:yuki001"]="深崎暮人",
	["cv:yuki001"]="暂无",
	["thjianmo"]="缄魔",
	[":thjianmo"]="其他角色的出牌阶段开始时，若其手牌数不小于体力上限，你可以令其选择一项：摸一张牌，且此阶段不能使用或打出【杀】；或此阶段使用【杀】指定目标时须弃置一张牌，否则此【杀】无效。",
	["jmget"]="我不想出【杀】",
	["jmdis"]="我要出【杀】",
	["#thjianmochoose1"]="%from 选择了第 %arg 项，此阶段无法使用或打出【杀】",
	["#thjianmochoose2"]="%from 选择了第 %arg 项，此阶段使用【杀】时须弃一张牌",
	["#thjianmotr"]="受 %from 的技能【%arg】的效果影响，%to 需要额外弃一张牌，否则此【杀】无效",
	["therchong"]="二重",
	[":therchong"]="<b>觉醒技</b>，回合开始阶段开始时，若你的体力值不大于2，你须弃置两张牌，并减少1点体力上限，然后获得技能“幻法”和“祝祭”。",
	["#therchong"]="%from 的体力值为 %arg2 ，满足了【%arg】的觉醒条件",
	["thchundu"]="春度",
	[":thchundu"]="<b>主公技</b>，每当其他雪势力角色使用一张红桃基本牌时，可以令你观看牌堆顶的一张牌，然后你须将此牌交给一名其他角色或置入弃牌堆。",
	["cdgive"]="给别人",
	["cddis"]="扔掉",
	
	["#yuki002"]="疏雨的百鬼夜行",
	["yuki002"]="伊吹萃香",
	["&yuki002"]="西瓜",
	["designer:yuki002"]="幻桜落 | Codeby:Slob",
	["illustrator:yuki002"]="正体不明",
	["cv:yuki002"]="暂无",
	["thcuimeng"]="萃梦",
	[":thcuimeng"]="回合开始阶段开始时，你可以进行一次判定，若结果为红色，你获得此牌，你可以重复此流程，直到出现黑色的判定结果为止。",
	["thzuimeng"]="醉梦",
	[":thzuimeng"]="<b>锁定技</b>，你的红桃的基本牌均视为【酒】。当你使用一张【酒】时，你摸一张牌。",
	["thmengwu"]="濛雾",
	[":thmengwu"]="<b>锁定技</b>，若你已受伤，你的手牌上限+1。",
	
	["#yuki003"]="半分幻的庭师",
	["yuki003"]="魂魄妖梦",
	["&yuki003"]="妖梦",
	["designer:yuki003"]="Why. | Codeby:Slob",
	["illustrator:yuki003"]="さくやついたち",
	["cv:yuki003"]="向晚",
	["~yuki003"]="幽幽子大人...！",
	["thcihang"]="慈航",
	[":thcihang"]="当你使用的【杀】被目标角色的【闪】抵消时，你可令此【杀】依然造成伤害，若如此做，你须选择一项：弃置等同于目标角色已损失的体力值数量的牌（不足则全弃）；或令目标角色摸等同于其体力值数量的牌（至多摸五张）。",	
	["chdis"]="自己弃牌",
	["chdra"]="对方摸牌",
	["$thcihang1"]="断迷剑，迷津慈航斩！",
	["$thcihang2"]="皆斩！",
	
	["#yuki004"]="七色的人形使",
	["yuki004"]="爱丽丝•玛嘉特洛伊德",
	["&yuki004"]="小爱",
	["designer:yuki004"]="CoffeeNO加糖 | Codeby:Slob",
	["illustrator:yuki004"]="しろさ",
	["cv:yuki004"]="暂无",
	["thzhancao"]="战操",
	[":thzhancao"]="你的回合外，当你攻击范围内的一名角色成为【杀】的目标时，你可选择一项使该【杀】对目标角色无效：失去1点体力且该【杀】在结算后置入弃牌堆时，你获得之；或弃置你装备区内的一张防具牌或坐骑牌。",
	["@thzhancao"]="请弃置你装备区内的一张防具牌或坐骑牌。",
	["#thzhancao"]="%from 的技能【%arg】的后续效果被触发",
	
	["#yuki005"]="幻想乡的记忆",
	["yuki005"]="稗田阿求",
	["&yuki005"]="阿求",
	["designer:yuki005"]="弱弱的diyer | Codeby:Slob",
	["illustrator:yuki005"]="Dinyc",
	["cv:yuki005"]="暂无",
	["thyuanqi"]="缘起",
	[":thyuanqi"]="出牌阶段，你可以进行一次判定，然后将一张与该判定牌颜色相同的手牌交给一名其他角色，该角色须选择一项：1.摸一张牌，然后失去1点体力 2.弃置这张牌，并令你获得其一张牌。每阶段限一次。",	
	["thyuanqicard"]="缘起",
	["#thyuanqi"]="%from 将 %card 交给了 %to",
	["yqdra"]="摸一张牌，然后失去1点体力",
	["yqdis"]="弃置这张牌，让他拿一张牌",
	["thmoji"]="墨迹",
	[":thmoji"]="若你的装备区没有防具牌，每当你需要使用一张【闪】响应一名角色对你使用的【杀】时，你可以进行一次判定：若结果与该【杀】的颜色相同，则视为你使用了一张【闪】。",
	
	["#yuki008"]="法界之火",
	["yuki008"]="圣白莲",
	["&yuki008"]="白莲",
	["designer:yuki008"]="冬天吃雪糕 | Codeby:Slob",
	["illustrator:yuki008"]="ideolo",
	["cv:yuki008"]="暂无",
	["thchuiji"]="垂迹",
	[":thchuiji"]="你的回合外，每当失去牌时，若你的手牌数不大于你的体力上限，可指定一名角色并令其进行一次判定，若为红色，该角色回复1点体力。",	
	["thziyun"]="紫云",
	[":thziyun"]="<b>锁定技</b>，你不能成为【兵粮寸断】的目标。",
	
	["#yuki017"]="惨憺的大海原",
	["yuki017"]="村纱水蜜",
	["&yuki017"]="船长",
	["designer:yuki017"]="幻桜落 | Codeby:Slob",
	["illustrator:yuki017"]="ひそな",
	["cv:yuki017"]="暂无",
	["thmingling"]="溟灵",
	[":thmingling"]="<b>锁定技</b>，防止你受到的火焰伤害，你每次受到的雷电伤害+1。",
	["thshuinan"]="水难",
	[":thshuinan"]="出牌阶段，你可以失去1点体力并令你攻击范围内的一名其他角色获得1枚“溺水”标记，每阶段限一次。其他角色每拥有1枚“溺水”标记，其手牌上限-1。其他角色的回合结束阶段开始时，若其拥有1枚或更多的“溺水”标记，须进行一次判定，若为红色，弃置全部的“溺水”标记；若为黑色，获得1枚“溺水”标记。",
	["thshuinanvs"]="水难",
	["thshuinancard"]="水难",
	["@nishui"]="溺水",
	["#thshuinan"]="%from 拥有的 %arg 标记的效果被触发",
	
	["#yuki018"]="天衣无缝的亡灵",
	["yuki018"]="西行寺幽幽子",
	["&yuki018"]="幽幽子",
	["designer:yuki018"]="零度雨 | Codeby:Slob",
	["illustrator:yuki018"]="ukyo_rst",
	["cv:yuki018"]="暂无",
	["thlingdie"]="灵蝶",
	[":thlingdie"]="出牌阶段，你可以弃置一张牌并选择一名角色，该角色可观看另一名角色的手牌，每阶段限一次。",
	["thlingdiecard"]="灵蝶",
	["#thlingdie"]="%from 观看了 %to 的手牌",
	["thwushou"]="无寿",
	[":thwushou"]="每当你受到伤害时，你可以将你的手牌补至四张。",
	["thfuyue"]="浮月",
	[":thfuyue"]="<b>主公技</b>，其他雪势力角色的出牌阶段，若你已受伤，可与你拼点，若该角色没有赢，你回复1点体力，每阶段限一次。",
	["thfuyuevs"]="浮月拼点",
	[":thfuyuevs"]="若主公已受伤且你是雪势力角色，你可在出牌阶段与主公拼点，若你没赢，主公回复1点体力，每阶段限一次。",
	["thfuyuecard"]="浮月",
	
	["#tsuki001"]="永远的赤色幼月",
	["tsuki001"]="蕾米莉亚•斯卡雷特",
	["&tsuki001"]="蕾米",
	["designer:tsuki001"]="幻桜落 | Codeby:Slob",
	["illustrator:tsuki001"]="ideolo",
	["cv:tsuki001"]="暂无",
	["thsuoming"]="锁命",
	[":thsuoming"]="每当你受到1点伤害后，你可以指定一名角色，横置或重置其武将牌。",
	["thnongwu"]="浓雾",
	[":thnongwu"]="<b>锁定技</b>，当你的武将牌横置时，普通【杀】对你无效。",
	["#thnongwu"]="%from 触发【%arg】，%to 对其使用的 %arg2 无效",
	["thyewang"]="夜王",
	[":thyewang"]="<b>主公技</b>，若场上没有角色的武将牌横置，其他月势力角色可以在各自的出牌阶段将你的武将牌横置，每阶段限一次。",
	["thyewangvs"]="夜王横置",
	[":thyewangvs"]="若场上没有角色的武将牌横置且你是月势力角色，你可以在出牌阶段将主公的武将牌横置，每阶段限一次。",
	["#thyewang"]="%from %arg 了 %to 的武将牌",
	["#thyewangfail"]="%from 使用失败，因为场上存在横置的武将牌",
	["thyewangcard"]="夜王",
	
	["#tsuki003"]="晴岚的赤瞳",
	["tsuki003"]="铃仙•优昙华院•稻叶",
	["&tsuki003"]="铃仙",
	["designer:tsuki003"]="幻桜落 | Codeby:Slob",
	["illustrator:tsuki003"]="正体不明",
	["cv:tsuki003"]="暂无",
	["thkuangqi"]="狂气",
	[":thkuangqi"]="出牌阶段，当你使用【杀】或【决斗】对目标角色造成伤害时，你可以弃置一张【桃】、【酒】或防具牌，则此伤害+1。",
	["@thkuangqi"]="请弃置一张【桃】、【酒】或防具牌",
	["#thkuangqi"]="受 %from 的技能【狂气】影响，%to 受到的伤害由 %arg 上升到了 %arg2 。",
	
	["#tsuki004"]="幸运的白兔",
	["tsuki004"]="因幡帝",
	["&tsuki004"]="帝",
	["designer:tsuki004"]="幻桜落 | Codeby:Slob",
	["illustrator:tsuki004"]="すばち",
	["cv:tsuki004"]="暂无",
	["thkaiyun"]="开运",
	[":thkaiyun"]="在一名角色的判定牌生效前，你可以弃置一张牌，然后观看牌堆顶的两张牌，将其中一张牌代替判定牌，然后获得另一张牌。",
	["thjiaotu"]="狡兔",
	[":thjiaotu"]="每当你受到1点伤害后，可以令伤害来源进行一次判定，若结果不为红桃，该角色获得技能“无谋”直到该角色的下一个回合结束。",
	["@jiaotu"]="狡兔",
	
	["#tsuki007"]="虹色的门番",
	["tsuki007"]="红美铃",
	["&tsuki007"]="中国",
	["designer:tsuki007"]="零度雨 | Codeby:Slob",
	["illustrator:tsuki007"]="miya9",
	["cv:tsuki007"]="暂无",
	["thcunjing"]="寸劲",
	[":thcunjing"]="若你的装备区没有武器牌，当你使用的【杀】被【闪】抵消时，你可以弃置一张牌，则此【杀】依然造成伤害。",
	["thlianhua"]="莲华",
	[":thlianhua"]="出牌阶段，你可弃置一张装备牌，然后观看牌堆顶的一张牌并将其交给一名角色。",
	["thlianhuacard"]="莲华",
	
	["#tsuki008"]="完美潇洒的从者",
	["tsuki008"]="十六夜咲夜",
	["&tsuki008"]="咲夜",
	["~tsuki008"]="真是...精彩...",
	["designer:tsuki008"]="scorpio | Codeby:Slob",
	["illustrator:tsuki008"]="雨神",
	["cv:tsuki008"]="向晚",
	["thqishu"]="奇术",
	[":thqishu"]="其他角色的回合结束后，若你的武将牌背面朝上，你可将你的武将牌翻面并获得1枚“时计”标记，然后进行一个额外的回合。",
	["$thqishu1"]="我说到哪了？",
	["$thqishu2"]="您摇铃了吗，客人？",
	["thshiting"]="时停",
	[":thshiting"]="回合开始阶段开始时，若你没有“时计”标记，你可以将你的武将牌翻面并将你的手牌补至等同于你体力上限的张数，然后跳过你此回合的判定阶段、摸牌阶段、出牌阶段和弃牌阶段。",
	["$thshiting1"]="恩？不速之客？",
	["$thshiting2"]="那么...游戏开始！",
	["thhuanzai"]="幻在",
	[":thhuanzai"]="<b>锁定技</b>，回合结束阶段开始时，你须弃置全部“时计”标记。",
	["$thhuanzai1"]="时间...时间总是不够...",
	["$thhuanzai2"]="就这样吧...",
	["@shiji"]="时计",
	
	["#tsuki011"]="惑心的夜雀",
	["tsuki011"]="米斯蒂亚•萝蕾莱",
	["&tsuki011"]="夜雀",
	["designer:tsuki011"]="殇の腥 | Codeby:Slob",
	["illustrator:tsuki011"]="水佾",
	["cv:tsuki011"]="暂无",
	["thgeyong"]="歌咏",
	[":thgeyong"]="每当你的体力值发生变化时，你可以进行一次判定，若不为红桃，你摸一张牌。",
	["thmiqu"]="秘曲",
	[":thmiqu"]="出牌阶段，若你的手牌数不小于你的体力值，你可展示全部手牌：若均为不同花色，你令一名角色失去1点体力；若均为相同花色，你获得一名其他角色的一张牌。每阶段限一次。",
	["thmiqucard"]="秘曲",
	
	["#tsuki012"]="耀目的日光",
	["tsuki012"]="桑妮•米尔克",
	["&tsuki012"]="桑妮",
	["designer:tsuki012"]="幻桜落 | Codeby:Slob",
	["illustrator:tsuki012"]="kinakomoti",
	["cv:tsuki012"]="暂无",
	["thzheshe"]="折射",
	[":thzheshe"]="每当你受到一次伤害后，你可以弃置一张手牌并选择一名角色，该角色需打出一张【闪】，否则受到你对其造成的1点伤害。",
	["@thzheshe"]="请弃置一张手牌",
	["@thzheshejink"]="请打出一张【闪】",
	
	["#tsuki014"]="灿烂的星光",
	["tsuki014"]="斯塔•莎菲雅",
	["&tsuki014"]="斯塔",
	["designer:tsuki014"]="jachsu&幻桜落 | Codeby:Slob",
	["illustrator:tsuki014"]="kinakomoti",
	["cv:tsuki014"]="暂无",
	["thexi"]="恶戏",
	[":thexi"]="回合结束阶段开始时，你可以弃置一张手牌并选择两名角色，这两名角色须同时展示一张手牌，若这两张牌点数不同，你获得其中一张牌，所展示的牌点数大的角色获得另一张牌；若点数相同，你在此回合结束后须进行一个额外的回合（此额外的回合内你不可以发动“恶戏”）。",
	["thexivs"]="恶戏",
	["thexicard"]="恶戏",
	["exbig"]="我要大的那张",
	["exsma"]="我要小的那张",
	["@thexi"]="是否发动技能【恶戏】",
	["~thexi"]="选择一张手牌→选择两名角色→点击确定",
	["thxinglu"]="星露",
	[":thxinglu"]="当你进入濒死状态时，你可以与一名其他角色拼点：若你赢，你回复1点体力。",
	
	["#tsuki016"]="神灵依凭的月姬",
	["tsuki016"]="绵月依姬",
	["&tsuki016"]="依姬",
	["designer:tsuki016"]="妒天のPAD | Codeby:Slob",
	["illustrator:tsuki016"]="ideolo",
	["cv:tsuki016"]="暂无",
	["thshenyou"]="神佑",
	[":thshenyou"]="摸牌阶段，你可以放弃摸牌，改为获得一名其他角色区域内的一张牌，然后你可以对其使用一张【杀】，此【杀】对目标角色造成的伤害视为失去体力。",
	["@thshenyou"]="你可以对该角色使用一张【杀】",
	
	["#tsuki017"]="海与山的境界",
	["tsuki017"]="绵月丰姬",
	["&tsuki017"]="丰姬",
	["designer:tsuki017"]="妒天のPAD | Codeby:Slob",
	["illustrator:tsuki017"]="PFALZ",
	["cv:tsuki017"]="暂无",
	["thguixu"]="归墟",
	[":thguixu"]="你的回合外，当其他角色使用一张除【无懈可击】外的锦囊牌时，你可以进行一次判定，若为红色，抵消该锦囊牌产生的效果，并将其置于你的武将牌上称为“海”。若“海”的数量大于1，你不能以此法进行判定。",
	["thguixupile"]="海",
	["thtianque"]="天阙",
	[":thtianque"]="出牌阶段，你可以弃置一张手牌，并获得一张与该牌花色相同的“海”。",
	["thtianquecard"]="天阙",
	["@thtianque"]="请弃置一张同花色的手牌",
	
	["#tsuki018"]="永远与须臾的罪人",
	["tsuki018"]="蓬莱山辉夜",
	["&tsuki018"]="辉夜",
	["designer:tsuki018"]="幻桜落 | Codeby:Slob",
	["illustrator:tsuki018"]="Emiaエミア",
	["cv:tsuki018"]="暂无",
	
	["#kami002"]="天道是非",
	["kami002"]="比那名居天子",
	["&kami002"]="神天子",
	["designer:kami002"]="幻桜落 | Codeby:Slob",
	["illustrator:kami002"]="ななしな",
	["cv:kami002"]="暂无",
	["thjiguang"]="极光", 
	[":thjiguang"]="回合开始阶段开始时，你可选择一项“气象”，效果持续到你的下回合开始。你不能选择你上回合所选择的“气象”。\
“风雨”：所有角色计算与其他角色的距离时，始终-1。\
“浓雾”：所有角色每使用【杀】对与其距离1以内的角色造成一次伤害后，回复1点体力。\
“烈日”：所有角色每次受到的火焰伤害+1。\
“黄砂”：所有角色每次受到多于1点的伤害时，防止多余的伤害。\
“昙天”：所有角色可将红桃花色的【闪】当【桃】使用。",
	["thjgtantian"]="极光(昙天)", 
	[":thjgtantian"]="你可将红桃花色的【闪】当【桃】使用。", 
	["@jgfengyu"]="风雨",
	["@jgnongwu"]="浓雾",
	["@jglieri"]="烈日",
	["@jghuangsha"]="黄砂",
	["@jgtantian"]="昙天",
	["jgfengyu"]="风雨",
	["jgnongwu"]="浓雾",
	["jglieri"]="烈日",
	["jghuangsha"]="黄砂",
	["jgtantian"]="昙天",
	
	["#kami004"]="子夜的女皇",
	["kami004"]="蕾米莉亚•斯卡雷特",
	["&kami004"]="神蕾米",
	["designer:kami004"]="昂翼天使 | Codeby:Slob",
	["illustrator:kami004"]="墨洲",
	["cv:kami004"]="暂无",
	["thyexing"]="夜行", 
	[":thyexing"]="<b>锁定技</b>，回合开始阶段开始时，你须弃置全部的“月夜”标记并亮出牌堆顶的一张牌，若不为方片，你获得1枚“月夜”标记，然后将该牌置入弃牌堆。若你没有“月夜”标记，你的牌对其他角色无效；否则当你计算与其他角色的距离时，始终-1。",
	["@yueye"]="月夜",
	["thqianyu"]="千狱", 
	[":thqianyu"]="<b>觉醒技</b>，回合开始阶段开始时，若你已受伤，你须减少1点体力上限并获得技能“虎咆”。",
	["#thqianyu"]="%from 已受伤，触发了觉醒技【%arg】", 
	["thhongwu"]="红雾",
	[":thhongwu"]="<b>觉醒技</b>，每当你扣减1点体力时，若你的体力值为0，你须减少1点体力上限并获得技能“终曲”、“赤律”（出牌阶段，你可以用一张手牌替换你武将牌上的一张牌。）和“昙雾”（<b>锁定技，</b>每当你回复1点体力时，你进行一次判定，若为红色，你获得此判定牌。你武将牌上每有一张牌，你的手牌上限便+1。）。",
	["#thhongwu"]="%from 体力减为0，触发了觉醒技【%arg】", 
	["thchilv"]="赤律",
	[":thchilv"]="出牌阶段，你可以将一张手牌替换武将牌上的一张牌。",
	["#thchilv"]="%from 的武将牌上的牌中出现了重复点数，%from 将进入濒死状态",
	["thchilvcard"]="赤律",
	["thtanwu"]="昙雾",
	[":thtanwu"]="<b>锁定技，</b>每当你回复1点体力时，你进行一次判定，若为红色，你获得此判定牌。你武将牌上每有一张牌，你的手牌上限便+1。",
	["thkuangmo"]="狂魔",
	[":thkuangmo"]="<b>锁定技</b>，你的【桃】均视为【杀】。每当你使用红色的【杀】对目标角色造成1点伤害后，你回复1点体力。",
	
	["#kami009"]="心华之殇",
	["kami009"]="古明地觉",
	["&kami009"]="神小五",
	["designer:kami009"]="幻桜落 | Codeby:Slob",
	["illustrator:kami009"]="サクラメ ( 厄年 )",
	["cv:kami009"]="暂无",
	["thyuxin"]="愈心", 
	[":thyuxin"]="摸牌阶段，你可弃置一张牌，并放弃摸牌，改为从牌堆顶亮出两张牌并获得之，若这两张牌均为红桃，你可以指定一名已受伤的角色并令其回复1点体力。",
	["thchuangxin"]="创心", 
	[":thchuangxin"]="出牌阶段开始时，你可弃置X张牌，然后选择X项：1. 获得技能“攻心”，直到回合结束 2. 获得技能“捞月”，直到回合结束。",
	["thchuangxinvs"]="创心", 
	["thchuangxincard"]="创心", 
	["@thchuangxin"]="请弃置至多2张牌",
	["~thchuangxin"]="选择1~2张牌→点击确定",
	["thtianxin"]="天心", 
	[":thtianxin"]="你的回合开始时，你可弃置X张牌，然后选择X项：1. 获得技能“预悉”，直到回合结束 2. 获得技能“天妒”，直到回合结束。",
	["thtianxinvs"]="天心", 
	["thtianxincard"]="天心", 
	["@thtianxin"]="请弃置至多2张牌",
	["~thtianxin"]="选择1~2张牌→点击确定",
	
	["#kami013"]="鸣蛙不输风雨",
	["kami013"]="洩矢诹访子",
	["&kami013"]="神青蛙子",
	["designer:kami013"]="幻桜落 | Codeby:Slob",
	["illustrator:kami013"]="正体不明",
	["cv:kami013"]="暂无",
	["thsanling"]="散灵", 
	[":thsanling"]="<b>锁定技</b>，一名角色的回合结束后，若你没有手牌，你立即死亡。",
	["thbingzhang"]="冰障",
	[":thbingzhang"]="每当你受到伤害时，你可以弃置两张牌，然后防止此伤害。",
	["thjiwu"]="极武", 
	[":thjiwu"]="<b>锁定技</b>，你的【桃】和【酒】均视为【闪】。弃牌阶段外，每当你的【闪】置入弃牌堆；或每当其他角色获得一次你的手牌时，你摸一张牌。",
	["thsisui"]="祀祟",
	[":thsisui"]="回合开始阶段开始时，你可以令所有其他角色弃置一张手牌，然后你可以从弃牌堆获得剩余牌中的至多三张牌并交分别交给任意角色。",
	["thzhanying"]="湛樱",
	[":thzhanying"]="<b>锁定技</b>，你始终跳过你的摸牌阶段；你的手牌上限+4。",
	
	["#sp002"]="穿壁的邪仙娘娘",
	["sp002"]="SP霍青娥",
	["&sp002"]="霍青娥",
	["designer:sp002"]="幻桜落 | Codeby:Slob",
	["illustrator:sp002"]="米白",
	["cv:sp002"]="暂无",
	["thnishang"]="霓裳", 
	[":thnishang"]="回合开始阶段开始时，你可以将一名其他角色的武将牌横置或者重置。",
	["#thnishang"]="%from 选择了 %to ，%arg 了 %to 的武将牌",
	["hengzhi"]="横置",
	["chongzhi"]="重置",
	["thqimen"]="奇门", 
	[":thqimen"]="<b>锁定技</b>，当你计算与武将牌横置的角色的距离、武将牌横置的角色计算与你的距离时，无视你们之外的其他角色。",
	["thguanjia"]="贯甲",
	[":thguanjia"]="<b>锁定技</b>，你无视其他角色装备区的防具牌。",
	
	["#bangai001"]="魔女的使役魔",
	["bangai001"]="小恶魔",
	["&bangai001"]="小恶魔",
	["designer:bangai001"]="幻桜落 | Codeby:Slob",
	["illustrator:bangai001"]="yamasan",
	["cv:bangai001"]="暂无",
	["thzusha"]="诅杀", 
	[":thzusha"]="出牌阶段，你可以弃置一张黑桃手牌并令一名其他角色获得1枚“诅咒”标记，每阶段限一次。其他角色的判定阶段开始时，若其拥有1枚或更多的“诅咒”标记，须进行一次判定，若为黑色，其失去1点体力；判定阶段结束时，该角色须进行一次判定，若为红色，弃置1枚“诅咒”标记。",
	["thzushavs"]="诅杀", 
	["thzushacard"]="诅杀", 
	["@zuzhou"]="诅咒", 
	["#thzusha"]="%from 拥有的 %arg 标记的效果被触发",
	["thyaomei"]="妖魅", 
	[":thyaomei"]="<b>限定技</b>，出牌阶段，你可以弃置一张红色手牌并选择两名已受伤的角色，已损失的体力值较小的角色失去1点体力（若相同，则由你选择一名角色），然后另一名角色回复1点体力。",
	["thyaomeivs"]="妖魅", 
	["thyaomeicard"]="妖魅", 
	["@yaomei"]="妖魅(未发动)",
	["@yaomeiused"]="妖魅(已发动)",
	["thzhongjie"]="忠节", 
	[":thzhongjie"]="<b>锁定技</b>，若你的装备区里没有防具牌，一名角色的回合内，你受到该角色对你造成的伤害时，若该伤害多于1点，则防止多余的伤害。",
	
	["#bangai002"]="大自然的具现",
	["bangai002"]="大妖精",
	["&bangai002"]="大妖精",
	["designer:bangai002"]="幻桜落 | Codeby:Slob",
	["illustrator:bangai002"]="蓮芽しい",
	["cv:bangai002"]="暂无",
	["thbanyue"]="半月", 
	[":thbanyue"]="当你使用【杀】时，可以进行一次判定，若结果为黑色，为该【杀】额外指定一个目标；若为红色，弃置目标角色一张牌。",
	
	["#bangai004"]="大空之弦",
	["bangai004"]="宇佐见莲子",
	["&bangai004"]="莲子",
	["designer:bangai004"]="幻桜落 | Codeby:Slob",
	["illustrator:bangai004"]="安威拓郎",
	["cv:bangai004"]="暂无",
	["thbianfang"]="辨方", 
	[":thbianfang"]="每当你使用【杀】对目标角色造成一次伤害后或受到一次伤害后，若你已受伤，你可以选择X种花色并进行一次判定，若结果为你所选花色之一，你弃置一名其他角色一张牌或回复1点体力（X为你已损失的体力值且至多为3）。",
	["bfdis"]="弃置其他角色一张牌",
	["bfrec"]="回复1点体力",
	
}